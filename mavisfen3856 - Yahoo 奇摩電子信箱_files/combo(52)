"use strict";YUI.add("messenger-conversationview",function(a){function b(a){var b,c="sms"===a?"yahoo":a||"yahoo",d=[],e=i.emoticonPickerEntries[c];if(o[c])return o[c];for(b in e)e.hasOwnProperty(b)&&d.push({emotekey:b,emoteSmiley:e[b],emoteLabel:h["str_msgr_em_"+i.emoticonLabels[b]]});return o[c]=d,d}var c,d,e=a.Tictac.mim.rollups,f=a.Messenger.Common.Utils,g=a.Messenger.View.ViewUtils,h=a.Tictac.mim.strings,i=a.Messenger.YMLUtil,j=a.Messenger.Common.Constants,k=a.Messenger.Model.UserSettings,l=a.Messenger.Common.SMSUtils,m=a.Messenger.Common.Stats,n=j.EVENTS,o={},p=40,q=90,r=4e3;c=a.Tictac.base.View.extend({initialize:function(){var b=this;d=a.Messenger.Model.SystemSettings.get("isRTL"),b.set("unreadCount",0),b.model.on(n.ACK_RECEIVED,function(){b.set("unreadCount",0),g.flashWindow(!1)}),b.model.on(n.SEND_ERROR,function(a){b._showSendErrorILN(a&&a.errorCode)}),b.on("show",b._onShow,b),b._rteListeners=[]},onDestroy:function(){var a=this;if(a._setTypingState(!1),a.RTE){for(;a._rteListeners.length;)a._rteListeners.pop().detach();try{a.RTE.destroy()}catch(b){}}a.messageListNode.destroy(),a.messageAreaNode.destroy(),a.contact.off("change:presenceState change:presenceMessage",a._handlePresenceChange,this),a.contact.off("change:displayName",a._handleDisplayNameChange,this),a.model.off(n.ACK_RECEIVED),g.flashWindow(!1)},createDOMNode:function(){var c=this.model.get("user"),i=this.model.get("network"),j=a.Messenger.Model.ContactList.getInstance(),k=j.getContact(c,i),l=k.get("displayName");return this.contact=k,a.Node.create(e.conversation({displayName:l,image:k.get("image"),mobileno:k.get("mobileno")||"",presenceMessage:k.get("presenceMessage")||g.getDefaultPresenceMessage(k.get("presenceState")),presenceClassName:g.getBuddyIconClass(k.get("presenceState")),emoticons:b(i),typingMessage:f.substitute(h.str_conv_typing,{conversation_user:l}),isRTL:d}))},_updateBuddyIcon:function(){var a,b,c=this;(a=c.node.one(".mim-user-photo"))&&(b=c.contact.get("image"))&&a.set("src",b)},postRender:function(){var b,c,d=this.model.get("messages"),e=this;for(e.contact.on("change:image",a.bind(e._updateBuddyIcon,this)),e.messageListNode=e.node.one("ul.mim-message-list"),e.messageAreaNode=e.node.one(".mim-message-area"),e._formatPane=e.node.one(".mim-format-pane"),e._emoticonsPane=e.node.one(".mim-emoticons-pane"),e.on("change:mode",e._handleModeChange,this),this.set("mode",this.options.mode||"im"),b=0,c=d.length;c>b;b++)e.renderMessage(d[b]);e._handleModelDestroyEvents(),e.contact.get("ignored")?this._showUnblockUserILN():"sms"!==e.contact.get("network")&&"unknown"===e.contact.get("type")&&e._showUnknownUserILN(),e.contact.on("change:presenceState change:presenceMessage",e._handlePresenceChange,this),e.contact.on("change:displayName",e._handleDisplayNameChange,this),k.getPreference("mimEnableSSA",function(a){a&&(e.renderNotification({message:h.str_conv_btn_show_recent_conv,type:j.NOTIFICATION_SECTION_TOP,className:"mim-show-recent"}),k.getPreference("mimSSANotificationSeen")||e._showSSANotification())})},_onShow:function(){this.RTE||this._renderRTE();var a=this.get("unreadCount");a>0&&(g.flashWindow(!1),this.model.ack(),this.set("unreadCount",0)),this.model.get("ignored")&&this._showUnblockUserILN(),this._forceScrollPane(),this._updateLayout(),this.focus()},_updateLayout:function(){if(this.visible){var b=this.node.one(".mim-message-area"),c=this.node.one(".mim-notification-area");c.get("children").size()?0===c.get("offsetHeight")?a.later(0,this,function(){b.setStyle("top",c.get("offsetHeight"))}):b.setStyle("top",c.get("offsetHeight")):b.setStyle("top",0)}},_handleModeChange:function(){var a=this,b=a.get("mode");a.previous("mode")!==b&&"im"===b&&(a.RTE&&(a.RTE.enableFormatting(),a.RTE.focus()),a.renderModeILN(b))},_handlePresenceChange:function(a){var b=this.node.one(".mim-user-opi > b"),c=this.node.one(".mim-user-opi .mim-user-statusmsg"),d=a.get("presenceMessage")||g.getDefaultPresenceMessage(a.get("presenceState"));a.get("presenceState")!==a.previous("presenceState")&&b.removeClass(g.getBuddyIconClass(a.previous("presenceState"))).addClass(g.getBuddyIconClass(a.get("presenceState"))),c.setHTML(d)},_handleDisplayNameChange:function(a){var b=a.get("displayName");this.node.one(".mim-user-opi b").setHTML(b),this.node.one(".mim-user-photo").setAttribute("title",b),this.messageListNode.all(".mim-message-other .mim-message-sender").setHTML(b),this.node.one(".mim-typing-notification").setHTML(f.substitute(h.str_conv_typing,{conversation_user:b})),this.trigger(n.DISPLAYNAME_UPDATED,this.model.get("id"),b)},_renderRTE:function(){var b,c,e=this,f=k.getPreference("mimDefaultFontSize"),g=k.getPreference("mimDefaultFontColor"),h=k.getPreference("mimDefaultFontFamily");c=a.UA.ie?"body {padding: 5px;overflow-y: hidden;box-sizing: border-box;}":"body {padding: 5px;overflow-y: hidden;}",b={toolbarContainer:this.node.one(".mim-format-pane").getDOMNode(),rteHeight:"100%",rteWidth:"100%",defaultDirection:d?"rtl":"ltr",defaultFontSize:f,defaultFontColor:g,defaultFontFamily:h,initialCSS:c,showBackgroundColor:!1,showLists:!1,showLayout:!1,showLink:!1},e.RTE=new a.Tictac.base.RichTextEditor(b),e.RTE.render(e.node.one(".mim-conversation-rte").getDOMNode()),e.RTE.registerEventListener(a.bind(e._handleEditorEvents,e)),e._rteListeners.push(e.RTE.on("defaultFontSizeChange",function(a){k.setPreference("mimDefaultFontSize",a.newVal),k.save()})),e._rteListeners.push(e.RTE.on("defaultFontFamilyChange",function(a){k.setPreference("mimDefaultFontFamily",a.newVal),k.save()})),e._rteListeners.push(e.RTE.on("defaultFontColorChange",function(a){k.setPreference("mimDefaultFontColor",a.newVal),k.save()}))},_handleModelDestroyEvents:function(){var b=this,c=b.model;c.on("destroy",function(){a.log("ConversationView:_handleDestroyEvents "),b.destroy()})},focus:function(){this.RTE.focus()},handleLogin:function(){this.node.all(".mim-notify-disconnect").remove(!0),this.node.all("button").removeAttribute("disabled"),this._disabled=!1},handleLogout:function(){this.renderNotification({message:f.substitute(h.str_error_disconnected_error,{str_branding_messenger:h.str_branding_messenger}),type:j.NOTIFICATION_INLINE,error:!0,className:"mim-notify-disconnect"}),this.node.all("button").setAttribute("disabled","disabled"),this._disabled=!0},_handleEditorEvents:function(a){var b=this;if(!b._disabled)return"keydown"===a.type?b._handleKeyDown(a):"keypress"===a.type?b._handleKeyPress(a):("paste"===a.type?b._checkSize():"cut"===a.type?b._checkSize():"focus"===a.type&&(g.flashWindow(!1),b._unreadMessage===!0&&(b._unreadMessage=!1,b.model.ack())),!1)},_handleKeyDown:function(b){var c=!1,d=this.options.keyEvents,e=this;return 27===b.keyCode?e.close():13===b.keyCode?b.ctrlKey||b.shiftKey||b.altKey||b.metaKey?(c=!0,a.later(0,this,function(){this.RTE.insertBR()})):((this.contact.get("ignored")||k.getPreference("mimBlockNonContacts")&&0===this.contact.collection.where({id:this.contact.id}).length)&&"im"===this.get("mode")||this._send(),c=!0):d&&(b.metaKey||b.ctrlKey||b.shiftKey||b.keyCode<48)&&_.each(d,function(a){var d=a.ctrlKey||!1,f=a.metaKey||!1,g=a.metaCtrlKey||!1,h=a.shiftKey||!1,i=g?b.metaKey||b.ctrlKey:f===b.metaKey&&d===b.ctrlKey;a.keyCode===b.keyCode&&i&&h===b.shiftKey&&(a.callback(e.RTE),c=a.halt)}),this._stoppedTypingTimerFast&&clearTimeout(this._stoppedTypingTimerFast),this._stoppedTypingTimerFast=a.later(100,this,function(){this.RTE&&this.node&&this._checkSize()}),c},_handleKeyPress:function(a){13!==a.keyCode&&this._setTypingState(!0)},_startTypingTimer:function(){this._clearTypingTimer(),this._stoppedTypingTimer=a.later(r,this,function(){this._setTypingState(!1)})},_setTypingState:function(b){"im"===this.get("mode")&&(this._isTyping!==b&&(a.log("Setting typing state to "+b+" for conversation "+this.model.get("id")),this._isTyping=b,this.model.sendTypingNotification(b)),b?this._startTypingTimer():this._clearTypingTimer())},_clearTypingTimer:function(){this._stoppedTypingTimer&&(this._stoppedTypingTimer.cancel(),this._stoppedTypingTimer=null)},_checkSize:function(){var a,b,c=this.node.one(".mim-conversation-rte"),d=p+"px",e=this.node.one(".mim-conversation-area"),f=e.one(".mim-message-area"),g=this.node.one(".mim-conversation-input-toolbar"),h=g.getY(),i=this.node.getY(),j=parseInt(this.node.getComputedStyle("height"),10),k=parseInt(e.getStyle("bottom"),10),l=i+j-h,m=f.get("scrollTop"),n=m+(l-k);c.getStyle("height")!==d&&c.setStyle("height",d),b=this.RTE.getScrollHeight(),a=b,a>p&&(a>q?(this.RTE.setBodyStyle("overflowY","auto"),a=q):this.RTE.setBodyStyle("overflowY","hidden"),c.setStyle("height",a+"px")),m!==n&&e.setStyle("bottom",l+"px"),m!==n&&f.set("scrollTop",n)},_send:function(){var b=this.RTE.getTextContent(),c=this;""!==b&&(c._doSend(),c._clearTypingTimer(),c._isTyping=!1,a.later(0,null,function(){m.stat("message_send",{ltxt:c.get("mode")}),g.triggerAds("978500261")}))},_doSend:function(){var b=this.RTE.getContent();a.log('_send html="'+b+'"',"debug","ConversationView"),this.model.sendMessage(a.Messenger.YMLUtil.domToYml(a.Node.create(b).getDOMNode())),this.RTE.clear()},renderMessage:function(b){var c,i,l,n=this,o=new Date(b.timeStamp),p=a.Messenger.Neo.core,q="",r="",s=!1,t="rtl"===a.Tictac.base.bidi.bidiDirection(b.text()),u="ltr",v=p.getDateFormat(o),w=new Date;b.fromSelf?i=h.str_conv_self_objective:(i=n.contact.get("displayName"),("sms"===b.type||"im"===b.type)&&m.stat("message_receive",{ltxt:b.type})),d?(t||(q="ltr",r="ltr"),u="rtl"):t&&(q="rtl",r="rtl"),"offline"!==b.type||n._offlineNotification?"transfer"!==b.type||n._transferNotification?"recent"!==b.type&&b.type!==n.get("mode")&&n.set("mode",b.type):(n._transferNotification=!0,n.renderNotification({message:f.substitute(h.str_conv_user_statexfer_notice,{conversation_user:i}),type:j.NOTIFICATION_INLINE})):(n._offlineNotification=!0,n.renderNotification({message:h.str_conv_user_offlineMessage_notice,type:j.NOTIFICATION_INLINE})),n._lastConversation=n.model.get("messages").slice(-1),(w.getDate()!==o.getDate()||w.getMonth()!==o.getMonth()||w.getYear()!==o.getYear())&&w.getYear()===o.getYear()&&w.getDate()-o.getDate()<7&&(v=p.getDateFormat(o,!1,!0).trim()),c=a.Node.create(e.message({message:b.html(),isRTL:d,isTextRTL:t,fromSelf:b.fromSelf,displayName:i,rtlClass:q,messageDir:u,rtlTimestampClass:r,timestamp:p.dateFormatter(o,v)})),"recent"===b.type?(n.node.one(".mim-recent-message-list").append(c),n._stopRecentMessageSpinner()):(l=n.messageAreaNode.get("scrollHeight")-n.messageAreaNode.get("clientHeight")-n.messageAreaNode.get("scrollTop")<10,n.messageListNode.append(c),l&&n._forceScrollPane()),b.fromSelf||"recent"===b.type?b.fromSelf&&(n.set("unreadCount",0),g.flashWindow(!1)):(n.isVisible()?n.RTE&&!n.RTE.isFocused()&&(s=!0,n._unreadMessage=!0):(n.set("unreadCount",n.get("unreadCount")+1),s=!0),s&&(k.getPreference("mimEnableSounds")&&g.playAudioNotification(),g.flashWindow(f.substitute(h.str_conv_new_message_browser_title,{conversation_user:i}))))},_forceScrollPane:function(){this.messageAreaNode&&this.messageAreaNode.set("scrollTop",this.messageAreaNode.get("scrollHeight"))},setTypingNotification:function(a){a?this.node.one(".mim-typing-notification").setStyle("visibility","visible"):this.node.one(".mim-typing-notification").setStyle("visibility","hidden")},close:function(){m.stat("conversation",{option:"close"}),this.model.destroy({local:!0})},getId:function(){return this.model.get("id")},events:{"click .mim-emoticon-list > .mim-emoticon":"_insertEmoticon","click [data-action]":"_handleActions",'click [data-autodestroy="true"]':"_destroyNotification","click .mim-notification-close":"_destroyNotification","click .mim-notification.mim-show-recent":"_toggleRecentMessages","click .mim-notification.mim-history-all":"_showConvHistory"},_toggleRecentMessages:function(b){var c=this,d=b.currentTarget,e=d.one(".mim-notification-text"),g=c.node.one(".mim-recent-message-list");d.hasClass("mim-hide-recent")?(g.addClass("hidden"),d.removeClass("mim-hide-recent"),e.setHTML(h.str_conv_btn_show_recent_conv)):(g.removeClass("hidden"),c._hasLoadedRecent||(c.model.loadRecentMessages(c.get("mode")),c._hasLoadedRecent=!0,c._hasNotLoadedRecent=!0,a.later(5e3,c,function(){c._hasNotLoadedRecent&&(c._stopRecentMessageSpinner(),d.addClass("hidden"),c.renderNotification({message:f.substitute(h.str_error_recent_messages_empty,{contact:c._getContactDisplayName()}),type:j.NOTIFICATION_SECTION_TOP}))})),e.setHTML(h.str_conv_btn_hide_recent_conv),d.addClass("mim-hide-recent"))},_showConvHistory:function(){var a=this.model.get("user");yui.use("mail-ui-execute-search-utils").then(function(b){b.mail.ui.ExecuteSearchUtils.doMailSearch({searchType:"keyword",query:{keyword:'in:"chats" from:'+a},source:"Search_from_mim_history",shouldParseKeyword:!0,customTitle:{noLabel:!0,value:h.str_opt_msg_general_heading_history}})})},_getContactDisplayName:function(){var b=this.model.get("user"),c=this.model.get("network"),d=a.Messenger.Model.ContactList.getInstance(),e=d.getContact(b,c);return e?e.get("displayName"):""},_stopRecentMessageSpinner:function(){var a;this._hasNotLoadedRecent&&(a=this.node.one(".mim-recent-message-list .mim-recent-message-spinner"),a&&a.remove(),this._hasNotLoadedRecent=!1,this.renderNotification({message:h.str_conv_show_all_history,type:j.NOTIFICATION_SECTION_TOP,className:"mim-history-all",selector:".mim-recent-message-list"}))},_insertEmoticon:function(a){var b,c=a.currentTarget,d=c.getAttribute("data-emotekey"),e=this.model.get("network");"sms"===e&&(e="yahoo"),b=i.emoticonPickerEntries[e][d],this.RTE&&(this.RTE.insertText(b),this._emoticonsPane.addClass("hidden"),this._updateToolbarState())},_updateToolbarState:function(){var a=this.node.all(".mim-conversation-input-toolbar ul.cf li");a.removeClass("mim-toolbar-item-selected"),this._emoticonsPane.hasClass("hidden")?this._formatPane.hasClass("hidden")||this.node.one(".mim-format-link").addClass("mim-toolbar-item-selected"):this.node.one(".mim-emoticons-link").addClass("mim-toolbar-item-selected")},_handleActions:function(b){var c=b.currentTarget.getAttribute("data-action");switch(a.log("ConversationView:_handleActions ",c),c){case"closeconversation":this.close();break;case"format":m.stat("rte_format"),this._formatPane.toggleClass("hidden"),this._emoticonsPane.hasClass("hidden")||this._emoticonsPane.toggleClass("hidden"),this._updateToolbarState(),this.RTE.focus();break;case"emoticons":m.stat("rte_emoticon"),this._emoticonsPane.toggleClass("hidden"),this._formatPane.hasClass("hidden")||this._formatPane.toggleClass("hidden"),this._updateToolbarState(),this.RTE.focus();break;case"conv-mode":this.set("mode",b.currentTarget.getAttribute("data-mode"));break;default:a.log("ConversationView:_handleTopBarEvents bad action ",c)}},showAuthorizationILN:function(b){var c,d,e=a.Messenger.Model.ContactList.getInstance(),i=this,k=i.model.get("alias"),l=i.model.get("user"),n=i.model.get("displayName")||l,o=f.substitute(h.str_conv_no_contact_add_request,{conversation_yid:n}),p=i.model.get("network"),q=e.getContact(l,p);i.node.one(".mim-add-req")||(i.node.one(".mim-unknownuser-iln")&&i._destroyNotification(i.node.one(".mim-unknownuser-iln")),i.isVisible()||i.set("unreadCount",i.get("unreadCount")+1),b&&(o+='<p class="mim-addreq-message">'+a.Escape.html(b)+"</p>"),c=[{label:h.str_conv_btn_accept,title:f.substitute(h.str_conv_btn_accept_attr,{conversation_yid:l}),className:"mim-button-accept",callback:function(){m.stat("add_accept"),q.sendAddResponse({accept:!0,alias:k,err:function(a){i.renderNotification({type:j.NOTIFICATION_INLINE,error:!0,message:g.convertErrorCodeToMessage(a.error.code)})}})}},{label:h.str_conv_btn_decline,className:"mim-button-decline",title:f.substitute(h.str_conv_btn_decline_attr,{conversation_yid:l}),callback:function(){m.stat("add_decline"),q.sendAddResponse({alias:k,accept:!1,err:function(a){i.renderNotification({type:j.NOTIFICATION_INLINE,error:!0,message:g.convertErrorCodeToMessage(a.error.code)})}})}},{label:h.str_conv_btn_decline_block,title:h.str_conv_btn_decline_block,className:"mim-button-decline-block",callback:function(){m.stat("add_block"),q.sendAddResponse({alias:k,accept:!1}),d={success:function(){i._showUnblockUserILN()},err:function(){}},q.ignoreUser(d)}}],i.renderNotification({message:o,type:j.NOTIFICATION_INLINE,buttons:c,className:"mim-add-req"}))},_sendAddRequest:function(b){var c,d,e=this.model.get("alias"),f=a.Messenger.Model.ContactList.getInstance(),i=this.model.get("user"),k=this.model.get("network"),n=this;return(c=g.validateContactForm(b))?c:(m.stat("conversation",{option:"add_to_contacts"}),d=f.getContact(i,k),_.each(b,function(a,b){d.set(b,a),"mobileno"===b&&d.set("normalizedNumber",l.normalizeNumber(a))}),void d.sendAddRequest({addAs:e,group:h.str_conv_default_group,errorCallback:function(a){n.renderNotification({type:j.NOTIFICATION_INLINE,error:!0,message:g.convertErrorCodeToMessage(a.error.code)})}}))},_showSSANotification:function(){this.node.one(".mim-ssa-notify")||this.renderNotification({message:h.str_opt_msg_general_history_description,type:j.NOTIFICATION_STATICTOP,className:"mim-ssa-notify",buttons:[{label:h.str_conv_user_notification_ssa_button,callback:function(){a.Messenger.GlobalEvents.trigger(j.EVENTS.SHOW_OPTIONS)}},{label:h.str_conv_user_notification_ssa_dismiss_button,callback:function(){k.setPreference("mimSSANotificationSeen",!0),k.save()}}]})},_showUnknownUserILN:function(){var b,c=this,d=a.Messenger.Model.ContactList.getInstance(),i=c.model.get("user"),k=c.model.get("network"),l=c.contact.get("firstName")||"",n=c.contact.get("lastName")||"",o=0===h.str_session_display_name_order.indexOf("{{lastName}}"),p=f.substitute(h.str_conv_wrn_unknown_user,{userid:a.Escape.html(i)}),q=[{label:h.str_conv_btn_add_to_contacts,title:f.substitute(h.str_conv_btn_add_to_contacts_attr,{conversation_yid:i}),className:"mim-button-add",callback:function(){g.confirm({title:h.str_cont_add_to_cont,message:e.addcontact({user:i,lastNameFirst:o,isIE:!!a.UA.ie,firstName:l,lastName:n}),hasFormId:{formId:"mim-edit-contact"},callback:function(a){var d=g.validateContactForm(a);return b&&!d&&c._destroyNotification({currentTarget:b}),c._sendAddRequest(a)}})}}],r={label:h.str_conv_btn_block_user,title:f.substitute(h.str_conv_btn_block_user_attr,{conversation_yid:i}),className:"mim-button-block",callback:function(){m.stat("conversation",{option:"block"}),d.getContact(i,k).ignoreUser({success:function(){b&&c._destroyNotification({currentTarget:b}),c._showUnblockUserILN()},err:function(a){c.renderNotification({type:j.NOTIFICATION_INLINE,error:!0,message:g.convertErrorCodeToMessage(a.error.code)})}})}},s={label:h.str_conv_report_abuse,title:h.str_conv_btn_report_abuse_attr,className:"mim-button-abuse",callback:function(){m.stat("conversation",{option:"abuse"}),g.confirm({title:h.str_conv_report_abuse_title,cssClass:"mim-report-abuse-dialog",message:e.report_abuse_spam({reportSpamText:h.str_conv_report_spam_radio,reportSpamDesc:h.str_conv_report_spam_description,reportAbuseText:h.str_conv_report_abuse_radio,reportAbuseDesc:h.str_conv_report_abuse_description}),callback:function(a){switch(b&&c._destroyNotification({currentTarget:b}),a.abuseType){case"spam":m.stat("conversation",{option:"abuse_spam"}),c._spam(),c.close();break;case"abuse":m.stat("conversation",{option:"abuse_threat"}),g.openReportAbuseWindow(h.str_urls_report_abuse_no_trans,c.model.get("messages")),c.contact.ignoreUser(),c.close()}}})}};this.options.initiatedByMe||(q.push(r),q.push(s)),c.node.one(".mim-add-req")||(b=this.renderNotification({className:"mim-unknownuser-iln",message:p,type:j.NOTIFICATION_STATICTOP,buttons:q,showClose:!0,autoDestroy:!1}))},_showUnblockUserILN:function(){var b=this,c=a.Messenger.Model.ContactList.getInstance(),d=this.model.get("user"),e=this.model.get("network"),i=f.substitute(h.str_conv_wrn_unblock_user,{userid:d}),k=[{label:h.str_conv_btn_unblock_user,title:f.substitute(h.str_conv_btn_unblock_user_attr,{conversation_yid:d}),className:"mim-button-unblock",callback:function(){m.stat("conversation",{option:"unblock"}),b.focus(),c.getContact(d,e).unignoreUser({err:function(a){b.renderNotification({type:j.NOTIFICATION_INLINE,error:!0,message:g.convertErrorCodeToMessage(a.error.code)})}})}}];this.renderNotification({message:i,type:j.NOTIFICATION_STATICTOP,buttons:k,showClose:!0})},_showSendErrorILN:function(a){var b=a&&g.convertErrorCodeToMessage(a)||"";this.renderNotification({message:1!==a&&b?b:h.str_comp_send_error,type:j.NOTIFICATION_INLINE,error:!0,showClose:!0})},_spam:function(){var b,c,d,e,f,h,i=this,k=i.model.get("alias"),l=i.contact.get("displayName"),m=[],n=i.model.get("messages");for(d=0,e=n.length;e>d&&50>d;d++)c={message:n[d].yml(),initiatedBy:n[d].fromSelf?1:2},n[d].hash&&(c.hash=n[d].hash),m.push(c);b=0===m.length?1:m[0].initiatedBy,f={alias:k,initiatedBy:b,spims:m,err:function(a){i.renderNotification({type:j.NOTIFICATION_INLINE,error:!0,message:g.convertErrorCodeToMessage(a.error.code)})}},m.length>0&&i.contact.reportSpam(f),h=a.merge(f,{success:function(){i._showUnblockUserILN()}}),i.contact.ignoreUser(h),g.showSpamConfirm(l)},renderModeILN:function(b,c){var d,f,g=this,h=new Date,i=a.Messenger.Neo.core,k=g.model.get("messages");k.length&&"recent"!==k[k.length-1].type&&((g._hasLoadedRecent||!g._lastConversation)&&(f=g.messageAreaNode.one(".mim-section-notification:last-of-type"),!f&&a.UA.ie>0&&(d=g.messageAreaNode.all(".mim-section-notification"),d&&d.slice&&(f=d.slice(-1))),f&&f.remove()),(c||g.previous("mode")!==g.get("mode"))&&(g.renderNotification({message:e.conv_section_modechange({IM:"im"===b,dateTime:i.dateFormatter(h,i.getDateFormat(h))}),type:j.NOTIFICATION_SECTION}),delete g._lastConversation))},renderNotification:function(b){if(!this._destroyed){var c,d,f,g,h,i,k=b.buttons||[],l=b.type||j.NOTIFICATION_INLINE,m=b.message||"",n=this,o=b.autoDestroy,p=b.id,q=b.className||"";return l===j.NOTIFICATION_SECTION||l===j.NOTIFICATION_SECTION_TOP?(c=l===j.NOTIFICATION_SECTION?"append":"prepend",this.node.one(b.selector||".mim-message-list")[c](a.Node.create(e.conv_section_notification({message:m,notifyClass:q}))),void this._forceScrollPane()):(q+=l===j.NOTIFICATION_STATICTOP?" mim-notification-static":l===j.NOTIFICATION_INLINE||l===j.NOTIFICATION_INLINE_TOP?" mim-notification-inline":" mim-notification-plain",b.error&&(q+=" mim-notification-error"),"undefined"==typeof o&&(o=!0),i={notifyClass:q,notifyId:p,showClose:!!b.showClose,notifyType:b.type,messageText:m},l===j.NOTIFICATION_INLINE_PLAINTEXT?i.showClose=!1:b.showClose!==!1&&l===j.NOTIFICATION_STATICTOP&&(i.showClose=!0),d=a.Node.create(e.conv_notification(i)),k.length&&(f=d.one(".mim-notification-buttons"),a.Array.each(k,function(b){return b.label&&b.callback?(g=a.Node.create(e.conv_notification_btn({buttonClass:"mim-notification-button",buttonLabel:b.label,autoDestroy:o})),b.className&&g.addClass(b.className),g.on("click",b.callback),b.attrs&&a.each(b.attrs,function(a,b){g.setAttribute(b,a)}),void f.appendChild(g)):void a.log("Invalid button parameter passed for this notification.  Buttons must have at least a label and a callback.","warn","conversationview")}),f.removeClass("hidden")),l===j.NOTIFICATION_STATICTOP?(h=this.node.one(".mim-notification-area"),h.append(d),h.removeClass("hidden"),n._updateLayout()):l===j.NOTIFICATION_INLINE_TOP?this.node.one(".mim-message-list").prepend(d):(this.node.one(".mim-message-list").append(d),this._forceScrollPane()),d)}},_destroyNotification:function(a){var b,c,d=a.currentTarget||a;d.hasClass("mim-notification")||(d=d.ancestor(".mim-notification")),b=d.hasClass("mim-notification-static"),d.ancestor(".mim-notification",!0).remove(!0),b&&(c=this.node.one(".mim-notification-area"),0===c.get("children").size()&&c.addClass("hidden"),this._updateLayout())}}),a.namespace("Messenger.View").ConversationView=c},"@VERSION@",{requires:["tictac-mim-rollups","tictac-base-view","messenger-contactlist","messenger-ymlutils","tictac-mim-strings","tictac-base-utils","base-bidi","tictac-base-richtexteditor","messenger-constants","messenger-utils","messenger-viewutils","messenger-conversation-css","messenger-usersettings","messenger-stats","messenger-smsutils","messenger-systemsettings","json-parse"]});"use strict";YUI.add("messenger-newconversationview",function(a){function b(a){return a&&a.length>=4&&a.search(/[\\\|\!\#\$\%\^\*\(\)\+\[\]\{\}\?<>]/)<0}function c(a,b){return j.validatePhoneNumber(a,b)}function d(a){var b=/<[^>]*?>/gi;return a.replace(b,"")}function e(a){return a.replace(/\+/,"\\+")}var f,g,h=a.Tictac.mim.rollups,i=a.Messenger.Common.Utils,j=a.Messenger.View.ViewUtils,k=a.Messenger.Common.Stats,l=a.Messenger.Common.Constants,m=a.Messenger.Model.SystemSettings,n=0;f=a.Tictac.base.View.extend({initialize:function(){var a=this;g=m.get("isRTL"),a.set("mode",a.options.mode||"im"),a.on("show",a._onShow,a),a.on("hide",a._onHide,a),a._corpPresenceMap={}},createDOMNode:function(){var b,c=this.options.session,d=this._getContactsArray(),e=c.get("presenceState"),f=c.get("presenceMessage")||j.getDefaultPresenceMessage(e);return b=a.Node.create(h.newconversation({presenceName:j.getPresenceName(e),presenceClassName:j.getBuddyIconClass(c.get("presenceState")),presenceMessage:i.normalizePresenceMessage(f),stateName:j.getStateName(e),contacts:d})),this._renderedContacts=d,b},_contactOverlayClicked:function(b,c,d){var e,f=this,g=a.Messenger.Model,h=a.Messenger.View.ConversationListView.convListView,i=c.split("~"),j=this.collection.get(c)||this.collection.getContact(i[0],i[1]),l=j&&j.get("user"),m=j&&j.get("network"),n=g.Session.get("loggedInId");if(j)switch(k.stat(b,{type:"search_action"}),k.stat("frnd"),b){case"moremenu":f.showContextMenu(j,d,c);break;case"im":h.showConversation(l,m,n);break;case"sms":h.showConversation(l,m,n,"sms");break;case"email":e={cbfn:function(a){var b=a.get("header");b.to=[{name:j.get("displayName"),email:j.get("email")||j.get("user")}],a.set("header",b)}},yui.fire("newMessage",e)}},postRender:function(){this.options.session.on("change:presenceState",this._handlePresenceStateChange,this),this.options.session.on("change:presenceMessage",this._handlePresenceMessageChange,this),this.collection.on("change:presenceState",this._handleUpdateContactState,this),this.collection.on("change:displayName",this._handleContactDisplayNameChange,this),this.collection.on("remove",this._handleContactRemoval,this),this.collection.on("add",this._handleContactAdded,this);var a=this.node.all("#mim-newconversation-contact-list > li");a.size()>0?(this._selectedContactNode=a.item(0),this._selectedContactNode.addClass("mim-contact-selected")):this._selectedContactNode=null,this._filterNode=this.node.one(".mim-contact-input"),this._clearNode=this.node.one(".mim-contact-input-clear")},_onShow:function(){this._filterValue||this._clearFilter(),this.focus()},_onHide:function(){this._corpPresenceMap={}},focus:function(){this._filterNode.focus()},onDestroy:function(){this.options.session.off("change:presenceState",this._handlePresenceStateChange,this),this.options.session.off("change:presenceMessage",this._handlePresenceMessageChange,this),this.collection.off("change:presenceState add",this._handleUpdateContactState,this),this.collection.off("change:displayName",this._handleContactDisplayNameChange,this),this.collection.off("remove",this._handleContactRemoval,this)},_sortScore:function(b,c){var d,e,f="sms"===this.get("mode"),g=l.STATE.AVAILABLE;return"object"==typeof b?(g=b.presenceState,e=b.network,b=b.displayName.toLowerCase()):"string"==typeof b?b=b.toLowerCase():a.log("sortScore unexpected data type "+typeof b+" "+b),d=c&&0===b.indexOf(c)?"0-":f&&"sms"===e?"1-":f||g!==l.STATE.OFFLINE?"5-":"9-",b=d+b},_getMode:function(a,b){var d,e,f=this.get("mode");return a?(d=a.get("mobileno"),e=a.get("network"),"sms"===f?d||"sms"===e||(f="im"):("sms"===e||b&&d&&d.indexOf(b)>=0)&&(f="sms")):f=c(b)?"sms":"im",f},_getContactObj:function(b,c,d){function f(a,b){return a.get?a.get(b):a[b]}var h,i,k,l,n,o;return i=f(b,"displayName"),k=c&&("string"==typeof c?new RegExp(e(c),"i"):c),l=d||("sms"===this.get("mode")?f(b,"mobileno"):f(b,"user")),l=a.Escape.html(l),n=k?i.replace(k,'<span class="mim-contact-matched">$&</span>'):i,o=k?l.replace(k,'<span class="mim-contact-matched">$&</span>'):l,h=l&&i!==l?n+(g?" &rlm;":" ")+'<span class="mim-contact-alternate">('+o+")</span>":n,a.merge(b.attributes,{className:j.getBuddyIconClass(f(b,"presenceState")),mergedDisplayName:h,contact:b,has_email:!!f(b,"email"),has_im:"sms"!==f(b,"network"),has_sms:m.get("smsEnabled")&&!!f(b,"mobileno")})},_byFieldsIncluding:function(a,b){var c,d,f,g,h,i,j={firstName:!1,lastName:!1,nickname:!1,mobileno:!0,email:!1,user:!0,displayName:!0,mergedDisplayName:!1,id:!1};for(d in j)j.hasOwnProperty(d)&&(f=j[d],f&&(g=a[d],h="string"==typeof b?new RegExp(e(b),"i"):b,i=g&&h&&g.match(h),(i||!h)&&(a.mergedDisplayName=this._getContactObj(a.contact,h,g).mergedDisplayName,c=!0)));return c},openConversation:function(d,e){var f,g,h,i=this._getMode(d,e),j=a.Messenger.View.ConversationListView.convListView;d&&d.get("user")?(f=d.get("user"),g=d.get("network")):(f=(b(e)||c(e))&&e,g="sms"===i?"sms":"yahoo","yahoo"===g&&f.indexOf("@")>-1&&(f=a.Messenger.Common.ABUtils.extractYidFromEmail(f),f&&(f=f.id))),j&&f&&j.showConversation(f,g,h,i,!0)},_handlePresenceStateChange:function(a){var b=this.node.one(".mim-user-opi > .mim-presence-state");b&&(b.removeClass(j.getBuddyIconClass(a.previous("presenceState"))).addClass(j.getBuddyIconClass(a.get("presenceState"))),b.setHTML(j.getPresenceName(a.get("presenceState")))),this.presencePlugin&&this.presencePlugin.updateContactListState(a)},_handlePresenceMessageChange:function(a){var b=this.node.one(".mim-user-opi .mim-presence-message");b&&b.setHTML(i.normalizePresenceMessage(a.get("presenceMessage"))),this.presencePlugin&&this.presencePlugin.updateContactListState(a)},_handleUpdateContactState:function(a){this._handleContactRemoval(a),this._handleContactAdded(a)},_handleContactDisplayNameChange:function(a){this._handleContactRemoval(a),this._handleContactAdded(a)},_handleContactRemoval:function(a){var b,c=this,d=c.node.one('li[data-id="'+a.get("id")+'"]');for(d&&d.remove(!0),b=0;b<c._renderedContacts.length;b++)if(c._renderedContacts[b].id===a.get("id")){c._renderedContacts.splice(b,1);break}},_handleContactAdded:function(b){var c,d,e=this,f=e._getContactObj(b),g=e.node.one("#mim-newconversation-contact-list");c=_.sortedIndex(e._renderedContacts,f,function(a){return e._sortScore(a,e._filterValue)}),e._renderedContacts.splice(c,0,f),d=a.Node.create(h.newconv_contact_entry(f)),g.insert(d,g.all("li").item(c))},_getContactsArray:function(){var a,b=this;return a=_.map(this.collection.filter(function(a){var c=b.options.session.isMyself(a.get("user"));return!(c||a.get("ignored")&&!a.get("mobileno")||"sms"===b.get("mode")&&!a.get("mobileno")||!m.get("smsEnabled")&&"sms"===a.get("network"))}),function(a){return b._getContactObj(a)}),a=_.sortBy(a,function(a){return b._sortScore(a)})},_setFilter:function(d,e){var f,g,i,j,k=this,l=k._getContactsArray();l&&(f=_.map(_.filter(l,function(a){return d(a,e)}),function(a){return a}),f=_.sortBy(f,function(a){return k._sortScore(a,e)}),(b(e)||c(e,1))&&(j={className:"ymsg-new-contact",displayName:e,mergedDisplayName:e},f.push(j)),g=a.Node.create(h.newconvcontlist({contacts:f})),k._renderedContacts=f,k.node.one(".mim-newconversation-area").replace(g),i=k.node.all("#mim-newconversation-contact-list > li"),i.size()>0?(k._selectedContactNode=i.item(0),k._selectedContactNode.addClass("mim-contact-selected")):k._selectedContactNode=null,a.Messenger.Neo.NeoConfig.isCorpmail===!0&&(k._pendingGabCall&&k._pendingGabCall.abort(),k._showCorpContacts(e,k._normalizeCorpContactsAndAppend)))},_showCorpContacts:function(b,c){var d=+new Date,e=this,f="/neo/gab/gab.php?q="+b+"&corpmail=1&windowId="+a.Messenger.Neo.NeoConfig.windowId+"&r="+d;e._pendingGabCall=a.io(f,{headers:{"Content-Type":"application/json"},on:{success:function(d,f){var g=a.JSON.parse(f.responseText.replace(/<!--[^>]*>\s*$/,""));e._pendingGabCall=null,c(g,b,e)},failure:function(){e._pendingGabCall=null}}})},_normalizeCorpContactsAndAppend:function(b,c,d){var e,f=d._normalizeCorpContacts(b.data,c);f.length>0&&(e=a.Node.create(h.newconvcorpcontlist({corpContacts:f})),a.one("#mim-newconversation-contact-list").append(e),d._corpContacts=f)},_normalizeCorpContacts:function(b,c){var d=[],e=this,f=[];return b.push||(b=[b]),_.each(b,function(b){var g={firstName:b.firstname,lastName:b.lastname,email:b.email,user:b.email,clientCapabilities:1,type:"addressbook"},h=a.Messenger.Model.ContactList.getInstance().normalizeContact(g);h=e._getContactObj(h,c),h=a.mix(h,h.contact),h.className="ymsg-corp-contact ","undefined"!=typeof e._corpPresenceMap[b.email]?(h.presenceState=e._corpPresenceMap[b.email],h.className+=j.getBuddyIconClass(h.presenceState)):(h.className+="ymsg-offline",f.push(b.email)),d.push(h)}),f.length&&e._getCorpContactsPresence(f),d},_getCorpContactsPresence:function(b){var c=this,d="/online/ws?m=1&p=1&t=1",e={context:c,method:"POST",on:{success:function(b,d){var e,f,g,h=a.JSON.parse(d.responseText);h=h&&h.buddyStatus,e={},a.each(h,function(b){a.mix(e,b)}),a.each(e,function(b,d){b.presenceState=b.statusCode,b.customDNDStatus=b.dndStatus,f=a.one("[data-id="+d+"~yahoo]"),g=i.normalizePresenceState(b),f&&j.replaceBuddyIcon(f,g),c._corpPresenceMap[d]=g}),c._pendingPresenceReq=null}},data:a.JSON.stringify({buddiesYid:b})};c._pendingPresenceReq&&c._pendingPresenceReq.abort(),c._pendingPresenceReq=a.io(d,e)},_clearFilter:function(){var b,c,d=this,e=d._getContactsArray();e=_.sortBy(e,function(a){return d._sortScore(a)}),b=a.Node.create(h.newconvcontlist({contacts:e})),d._renderedContacts=e,d.node.one(".mim-newconversation-area").replace(b),c=d.node.all("#mim-newconversation-contact-list > li"),c.size()>0?(d._selectedContactNode=c.item(0),d._selectedContactNode.addClass("mim-contact-selected")):d._selectedContactNode=null,d._filterNode.set("value",""),d._filterValue="",d._filterFunc=null,d._clearNode.setAttribute("disabled","disabled"),d._clearNode.setAttribute("data-search",!0)},_navUpDownNodes:function(a){var b,c,d,e,f,g,h,i,j,k,l=this.node.all("#mim-newconversation-contact-list > li");if(l.size()>0&&(b=l.item(a>0?0:l.size()-1),this._selectedContactNode?(c=l.item(l.indexOf(this._selectedContactNode)+a),c||(c=b)):c=b,l.removeClass("mim-contact-selected"),c))if(this._selectedContactNode=c,c.hasClass("mim-corp-contacts-separator")){if(l.size()>1)return void this._navUpDownNodes(a);this._selectedContactNode=null}else this._selectedContactNode.addClass("mim-contact-selected"),d=this._selectedContactNode.get("parentNode"),e=d.getY(),f=parseInt(d.getComputedStyle("height"),10),g=e+f,h=this._selectedContactNode.getY(),i=parseInt(this._selectedContactNode.getComputedStyle("height"),10),j=h+i,k=h>e&&g>j,k||this._selectedContactNode.scrollIntoView(0>a);n=new Date},_mouseenter:function(a){var b,c=a.currentTarget,d=new Date-n;c&&d>1e3&&(b=this.node.all("#mim-newconversation-contact-list > li"),b.removeClass("mim-contact-selected"),c.addClass("mim-contact-selected"),this._selectedContactNode=c)},_handleKey:function(b){var c,e=this,f=a.Escape.html(d(a.Lang.trim(e._filterNode.get("value"))));e.changeFilterTimeout&&(clearTimeout(e.changeFilterTimeout),e.changeFilterTimeout=null),b&&27!==b.keyCode?40===b.keyCode?(e._navUpDownNodes(1),b.halt()):38===b.keyCode?(e._navUpDownNodes(-1),b.halt()):13===b.keyCode?(e._selectedContactNode&&(c=e._getContactFromLI(e._selectedContactNode),e.openConversation(c,f)),e._clearFilter(),b.halt()):e.changeFilterTimeout=setTimeout(function(){e._filterValue=a.Escape.html(d(a.Lang.trim(e._filterNode.get("value"))));var b=0===e._filterValue.length;b?(e._clearNode.setAttribute("disabled","disabled"),e._clearFilter()):(e._clearNode.removeAttribute("disabled"),e._setFilter(a.bind(e._byFieldsIncluding,e),e._filterValue)),e._clearNode.setAttribute("data-search",b)},100):(e.trigger("escKeyDown"),b&&b.halt())},_getContactFromLI:function(a){var b,c,d,e,f=this,g=a.getAttribute("data-id"),h=a.hasClass("ymsg-corp-contact");return g&&(c=g.split("~"),d=f.collection.get(g),!d&&c[0]&&(d=f.collection.getContact(c[0],c[1]),h&&(e=_.find(f._corpContacts,function(a){return a.user===c[0]}),e&&d.set({firstName:e.firstName,lastName:e.lastName,displayName:e.displayName}))),h&&"unknown"===d.get("type")&&(b=g.split("~")[0],"undefined"!=typeof f._corpPresenceMap[b]&&d.set("presenceState",f._corpPresenceMap[b]))),d},getId:function(){return"new"},close:function(){},clickNewConversationList:function(b){var c,d,e,f,g;return c=b.target,d=b.currentTarget,c.hasClass&&c.hasClass("mim-corp-contacts-separator")||d.hasClass&&d.hasClass("mim-corp-contacts-separator")?void b.halt():(f=this._getContactFromLI(d),e=d.getAttribute("data-id"),g=a.Escape.html(a.Lang.trim(this._filterNode.get("value"))),void(c.hasClass&&c.hasClass("mim-newconversation-overlay-btn")?(this._contactOverlayClicked(c.getAttribute("data-action"),e,d),b.halt()):(k.stat("im",{type:"search"}),k.stat("frnd"),this.openConversation(f,g),this._clearFilter())))},handleContextMenu:function(a){var b,c,d,e,f=this;if(f.contactPlugin){if(b=a.target,d=a.currentTarget,b.hasClass&&b.hasClass("mim-corp-contacts-separator")||d.hasClass&&d.hasClass("mim-corp-contacts-separator"))return void a.halt();c=this._getContactFromLI(d),e=d.getAttribute("data-id"),f.showContextMenu(c,d,e),a.halt()}},showContextMenu:function(a,b,c){var d,e,f=this;e=f.node.one("#mim-newconversation-contact-list"),d=e.getX()+e.get("offsetWidth")/2,f.contactPlugin.showContactMenu({contact:a,item:b,id:c,leftPos:d,hover:!1,favorites:!1})},handleLogin:function(){},handleLogout:function(){},events:{"mouseenter #mim-newconversation-contact-list > li":"_mouseenter","keydown .mim-newconversation .mim-contact-input":"_handleKey","click #mim-newconversation-contact-list > li":"clickNewConversationList","contextmenu #mim-newconversation-contact-list > li":"handleContextMenu","click .mim-contact-input-clear":"_clearFilter"}}),a.namespace("Messenger.View").NewConversationView=f},"@VERSION@",{requires:["tictac-mim-rollups","tictac-base-view","messenger-contactlist","messenger-ymlutils","tictac-mim-strings","tictac-base-utils","base-bidi","messenger-systemsettings","messenger-constants","messenger-utils","messenger-viewutils","messenger-conversation-css","escape","messenger-abutils","io"]});YUI.add("messenger-message",function(a){"use strict";function b(b){this._yml=b.yml||b.node&&a.Messenger.YMLUtil.domToYml(b.node)||"",this.sender=b.sender,this.receiver=b.receiver,this.fromSelf=b.fromSelf,this.timeStamp=b.timeStamp,this.type=b.type,this.hash=b.hash,this.msgContext=b.msgContext,this.sequence=b.sequence,this.status=b.status,this.mobileno=b.mobileno,this.network=b.network}b.prototype={},b.prototype.constructor=b,b.prototype.html=function(){return this._html||(this._html=a.Messenger.YMLUtil.ymlToHtml(this._yml)),this._html},b.prototype.yml=function(){return this._yml},b.prototype.text=function(){var b=this;if(!b._text)try{b._text=a.Node.create(this.html()).get("text")}catch(c){b._text=""}return b._text},a.namespace("Messenger.Model").Message=b},"@VERSION@",{requires:["messenger-ymlutils"]});YUI.add("messenger-conversation",function(a){"use strict";var b=a.Messenger.Common.Constants,c=b.EVENTS,d={SET_TYPING_STATE:{method:"POST",path:"/v1/message/{{network}}/{{user}}",args:["action=start-typing"]},CLEAR_TYPING_STATE:{method:"POST",path:"/v1/message/{{network}}/{{user}}",args:["action=stop-typing"]},SEND_SMS:{method:"POST",path:"/v1/message/sms/{{number}}"},SEND_MSG:{method:"POST",path:"/v1/message/{{network}}/{{user}}",args:["action=send-message"]},RECENT_MESSAGES_IM:{method:"POST",path:"/v1/message/{{network}}/{{user}}",args:["action=fetch-recent","count=50"]},RECENT_MESSAGES_SMS:{method:"POST",path:"/v1/message/sms/{{number}}",args:["action=fetch-recent","count=50"]}},e=a.Messenger.Common.Utils;a.namespace("Messenger.Model").Conversation=a.Tictac.base.Model.extend({defaults:{user:null,alias:null,network:"yahoo",userTyping:!1,incomingAuth:!1,incomingAuthMessage:"",created:new Date},initialize:function(){var b=this;this.set({messages:[]}),this.on("destroy",function(c,d,e){a.log("Conversation:destroy "),b.set("messages",[]),b._hideTypingTimer&&(b._hideTypingTimer.cancel(),b._hideTypingTimer=null),e.local&&b.close(e)})},request:function(b,c){var d="POST",e="/v1/messages",f=["action="+b,"blocking=0"],g=this.get("user"),h=this.get("alias"),i=this.get("network");a.Messenger.Common.RequestManager.issueRequest({method:d,path:e,args:f,postBody:{convs:[{sender:h,receiver:g,network:i}]},successCallback:a.bind(function(a){c&&c.success&&c.success(a)},this),errorCallback:a.bind(function(a){c&&c.error&&c.error(a)},this)})},ack:function(a){this.request("ack-conv",a)},ackReceived:function(){this.trigger(c.ACK_RECEIVED)},close:function(a){this.request("close-conv",a)},handleError:function(a){this.trigger(b.EVENTS.SMS_ERROR,a.errorCode)},receiveMessage:function(c){var d,e,f,g=this.get("messages");if(c.hash&&("transfer"===c.type||"recent"===c.type))for(d=0,e=g.length;e>d;d++)if(g[d].hash===c.hash)return void a.log("Skipping duplicate state transfer message");var h=new a.Messenger.Model.Message({yml:c.msg,sender:c.sender,receiver:c.receiver,fromSelf:c.echo?!0:!1,timeStamp:1e3*c.timeStamp,network:c.network,type:c.type,hash:c.hash,msgContext:c.msgContext,sequence:c.sequence,status:c.status});g.push(h),f="You have a new MiM message from "+h.sender+'! They say "'+h.yml()+'"',a.log(f),this.set("userTyping",!1),this.trigger(b.EVENTS.MESSAGE,h)},sendMessage:function(b){var c=this,d=new a.Messenger.Model.Message({yml:b,sender:c.get("alias"),receiver:c.get("user"),network:c.get("network"),fromSelf:!0,timeStamp:new Date,type:"im"});c._queueSendRequest(d)},sendSMS:function(b){var c,d,e=this,f=e.get("user"),g=e.get("network")||"sms",h=a.Messenger.Model.ContactList.getInstance(),i=f;c=h.getContact(f,g),i=c.get("normalizedNumber"),d=new a.Messenger.Model.Message({yml:b,sender:e.get("alias"),network:g,receiver:f,fromSelf:!0,timeStamp:new Date,type:"sms",mobileno:i}),e._queueSendRequest(d)},_queueSendRequest:function(a){var c,d,f,g,h=this;d=h.get("messages"),h.messageQueue||(h.messageQueue=[]),d.push(a),g=h.get("alias"),c={convId:e.getConversationId(g,h.get("user"),h.get("network")),txnId:[g,(new Date).getTime(),Math.floor(9*Math.random()+1)].join("~"),message:a.yml(),sendAs:g},f={network:h.get("network"),user:h.get("user"),body:c,type:a.type,mobileno:a.mobileno},h.messageQueue.push(f),1===h.messageQueue.length&&h.sendNextMessage(),h.trigger(b.EVENTS.MESSAGE,a)},handleTypingNotification:function(b){if(this.set({userTyping:!!b.activity}),this._hideTypingTimer&&(this._hideTypingTimer.cancel(),this._hideTypingTimer=null),b.activity){var c=12e3;this._hideTypingTimer=a.later(c,this,function(){this.handleTypingNotification({activity:!1})})}},sendTypingNotification:function(b){var c=b?d.SET_TYPING_STATE:d.CLEAR_TYPING_STATE,e=b?{action:"start-typing"}:{action:"stop-typing"},f=a.Messenger.Common.Utils;e.sendAs=this.get("alias"),a.Messenger.Common.RequestManager.issueRequest({method:c.method,args:c.args,path:f.substitute(c.path,{user:encodeURIComponent(this.get("user")),network:this.get("network")||"yahoo"}),postBody:e})},sendNextMessage:function(){if(0!==this.messageQueue.length){var b,c,f,g,h=this,i=this.messageQueue[0];"sms"===i.type?(b=d.SEND_SMS,f=e.substitute(b.path,{number:encodeURIComponent(i.mobileno)})):(b=d.SEND_MSG,g=b.args,f=e.substitute(b.path,{network:i.network,user:encodeURIComponent(i.user)})),c=b.method,g=b.args,a.Messenger.Common.RequestManager.issueRequest({method:c,path:f,args:g,postBody:i.body,successCallback:function(){h.messageQueue.shift(),h.sendNextMessage()},errorCallback:function(a){h.messageQueue.shift(),h.sendNextMessage(),h.handleSendMessageError(a&&a.error)}})}},handleSendMessageError:function(a){this.trigger(c.SEND_ERROR,{errorCode:a})},loadRecentMessages:function(b){var c,f,g,h=this,i=h.get("user"),j=h.get("network")||"yahoo",k=a.Messenger.Model.ContactList.getInstance();"sms"===b?(c=k.getContact(i,j),f=d.RECENT_MESSAGES_SMS,g=e.substitute(f.path,{number:encodeURIComponent(c.get("mobileno"))})):(f=d.RECENT_MESSAGES_IM,g=e.substitute(f.path,{user:encodeURIComponent(i),network:encodeURIComponent(j)})),a.Messenger.Common.RequestManager.issueRequest({path:g,args:f.args,method:f.method})}})},"@VERSION@",{requires:["messenger-requestmanager","messenger-message","tictac-base-model","messenger-utils","messenger-contactlist","messenger-constants"]});YUI.add("messenger-conversationlist",function(a){"use strict";var b,c=a.Messenger.Common.RequestManager,d=a.Messenger.Model.Session,e=a.Messenger.Common.Utils;b=Backbone.Collection.extend({model:a.Messenger.Model.Conversation,initialize:function(){var b=this;c.addListeners([{id:"message",callback:a.bind(b.parseMessage,b)},{id:"rttIm",callback:a.bind(b.rttIm,b)},{id:"typing",callback:a.bind(b._typingNotificationReceived,b)},{id:"offlineMessage",callback:a.bind(this._processOfflineMessages,this)},{id:"sms",callback:a.bind(this._processIncomingSMS,this)},{id:"recentMessages",callback:a.bind(this._processRecentMessages,this)},{id:"imSession",callback:a.bind(function(a){a.sessioninfo=[{network:a.network||"yahoo",sender:a.sender,receiver:a.receiver,messageCount:a.messageCount}],this._processIMSessions(a)},this)},{id:"imSessions",callback:a.bind(this._processIMSessions,this)},{id:"stateTransfer",callback:a.bind(this._processStateXfer,this)}]),d.on("change:conversations",this.parseConversationsData,this)},newConversation:function(a){return this.add(a),this.get(a.id)},getConversation:function(a){return this.get(a.id)||this.newConversation(a)},_processIncomingSMS:function(a){a.type="sms",this.parseMessage(a)},_processRecentMessages:function(a){var b,c,e,f=a.messageList;if(!a.errorCode)for(b=0,c=f.length;c>b;b++)e=f[b].message,e.echo=d.isMyself(e.sender)?!0:!1,e.type="recent",this.parseMessage(e)},rttIm:function(b){return b.cliData&&(b.cliData=a.JSON.parse(b.cliData)),b.hasOwnProperty("msg")?this.parseMessage(b):b.hasOwnProperty("message")?(b.msg=b.message,b.timeStamp=b.timeStamp/1e3,delete b.message,this.parseMessage(b)):void 0},parseMessage:function(b){b.echo|=b.fbecho;var c,d,f,g,h,i,j=a.Messenger.Model.ContactList.getInstance(),k=a.Messenger.Model.UserSettings,l=b.echo?b.sender:b.receiver,m=b.echo?b.receiver:b.sender,n=b.network||"yahoo";if("yahoo"===n){if("sms"===b.type){if(c=j.where({normalizedNumber:m}),c.length)if(1===c.length)d=c[0];else{for(f=0,g=c.length;g>f;f++)if(this.get(e.getConversationId(l,c[f].get("user"),c[f].get("network")))){d=c[f];break}d=d||c[0]}else n="sms";d&&(m=d.get("user"),n=d.get("network"),b.echo?b.receiver=m:b.sender=m,b.network=n)}return h=e.getConversationId(l,m,n),b.user=m,b.network=n,b.alias=l,b.type=b.type||"im",b.timeStamp||(b.timeStamp=(new Date).getTime()/1e3),k.getPreference("mimBlockNonContacts")&&(d=j.getContact(m,n),"unknown"===d.get("type"))?void a.log("Ignoring message from "+m+" because we are blocking non-contacts","debug"):(i=this.getConversation({id:h,alias:l,user:m,network:n,timeStamp:b.timeStamp}),"sms"===b.type&&b.errorCode&&i.handleError?i.handleError(b):i.receiveMessage(b),i)}},_typingNotificationReceived:function(b){var c=e.getConversationId(b.receiver,b.sender,b.network),d=this.get(c);return d?void d.handleTypingNotification(b):void a.log("No ongoing conversation with the user: "+b.sender)},_processOfflineMessages:function(a){var b,c,d,e=a.messages;for(b=0,c=e.length;c>b;b++)d=e[b].message,d.type="offline",this.parseMessage(d)},_processStateXfer:function(a){var b,c,d,e=a.messageList;for(b=0,c=e.length;c>b;b++)e[b].message&&(d=e[b].message,d.type="transfer",this.parseMessage(d))},_processIMSessions:function(a){var b,c,d,f,g,h,i,j=a.sessionInfo,k=j.length;for(b=0;k>b;b++)g=j[b],d=g.sender,c=g.receiver,f=g.network||"yahoo",h=e.getConversationId(d,c,f),i=this.get(h),i&&(3===a.state?i.ackReceived():2===a.state&&i.destroy())}}),a.namespace("Messenger.Model").ConversationList=new b},"@VERSION@",{requires:["messenger-conversation","messenger-session","messenger-usersettings","messenger-contactlist"]});"use strict";YUI.add("messenger-addrequestview",function(a){var b,c=a.Tictac.mim.rollups,d=a.Messenger.Common.Utils,e=a.Messenger.Model.ContactList.getInstance(),f=a.Messenger.Common.Stats,g={length:0},h=a.Messenger.View.ViewUtils;b=a.Tictac.base.View.extend({initialize:function(){var a=this;a.set("unreadCount",0),a.on("show",a._onShow,a)},createDOMNode:function(){var b,e=this,f=this.options.session,i=this.options.addRequests;return _.each(i,function(a){var b=d.getUserId(a.user,a.network);a.id=b,g[b]=a,g.length++,e.set("unreadCount",e.get("unreadCount")+1)}),b=a.Node.create(c.addrequests({presenceName:h.getPresenceName(f.get("presenceState")),presenceClassName:h.getBuddyIconClass(f.get("presenceState")),presenceMessage:d.normalizePresenceMessage(f.get("presenceMessage")),contacts:i}))},postRender:function(){f.stat("group_add"),this._ulNode=this.node.one(".mim-addreq-container"),this.isVisible()&&this.set("unreadCount",0),this.options.ContactList&&(e=this.options.ContactList)},_onShow:function(){this.isVisible()&&this.set("unreadCount",0)},onDestroy:function(){},getId:function(){return"addrequests"},close:function(){this.destroy()},events:{"click .mim-addreq-container button":"_handleIndividualAction","click .mim-block-all-btn":"_handleBlockAll"},_handleBlockAll:function(){var a,b,c;f.stat("group_add_block_all");for(c in g)g.hasOwnProperty(c)&&-1!==c.indexOf("~")&&(a=g[c],b=e.getContact(a.user,a.network),b.sendAddResponse({accept:!1,alias:a.alias}),b.ignoreUser(),this.node.one('li[data-id="'+c+'"]').remove(),delete g[c]);this.close()},_handleIndividualAction:function(a){var b=a.currentTarget.ancestor("li.mim-addreq-contact"),c=g[b.getData("id")],d=e.getContact(c.user,c.network);a.currentTarget.hasClass("mim-im-btn")?(f.stat("group_add_im"),this.trigger("openConversation",{contact:d})):a.currentTarget.hasClass("mim-decline-btn")?(f.stat("group_add_decline"),d.sendAddResponse({accept:!1,alias:c.alias}),b.remove(),g.length--):a.currentTarget.hasClass("mim-block-btn")?(f.stat("group_add_block"),d.sendAddResponse({accept:!1,alias:c.alias}),d.ignoreUser(),b.remove(),g.length--):(f.stat("group_add_accept"),d.sendAddResponse({accept:!0,alias:c.alias}),b.remove(),g.length--),g.length<=0&&this.close()}}),a.namespace("Messenger.View").AddRequestView=b},"@VERSION@",{requires:["tictac-mim-rollups","tictac-base-view","messenger-contactlist","messenger-ymlutils","tictac-mim-strings","tictac-base-utils","base-bidi","messenger-utils","messenger-viewutils","messenger-conversation-css","messenger-stats"]});"use strict";YUI.add("messenger-conversationlistview",function(a){var b,c=a.Tictac.mim.rollups,d=a.Messenger.Common.Utils,e=a.Messenger.View.ViewUtils,f=a.Tictac.mim.strings,g=a.Messenger.Common.Constants,h=a.Messenger.Model.UserSettings,i=a.Messenger.Common.Stats,j=g.EVENTS,k=a.Messenger.Model.SystemSettings,l="new",m="addrequests",n={top:e.getWindowHeight()-150+"px",left:k.get("isRTL")?+e.getWindowSize().width-150+"px":"150px",opacity:0,width:"50px",height:"50px"},o=a.Messenger.Model.ContactList.getInstance(),p=a.Tictac.base.utils.transitionEndEventName();b=a.Tictac.base.DialogView.extend({hideButtons:!0,hideClose:!0,modal:!1,initialize:function(){function b(c){function d(a){var b=a.currentTarget;h.showNewConversation(b.getAttribute("data-mode")||"im")}if(c=c||0,!(c>30)){if(l=a.one("#menu-new"),!l)return void a.later(100,null,b,++c);f=l.all('[data-action="new-conv"]'),2===f.size()&&(f.item(0).setAttribute("data-mode","im"),f.item(1).setAttribute("data-mode","sms")),h._listeners.push(l.delegate("click",d,'[data-action="new-conv"]'))}}function c(a){var b=a.currentTarget;b.hasClass("sms")?h.showNewConversation("sms"):b.hasClass("im")&&h.showNewConversation("im")}function d(b,c){var d,e;if(c=c||"im",b&&b.id)if("sms"===c)d=o.where({mobileno:b.id}),d.length?h.showConversation(d[0].get("user"),d[0].get("network"),null,c):h.showConversation(b.id,"sms",null,c);else{if(-1!==b.id.indexOf("@")){if(e=a.Messenger.Common.ABUtils.extractYidFromEmail(b.id),!e||!e.id)return;b.id=e.id,b.network=e.network}h.showConversation(b.id,b.network||"yahoo",null,c)}}var f,h=this,k=a.Messenger.Model.Session,l=a.one("#toolbar #btn-new a"),m=a.one("#msg-preview");h.conversationViews={},h.visibleConvID=null,h.collection.on(g.EVENTS.MESSAGE,h._processMessage,h),h.collection.on("change:userTyping",h._processTypingNotification,h),h.collection.on("add",h._processAddRequest,h),o.on(j.ADD_REQUEST_RECEIVED,h.handleAddRequest,h),k.on("change:presenceState",h._handlePresenceChange,h),a.on("keydown",function(b){var c=b.altKey||b.ctrlKey||b.metaKey;if(!c&&!e.isInputNode(b.target)){if(73===b.keyCode)return i.stat("im",{type:"shortcut_i"}),i.stat("frnd"),k.login(null,a.bind(h.showNewConversation,h),a.bind(h.showNewConversation,h)),b.halt(),!1;if(84===b.keyCode)return i.stat("sms",{type:"shortcut_t"}),h.showNewConversation("sms"),b.halt(),!1}},a.UA.ie?document:window),l&&l.once("click",b),m&&h._listeners.push(m.delegate("click",c,"#msg-preview-media-modes span a")),window.yui&&(h._listeners.push(yui.on("contacts:sendIM",d)),h._listeners.push(yui.on("chats:sendIM",d)),h._listeners.push(yui.on("contacts:sendSms",function(a){d(a,"sms")})),h._listeners.push(yui.on("chats:sendSms",function(a){d(a,"sms")}))),h._addReqs=[]},onDestroy:function(){var b=this,c=a.Messenger.Model.Session;b.off("stopResize",b._onStopResize,b),b.off("stopMove",b._onStopMove,b),b.collection.off(g.EVENTS.MESSAGE,b._processMessage,b),b.collection.off("change:userTyping",b._processTypingNotification,b),b.collection.off("add",b._processAddRequest,b),o.off(j.ADD_REQUEST_RECEIVED,b.handleAddRequest,b),c.off("change:presenceState",b._handlePresenceChange,b)},renderContent:function(b){b.ancestor(".modal").addClass("mim-conversations"),b.append(a.Node.create(c.conversationlist()))},postRender:function(){var b=this,c=e.getWindowSize(),d=a.Messenger.Neo.yui,f=h.getPreference("mimConvWinSizePref"),g=h.getPreference("mimConvWinSizePrefOld"),i=h.getPreference("mimConvWinPosPref");if(this.listNode=this.node.one("ul.mim-conversations-list"),this.tabNode=this.node.one("ul.mim-conversations-tabs"),this.tabNode&&(this._overflowButton=this.tabNode.one(".mim-overflow-tab"),this._addButton=this.tabNode.one(".mim-new-tab")),this.on("resize",function(){b._makeConversationTabVisible(),b._checkTabOverflow()}),"string"==typeof f)try{f=JSON.parse(f)}catch(j){}if("string"==typeof i)try{i=JSON.parse(i)}catch(j){}f.width===g.width&&(f.width=300),f?("string"==typeof f.width&&(f.width=parseInt(f.width,10),isNaN(f.width)&&(f.width=0)),"string"==typeof f.height&&(f.height=parseInt(f.height,10),isNaN(f.height)&&(f.height=0)),f.width=Math.max(250,f.width),f.height=Math.max(250,f.height)):f={width:300,height:350},this.node.setStyles({width:f.width+"px",height:f.height+"px"}),i||(i={right:200,bottom:20}),this.node.setStyles({bottom:i.bottom+"px",right:i.right+"px"}),this.on("change:unreadCount",this._handleNewMsgNotification,this),this.on("change:minimized",this._handleConvMinMax,this),this._handleNewMsgNotification(this),this.options.minimized!==!1?(this.minimize(),this._viewStyles={top:c.height-(~~f.height+~~i.bottom)+"px",left:c.width-(~~f.width+~~i.right)+"px",opacity:1,width:f.width+"px",height:f.height+"px"}):this.set("minimized",!1),this.on("stopResize",this._onStopResize,this),this.on("stopMove",this._onStopMove,this),this.on("hide",this._onHide,this),d.on("nav:messenger",this._onActivate,b)},_toggleHideCurrentView:function(a){var b=this.conversationViews[this.visibleConvID];b&&(a?b.hide():(b.show(),this._switchConversationTab(this.visibleConvID)))},_onActivate:function(){this.get("minimized")&&(i.stat("window_maximize"),this.maximize())},_onStopResize:function(){var a=this,b=a.node.get("region");h.setPreference("mimConvWinSizePref",{width:b.width,height:b.height}),a._onStopMove()},_onStopMove:function(){var a,b=this,c=b.node.get("region"),d=e.getWindowSize();k.get("isRTL")&&b.node.setStyles({right:e.getWindowSize().width-c.right+"px",left:"auto"}),h.setPreference("mimConvWinPosPref",{right:d.width-c.right,bottom:d.height-c.bottom}),h.save(),null!==(a=b.visibleConvID)&&b.conversationViews[a]&&b.conversationViews[a].focus()},_onHide:function(){this.set("minimized",!0)},close:function(a,b){if(!a||!a.type||"keydown"!==a.type||13===a.keyCode){var c=this;return i.stat("window_close"),!b&&this.get("unreadCount")?void e.confirm({message:f.str_conv_close_confirm,callback:function(){c.close(a,!0)}}):void c.minimize()}},minimize:function(a){if(!a||"undefined"==typeof a.type||"click"===a.type||13===a.keyCode){var b=this;if(b.get("minimized"))return;b.tabNode&&b.tabNode.addClass("mim-overflow-hidden"),b._toggleHideWindow(!0,function(){b._toggleHideCurrentView(!0),a&&"function"==typeof a?a():a&&a.halt&&i.stat("window_minimize")}),b.set("minimized",!0)}},maximize:function(){var a=this;a.get("minimized")&&(a._toggleHideWindow(!1,function(){var b=a.node.get("region");a._checkTabOverflow(),a._toggleHideCurrentView(!1),k.get("isRTL")&&a.node.setStyles({right:e.getWindowSize().width-b.right+"px",left:"auto"}),a.visibleConvID||a.showNewConversation(),a.tabNode&&a.tabNode.removeClass("mim-overflow-hidden"),a.visible=!0,e.bringToFront(a.node),e.limitToViewport(a.node)}),a.set("minimized",!1))},_toggleHideWindow:function(b,c){function d(){p&&h.removeEventListener(p,d),b&&g.addClass("hidden"),c&&c()}var f=this,g=f.node,h=g.getDOMNode(),i=".nav-item-messenger",j={},l=["top","left","opacity","width","height"];b?(f._viewStyles={},g.setStyle("top",g.get("offsetTop")+"px"),g.setStyle("left",g.get("offsetLeft")+"px"),n.top=a.one(i).get("region").top+"px",k.get("isRTL")&&(n.left=+e.getWindowSize().width-150+"px",g.setStyles({bottom:"auto",right:"auto"})),_.each(l,function(a){f._viewStyles[a]=g.getStyle(a)}),_.extend(j,n)):(g.removeClass("hidden"),g.setStyle("top",a.one(i).get("region").top+"px"),k.get("isRTL")&&(n.left=+e.getWindowSize().width-150+"px"),_.extend(j,n,f._viewStyles)),p&&"undefined"!=typeof f.get("minimized")&&h.addEventListener(p,d),g.setStyles(j),p||window.setTimeout(d,0)},_updateUnreadCount:function(){var a,b=0;for(a in this.conversationViews)this.conversationViews.hasOwnProperty(a)&&this.conversationViews[a].get("unreadCount")&&(b+=this.conversationViews[a].get("unreadCount"));this.set("unreadCount",b)},_addConversation:function(b,c,e,f,g){var h,i,k,l,m,n=this,p=n.collection,q=a.Messenger.Model.Session,r=a.Messenger.View.ConversationView;return c=c||"yahoo",h=o.get(d.getUserId(b,c)),i=h?h.get("displayName"):b,e=e||q.get("loggedInId"),k=d.getConversationId(e,b,c),m=n.conversationViews[k],m?m.set("mode",f):((l=p.get(k))||(p.add({id:k,user:b,network:c,alias:e},{silent:!0}),p.trigger(j.CONVERSATION_INIT,{id:k,user:b,network:c}),l=p.get(k)),f=f||"im",m=new r({parent:n.listNode,container:'<li class="mim-conversations-conversation hidden"></li>',model:l,mode:f,limitToViewport:!1,keyEvents:[{keyCode:219,metaCtrlKey:!0,callback:a.bind(n.togglePrevConv,n),halt:!0},{keyCode:221,metaCtrlKey:!0,callback:a.bind(n.toggleNextConv,n),halt:!0},{keyCode:9,shiftKey:!0,halt:!0,callback:function(a){var b=n.node.one('a[data-action="emoticons"]');a&&a.blur&&a.blur(),b&&b.focus&&b.focus()}},{keyCode:9,shiftKey:!1,callback:function(){(a.UA.ie?document:window).focus()}}],initiatedByMe:g}),n.conversationViews[k]=m,m.render(),n._addConversationTab(k,i,b),m.on("destroy",function(){n._conversationViewDestroyed(k)},n),m.on("change:unreadCount",function(a){n._updateTabBadge(a.getId()),n._updateUnreadCount()}),m.on(j.DISPLAYNAME_UPDATED,this._updateTabLabel,this)),m},_delegateAddRequest:function(){var a,b,c=this;c._addReqs&&c._addReqs.length&&(c._addReqs.length>1?c._addRequestView():(b=c._addReqs[0],a=this.addConversation(b.user,b.network,b.alias),a&&a.showAuthorizationILN(b.msg)),c._addReqs=[])},_addRequestView:function(){var b=this,c=m,d=a.Messenger.View.AddRequestView,e=a.Messenger.Model.Session,g=b.conversationViews[c];g||(g=new d({parent:b.listNode,container:'<li class="mim-conversations-conversation hidden"></li>',addRequests:b._addReqs,limitToViewport:!1,session:e}),b.conversationViews[c]=g,g.render(),b._addConversationTab(m,f.str_conv_add_requests),b._updateTabBadge(c),b.visibleConvID||b._showExistingConversationView(g),b._updateUnreadCount(),g.on("change:unreadCount",function(a){b._updateTabBadge(a.getId()),b._updateUnreadCount()}),g.on("openConversation",function(a){a.contact&&b.showConversation(a.contact.get("user"),a.contact.get("network"),a.contact.get("alias"))}),g.on("destroy",function(){b._conversationViewDestroyed(c)},b))},_newConversation:function(b){var c,d,e=this,f=a.Messenger.Model.Session,g=a.Messenger.View.NewConversationView;return b=b||"im",c=l,d=e.conversationViews[c],d?d.set("mode",b):(d=new g({parent:e.listNode,container:'<li class="mim-conversations-conversation hidden"></li>',collection:o,limitToViewport:!1,conversationWindow:e,session:f,mode:b}),e.conversationViews[c]=d,d.on("escKeyDown",function(){var b=a.Object.size(e.conversationViews);1===b?e.close():e.togglePrevConv()}),d.render(),d.on("destroy",function(){e._conversationViewDestroyed(c)},e)),d},togglePrevConv:function(){this._toggleConv("prev")},toggleNextConv:function(){this._toggleConv("next")},_toggleConv:function(a){var b,c,d=_.keys(this.conversationViews),e=this.visibleConvID,f=_.indexOf(d,e);b="prev"===a?f>0?f-1:f=d.length-1:f>d.length-2?f=0:f+1,c=this.conversationViews[d[b]],this._showExistingConversationView(c)},_addConversationTab:function(b,e,g){var h=this._addButton?2:1,i=a.Node.create(c.conversationtab({convId:b,displayTitle:e===g||b===m?e:d.substitute(f.str_session_title_order,{displayName:e,user:g}),displayName:e}));h=1,this.tabNode.insert(i,h),this._checkTabOverflow()},_removeConversationTab:function(a){var b=this.tabNode.one('[data-id="'+a+'"]');b&&b.remove(),this._checkTabOverflow()},_makeConversationTabVisible:function(a){a||(a=this.tabNode.one('[data-id="'+this.visibleConvID+'"]')),a&&a.hasClass("mim-overflowing")&&(a.removeClass("mim-overflowing"),this.tabNode.removeChild(a),this.tabNode.prepend(a))},_switchConversationTab:function(a,b){var c=this.tabNode.one(".active"),d=this.tabNode.one('[data-id="'+a+'"]');c&&(c.removeClass("active"),c.removeClass("tt-active-tab-bg"),c.removeClass("mim-has-msg"),c.addClass("tt-inactive-tab-bg")),d&&(d.addClass("active"),d.addClass("tt-active-tab-bg"),d.removeClass("tt-inactive-tab-bg"),d.removeClass("mim-has-unread"),this._makeConversationTabVisible(d)),b||this._checkTabOverflow(),this._updateOverflowTabBadge()},_updateTabBadge:function(a){var b=this.conversationViews[a],c=this.tabNode.one('[data-id="'+a+'"]'),d=b.get("unreadCount");d?(c.one(".mim-msg-badge").setHTML(d),c.addClass("mim-has-msg")):c.removeClass("mim-has-msg"),this._updateOverflowTabBadge()},_updateTabLabel:function(a,b){var c,d=this.tabNode.one('[data-id="'+a+'"]');d&&(c=d.one(".mim-contact-name"),c.setAttribute("title",b),c.setHTML(b),this._checkTabOverflow())},_updateOverflowTabBadge:function(){var a,b=this.tabNode.all(".mim-overflowing.mim-has-msg .mim-msg-badge"),c=0;b.each(function(b){a=~~b.getHTML(),"number"==typeof a&&(c+=a)}),c>0?(this._overflowButton.one(".mim-msg-badge").setHTML(c),this._overflowButton.addClass("mim-has-msg")):this._overflowButton.removeClass("mim-has-msg")},_checkTabOverflow:function(){var b,c,d,e,f=this.tabNode.all(".mim-conv-tab"),g=f.size(),h=80,i=0,j=this.node.get("offsetWidth");this._addButton&&(j-=this._addButton.get("offsetWidth")),f.setStyle("width","auto"),this.tabNode.removeClass("mim-has-overflow"),this.tabNode.all(".mim-overflowing").removeClass("mim-overflowing"),0!==j&&(d=f.get("offsetWidth"),d&&0!==d.length&&(i=_.reduce(d,function(a,b){return a+b}),j>=i?a.log("No overflow nor any tab size adjustment!"):j>=g*h?(i=h*g,e=~~((j-i)/d.length),f.setStyle("width",h+e+"px")):(this.tabNode.addClass("mim-has-overflow"),j-=this._overflowButton.get("offsetWidth"),c=~~(j/h),b=f.slice(0,c),b.removeClass("mim-overflowing"),f.slice(c,g).addClass("mim-overflowing"),i=h*c,e=~~((j-i)/c),b.setStyle("width",h+e+"px"))))},addConversation:function(a,b,c){var d=this._addConversation(a,b,c);return this.visibleConvID||this._showExistingConversationView(d),d},showConversation:function(b,c,d,e,f){var g=this,h=a.Messenger.Model.Session;h.login(null,function(){var a=g._addConversation(b,c,d,e,f);g._showExistingConversationView(a),g.maximize()})},showNewConversation:function(a){var b=this,c=b._newConversation(a);b._showExistingConversationView(c),b.maximize()},_showExistingConversationView:function(a){var b=a.getId(),c=this.visibleConvID&&this.conversationViews[this.visibleConvID];c&&c.hide(),this.get("minimized")||(a.show(),a._timeShown=new Date),this._switchConversationTab(b),this.visibleConvID=b,this.isVisible()||this.get("minimized")||this.show()},_conversationViewDestroyed:function(a){this._removeConversationTab(a),delete this.conversationViews[a],a===this.visibleConvID&&(this.visibleConvID=null),this._updateUnreadCount(),this._showPriorConversation()},_showPriorConversation:function(){var a,b="new"!==this.visibleConvID;_.each(this.conversationViews,function(c){"new"!==c.getId()&&(b=!1),(!a||c._timeShown>a._timeShown)&&(a=c)}),a&&!b?this._showExistingConversationView(a):this._handleNewTab()},_processMessage:function(a){var b=a.fromSelf?a.receiver:a.sender,c=a.network,e=a.fromSelf?a.sender:a.receiver,f=d.getConversationId(e,b,c),g=this.conversationViews[f];g?g.renderMessage(a):this.addConversation(b,c,e),this._updateTabBadge(f)},_processTypingNotification:function(a){var b=a.get("id"),c=this.conversationViews[b];c.setTypingNotification(a.get("userTyping"))},_processAddRequest:function(a){this.addConversation(a.get("user"),a.get("network"),a.get("alias"))},handleAddRequest:function(b){i.stat("add"),this._addReqs.push(b),window.setTimeout(a.bind(this._delegateAddRequest,this),1e3)},_closeConversationEventHandler:function(a,b){var c=a.currentTarget.ancestor("[data-id]"),d=c.getAttribute("data-id"),g=this.conversationViews[d],h=this;return a.halt(),g.get("unreadCount")&&!b?void e.confirm({message:f.str_conv_tab_close_confirm,callback:function(){h._closeConversationEventHandler(a,!0)}}):void g.close()},_handleTabSwitch:function(b){if(!b.target.hasClass("btn-close-conversation")){var c=b.currentTarget,d=c.getAttribute("data-id"),f=this.conversationViews[d];this._showExistingConversationView(f),this._handleTabOverflow(),a.later(0,null,function(){e.triggerAds("978500262")})}},_handleTabOverflow:function(b){var c,d=this,e=a.UA.ie?document:window,f=this._overflowContainer,g=this._overflowButton;f||(this._overflowContainer=this.node.one(".mim-overflow-tabs"),f=this._overflowContainer),void 0!==b&&f.hasClass("hidden")?(c=d.tabNode.all("li.mim-overflowing"),f.empty().removeClass("hidden"),g&&g.addClass("mim-selected"),c.each(function(a){f.append(a.cloneNode(!0).removeClass("tt-inactive-tab-bg"))}),f.removeClass("hidden"),a.later(0,null,function(){d._overflowMenuListener=a.on("click",function(a){a.target.ancestor(".mim-menu.mim-overflow-tabs",!0)||d._handleTabOverflow()},e)})):(f.addClass("hidden"),g&&g.removeClass("mim-selected"),d._overflowMenuListener&&d._overflowMenuListener.detach())},_handlePresenceChange:function(a){a.get("presenceState")===g.STATE.OFFLINE?_.each(this.conversationViews,function(a){a.handleLogout&&a.handleLogout()}):(a.previous("presenceState")===g.STATE.OFFLINE||a.previous("presenceState")===g.STATE.PENDING)&&_.each(this.conversationViews,function(a){a.handleLogin&&a.handleLogin()})},_handleNewTab:function(){i.stat("window_plus"),this.showNewConversation()},_handleNewMsgNotification:function(b){var c=a.one(".nav-item-messenger");c&&e.showNewMsgNotification(b,c)},_handleConvMinMax:function(b){var c=a.one(".nav-item-messenger");c&&e.handleConvMinMax(b,c)},events:{'click [data-action="closeconversations"]':"close",'keydown [data-action="closeconversations"]':"close",'click [data-action="hideconversations"]':"minimize",'keydown [data-action="hideconversations"]':"minimize",'click [data-action="closeconversation"]':"_closeConversationEventHandler","click li.mim-conv-tab":"_handleTabSwitch","click li.mim-overflow-tab":"_handleTabOverflow","click li.mim-new-tab":"_handleNewTab"}}),a.namespace("Messenger.View").ConversationListView=b},"@VERSION@",{requires:["tictac-mim-rollups","tictac-base-dialogview","tictac-base-utils","messenger-utils","messenger-viewutils","messenger-conversationview","messenger-newconversationview","messenger-conversationlist","messenger-conversationlist-css","messenger-addrequestview","tictac-mim-strings","messenger-session","messenger-usersettings","messenger-stats","messenger-contactlist","messenger-abutils","messenger-systemsettings","messenger-constants"]});"use strict";YUI.add("messenger-ssp",function(a){var b={SSP_SET:{method:"PUT",path:"/v1/preferences"},SSP_GET:{method:"GET",path:"/v1/preferences"}},c={mimEnableSSA:"server.archive.enable"},d={},e=a.Tictac.mim.strings;a.Messenger.Common.SSPUserPreferences=function(){return{_dirtyPrefs:{},async:!0,get:function(e,f){var g=b.SSP_GET,h=["pref="+c[e]||e];d[e]||(d[e]=!0,a.Messenger.Common.RequestManager.issueRequest({type:"SSP_GET",server:"ssp",args:h,retries:5,method:g.method,path:g.path,successCallback:function(a){var b=a&&a.preferences?a.preferences[0].preference.value[0]:null;"1"===b?b=!0:"0"===b&&(b=!1),f(b),delete d[e]},errorCallback:function(){delete d[e],a.log("Error reading the SSP preference for key "+e)}}))},set:function(a,b){this._dirtyPrefs[a]=b},save:function(d){var f={preferences:[]},g={preference:{}},h=b.SSP_SET;_.isEmpty(this._dirtyPrefs)?d():(a.each(this._dirtyPrefs,function(a,b){a===!0?a="1":a===!1&&(a="0"),g.preference.key=c[b]||b,g.preference.value=[],g.preference.value.push(a)}),f.preferences.push(g),this._dirtyPrefs={},a.Messenger.Common.RequestManager.issueRequest({type:"SSP_SET",server:"ssp",postBody:f,retries:5,method:h.method,path:h.path,successCallback:function(){d()},failureCallback:function(){d(e.str_msgr_server_error_1)}}))}}}()},"@VERSION@",{requires:["messenger-requestmanager","tictac-mim-strings"]});"use strict";YUI.add("messenger-optionsview",function(a){var b=a.Messenger.Model.UserSettings,c=a.Messenger.Model.SystemSettings,d=a.Messenger.Common.Constants,e=a.Messenger.Common.Stats,f=a.Tictac.mim.strings,g=a.Tictac.mim.rollups,h=a.Messenger.Common.Utils,i=a.Messenger.Model.Session;a.namespace("Messenger.View").OptionsView=a.Tictac.base.View.extend({title:f.str_branding_messenger_generic,initialize:function(){this.on("show",this._onShow,this),this.on("hide",this._onHide,this),this._nodeListeners=[]},onDestroy:function(){for(;this._nodeListeners.length;)this._nodeListeners.pop().detach();i.off("change:presenceState",this._handlePresenceChange,this)},createDOMNode:function(){var d=b.getPreference("mimLogoutPref"),e=c.get("smsEnabled"),h=a.Node.create(g.options({title:f.str_menu_messenger_options,showButtons:!0,localSelected:"local"===d?!0:!1,globalSelected:"global"===d?!0:!1,promptSelected:"prompt"===d?!0:!1,enableSounds:b.getPreference("mimEnableSounds"),showOnlyBuddies:b.getPreference("mimShowOnlyBuddies"),smsEnabled:e,countries:e?a.Messenger.View.ViewUtils.getPhoneCountries():[]}));return h.addClass("mim-options-view hidden"),h},postRender:function(){var a=this;a.node.one("#mim-addBlockedUserButton").on("click",a.showAddIgnoreDialog,a),a.node.one("#mim-removeBlockedUserButton").on("click",a.removeIgnoredUsers,a),a._nodeListeners.push(this.node.one("#mim-blockNonBuddies").on("change",function(b){a._setIgnoreListDisabledState(b.target.get("checked"))})),a._nodeListeners.push(this.node.one("#mim-blockSelected").on("change",function(b){a._setIgnoreListDisabledState(!b.target.get("checked"))}))},removeIgnoredUsers:function(){var b,c,d,e,f=this.node.one("#mim-blocklist").all("option"),g=a.Messenger.Model.ContactList.getInstance();f.each(function(a){a.get("selected")&&(b=a.getAttribute("value").split("~"),c=b[0],d=b[1],e=g.getContact(c,d),e.unignoreUser(),a.remove(!0))})},showAddIgnoreDialog:function(){var b=a.Messenger.View.ViewUtils,c=a.Messenger.Model.ContactList.getInstance(),d=this;b.confirm({callback:function(e){var g,i=e["mim-ignore-user"],j="yahoo";return i?i.length<4||i.length>32?h.substitute(f.str_cont_add_contact_error_invalid_id,{user:a.Escape.html(i),network:j}):(g=c.getContact(i,j),void g.ignoreUser({success:function(){d._populateIgnoreList()},err:function(a){"unknown"===g.get("type")&&c.remove(g.id),b.alert({message:b.convertErrorCodeToMessage(a.error.code)})}})):f.str_conv_error_empty_general},title:f.str_conv_btn_block_user,message:g.addignore()})},_onShow:function(){var c=this;e.stat("options"),c._populateIgnoreList(),b.getPreference("mimBlockNonContacts")?(c.node.one("#mim-blockNonBuddies").getDOMNode().checked=!0,c._setIgnoreListDisabledState(!0)):(c.node.one("#mim-blockSelected").getDOMNode().checked=!0,c._setIgnoreListDisabledState(!1)),b.getPreference("mimEnableSSA",function(a){var b=c.node.one("#mim-enableSSACheckbox");b.removeAttribute("disabled"),a?b.setAttribute("checked","checked"):b.removeAttribute("checked")}),i.on("change:presenceState",c._handlePresenceChange,c),a.later(0,null,function(){c._focusOnLogoutSelect()})},_focusOnLogoutSelect:function(){var a=this.node.one("#mim-logoutSelect");a&&a.focus()},_populateIgnoreList:function(){var b,c,d,e,f,g=a.Messenger.Model.ContactList.getInstance(),i=g.where({ignored:!0}),j=this.node.one("#mim-blocklist"),k='<option value="{{id}}">{{user}}</option>';for(j.setHTML(""),b=0,c=i.length;c>b;b++)e=i[b].get("user"),f=i[b].get("network"),d=a.Node.create(h.substitute(k,{id:h.getUserId(e,f),user:e})),j.append(d)},_onHide:function(){var b=a.Messenger.Model.Session;b.off("change:presenceState",this._handlePresenceChange,this)},_handlePresenceChange:function(a){this._setIgnoreListDisabledState(a.get("presenceState")===d.STATE.OFFLINE)},_setIgnoreListDisabledState:function(b){var c=this.node.one("#mim-blocklist"),e=this.node.all(".mim-options-ignore button"),f=this.node.one("#mim-offlineError"),g=a.Messenger.Model.Session,h=g.get("presenceState")===d.STATE.OFFLINE;b=b||h,b?(c.setAttribute("disabled","disabled"),e.setAttribute("disabled","disabled"),h&&f.removeClass("hidden")):(c.removeAttribute("disabled"),e.removeAttribute("disabled"),f.addClass("hidden"))},save:function(d){var f={},g=a.Messenger.Model.ContactList.getInstance(),h=this.node,i=h.one("#mim-showOnlyBuddiesCheckbox").get("checked");e.stat("options_save"),f={mimLogoutPref:h.one("#mim-logoutSelect").get("value"),mimEnableSounds:h.one("#mim-enableSoundsCheckbox").get("checked"),mimShowOnlyBuddies:i,mimBlockNonContacts:h.one("#mim-blockNonBuddies").get("checked"),mimEnableSSA:h.one("#mim-enableSSACheckbox").get("checked")},c.get("smsEnabled")&&(f.mimHomeCountryPref=h.one("#mim-homeCountrySelect").get("value")),b.getPreference("mimShowOnlyBuddies")!==i&&g.handleABPresence(i?"unsubscribe":"subscribe"),b.setPreference(f),b.save(),d()},focusOnPresenceMenu:function(b){13===b.keyCode&&a.later(0,null,function(){a.Messenger.View.ViewUtils.focusOnPresenceStateMenu(b)})},_handleKeyBlockNonBuddies:function(a){var b,c,d=this;40===a.keyCode?(b=d.node.one("#mim-blockSelected"),b&&void 0!==b.get("checked")&&(b.set("checked","true"),b.focus()),a.halt()):38===a.keyCode&&(c=d.node.one("#mim-showOnlyBuddiesCheckbox"),c&&c.focus&&c.focus(),a.halt())},_handleKeyBlockSelected:function(a){var b,c,d=this;38===a.keyCode?(b=d.node.one("#mim-blockNonBuddies"),b&&void 0!==b.get("checked")&&(b.set("checked","true"),b.focus()),a.halt()):40===a.keyCode&&(c=d.node.one("#mim-blocklist"),c&&c.focus&&c.focus(),a.halt())},_focusOnFirstEntryInBlockList:function(a){var b=a.currentTarget.one("option");b&&void 0!==b.get("selected")&&(b.set("selected","true"),b.focus())},_stopEventPropagation:function(a){a.stopPropagation()},_handleKeyCancel:function(b){9===b.keyCode?(this._focusOnLogoutSelect(),b.halt()):13===b.keyCode&&a.later(0,null,function(){a.Messenger.View.ViewUtils.focusOnPresenceStateMenu(b)})},events:{"keydown .mim-button-ok":"focusOnPresenceMenu","keydown #mim-blockNonBuddies":"_handleKeyBlockNonBuddies","keydown #mim-blockSelected":"_handleKeyBlockSelected","focus #mim-blocklist":"_focusOnFirstEntryInBlockList","keydown .mim-options-list":"_stopEventPropagation","keydown .mim-button-cancel>a":"_handleKeyCancel"}})},"@VERSION@",{requires:["tictac-mim-rollups","tictac-base-view","tictac-mim-strings","messenger-options-css","messenger-utils","messenger-contactlist","messenger-constants","messenger-session","messenger-viewutils","messenger-usersettings","messenger-systemsettings"]});YUI.add("messenger-presenceplugin",function(a){"use strict";var b,c=a.Messenger.Common.Constants,d=a.Messenger.Common.Utils,e=a.Messenger.View.NewConversationView,f=a.Messenger.Model.SystemSettings,g=a.Messenger.Model.UserSettings,h=a.Messenger.View.ViewUtils,i=a.Messenger.Common.Stats,j=a.Tictac.mim.rollups,k=a.Tictac.mim.strings;b={initialize:function(b){this.host=b,b.presencePlugin=this,b.togglePresenceMenu=a.bind(this.togglePresenceMenu,this),b.events["click button.mim-presence-state"]="togglePresenceMenu"},setPresenceState:function(b){var d,e,f,l=this,m=l.host,n=b.currentTarget.ancestor("li",!0),o=n.getAttribute("data-action"),p=m.options.session,q=p.get("presenceState"),r=1===p.get("mpopInfo").totalEndpoints?"local":g.getPreference("mimLogoutPref");switch(o){case"setState":if(f=+n.getAttribute("data-state"),q!==f||p.get("presenceMessage"))if(f===c.STATE.OFFLINE)"prompt"===r?l._handleLogoutPrompt():(i.stat("status_signout"),i.stat("toggle",{ltxt:"signout"}),p.logout(r),h.flashWindow(!1),g.setPreference("cg.pref.im.loginpref",f),g.save());else{switch(f){case c.STATE.AVAILABLE:i.stat("status_available");break;case c.STATE.INVISIBLE:i.stat("status_invisible");break;default:i.stat("status_busy")}p.setPresence(f,""),g.setPreference("cg.pref.im.loginpref",f),g.save(),l.flashWindowUnreadMessages()}break;case"setStateCustom":i.stat("status_custom_old"),d=+n.getAttribute("data-state"),e=n.getAttribute("data-message"),p.setPresence(d,e),g.setPreference("cg.pref.im.loginpref",d),g.save(),l.flashWindowUnreadMessages();break;case"newCustomStatus":h.confirm({message:j.custom_status_dialog(),title:k.str_custom_status_title,callback:function(a){var b=a["mim-custom-busy"]?c.STATE.BUSY:c.STATE.AVAILABLE,d=a["mim-custom-status-input"]?a["mim-custom-status-input"].trim():"",e=g.getPreference("mimCustomPresenceArr")||[],f=!1;return d?(_.each(e,function(a){a.state===b&&a.message===d&&(f=!0)}),(d.toLowerCase()===h.getDefaultPresenceMessage(c.STATE.BUSY).toLowerCase()||d.toLowerCase()===h.getDefaultPresenceMessage(c.STATE.AVAILABLE).toLowerCase())&&(d="",f=!0),f||(e.push({state:b,message:d}),e.length>4&&e.shift(),g.setPreference("mimCustomPresenceArr",e)),i.stat("status_custom_new"),p.setPresence(b,d),g.setPreference("cg.pref.im.loginpref",b),g.save(),void l.flashWindowUnreadMessages()):k.str_conv_error_empty_general}}),a.one("#mim-custom-status-input").focus();break;case"history":yui.use("mail-ui-execute-search-utils").then(function(a){a.mail.ui.ExecuteSearchUtils.doMailSearch({searchType:"keyword",query:{keyword:"in:chats"},source:"Search_from_mim_history",shouldParseKeyword:!0,customTitle:{noLabel:!0,value:k.str_opt_msg_general_heading_history}})});break;case"messengeroptions":window.yui.fire("openOptions",{view:"messenger"})}l.togglePresenceMenu(),!b||b.clientX||b.clientY||h.focusOnPresenceStateMenu(b)},_handleLogoutPrompt:function(){var a=this.host,b=a.options.session;h.confirm({title:k.str_opt_msg_general_heading_logout,cssClass:"mim-logout-options-dialog",message:j.logout_options(),callback:function(a){var d=a["mim-logoutType"];i.stat("status_signout"),i.stat("toggle",{ltxt:"signout"}),"on"===a["mim-rememberLogoutPref"]&&g.setPreference("mimLogoutPref",d),b.logout(d),h.flashWindow(!1),g.setPreference("cg.pref.im.loginpref",c.STATE.OFFLINE),g.save()}})},updateContactListState:function(a){var b,c,e=this,f=e.host,g=a.get("presenceState"),i=d.normalizePresenceMessage(a.get("presenceMessage"))||h.getDefaultPresenceMessage(g);b=h.getStateName(g),f.node.one("#mim-cl-view").setAttribute("data-state",b),i&&(c=f.node.one("button.mim-presence-state .mim-presence-message"),c.setHTML(i))},flashWindowUnreadMessages:function(){var a=this.host.options.conversationWindow.get("unreadCount");if(1===a)return h.flashWindow(k.str_unread_messages_single),k.str_unread_messages_single;if(a>1){var b=d.substitute(k.str_unread_messages_plural,{count:a});return h.flashWindow(b),b}return 0},_handleKeyPresenceMenuItems:function(a){var b=a.currentTarget.ancestor("li.mim-menu-item",!0),c=b.previous("li.mim-menu-item"),d=b.next("li.mim-menu-item");38===a.keyCode?(null!==c?c.one("a").focus():b.ancestor("ul#mim-presence-menu").one("> li.mim-menu-item:last-of-type a").focus(),a.halt()):40===a.keyCode?(null!==d?d.one("a").focus():b.ancestor("ul#mim-presence-menu").one("> li.mim-menu-item a").focus(),a.halt()):27===a.keyCode&&(this.togglePresenceMenu(),h.focusOnPresenceStateMenu(a))},togglePresenceMenu:function(b){var c,d,e,i,k,l,m,n,o=a.one("#mim-presence-menu"),p=this,q=p.host,r=q.options.session;return o?(q._menuListener&&(q._menuListener.detach(),q._menuListener=null),q._scrollHandler&&(q._scrollHandler.detach(),q._scrollHandler=null),o.remove(!0),q._menuHideListener&&(q._menuHideListener.detach(),q._menuHideListener=null)):(k=r.get("presenceState"),l=r.get("presenceMessage"),o=a.Node.create(j.presence_menu({customPresenceArr:g.getPreference("mimCustomPresenceArr")||[],isOnline:r.isOnline()})),a.one(document.body).append(o),c=b?b.target.ancestor("button.mim-presence-state",!0):q.node.one("button.mim-presence-state"),d=c.get("region"),e=d.bottom-document.body.scrollTop,i=d.left,o.setStyle("left","-1000px"),e+o.get("offsetHeight")>document.body.offsetHeight&&(e=document.body.offsetHeight-o.get("offsetHeight"),i=d.right),o.setStyle("top",e),f.get("isRTL")?(o.setStyle("left","auto"),o.setStyle("right",h.getWindowSize().width-d.right)):o.setStyle("left",i),a.later(0,null,function(){a.one("#mim-presence-menu")&&(q._menuHideListener=a.on("mousedown",function(a){a.target.ancestor("#mim-presence-menu",!0)||p.togglePresenceMenu()},a.UA.ie?document:window))}),n=a.one("body").hasClass("fullpage")?a.UA.ie?document:window:a.one("#shellnavigation"),q._scrollHandler=a.once("scroll",function(){p.togglePresenceMenu()},n),l?o.all('li[data-state="'+k+'"]').each(function(a){a.getAttribute("data-message")===l&&a.addClass("checked")}):(m=o.one('li[data-state="'+k+'"]'),m&&m.addClass("checked")),h.limitToViewport(o),q._menuListener=o.delegate("click",a.bind(this.setPresenceState,this),"li.mim-menu-item"),o.delegate("keydown",a.bind(this._handleKeyPresenceMenuItems,this),"li.mim-menu-item")),!1}},a.Messenger.View.PresencePlugin=b,b.embedded=!0,e.plugins=e.plugins||[],e.plugins.push(b)},"1.0.0",{requires:["messenger-newconversationview","messenger-contactlist-css","tictac-mim-rollups","tictac-base-view","messenger-constants","messenger-conversation","tictac-mim-strings","messenger-usersettings","messenger-viewutils","messenger-utils","messenger-stats","messenger-systemsettings","event-hover","messenger-base-css","escape"]});"use strict";YUI.add("messenger-contactplugin",function(a){var b,c=a.Messenger.Common.Constants,d=a.Messenger.Common.Utils,e=a.Messenger.View.NewConversationView,f=a.Messenger.Model.SystemSettings,g=c.EVENTS,h=a.Messenger.View.ViewUtils,i=a.Messenger.Common.SMSUtils,j=a.Messenger.Common.Stats,k=a.Tictac.mim.rollups,l=a.Tictac.mim.strings;b={initialize:function(a){this.host=a,a.contactPlugin=this},showContactMenu:function(b){var c,e,g,i,m,n,o=this,p=o.host,q=b.contact,r=q.get("email"),s=!!r,t=window.strings&&window.strings.str_cfg_tog_hasSMS&&q.get("mobileno"),u=q.get("presenceMessage"),v=!!u,w=b.item.get("region");j.stat("right_click",{option:"menu"}),i=a.one("#mim-contact-menu"),i&&i.remove(),c=k.contact_menu({id:b.id,presenceMessage:u,user:q.get("user"),email:r,hasEmail:s,hasSMS:t,hasMessage:v,hasFavorites:b.favorites,isFavorite:q.get("topContact"),isBuddy:"buddy"===q.get("type"),appearOfflineMsg:d.substitute(l.str_menu_appear_offline,{contact_name:q.get("displayName")}),appearOnlineMsg:d.substitute(l.str_menu_appear_online,{contact_name:q.get("displayName")}),onInvisibleList:q.get("isInvisible"),onVisibleList:q.get("isVisible"),isInvisible:p.options.session.isInvisible()}),e=a.Node.create(c),a.one(document.body).append(e),e.removeClass("hidden"),m=w.top+w.height/2-e.get("offsetHeight")/2-document.body.scrollTop,f.get("isRTL")?(n=a.one("body").get("winWidth"),e.setStyle("right",n-b.leftPos+"px")):e.setStyle("left",b.leftPos+"px"),e.setStyle("top",m+"px"),p._menuHideListener=a.on("mousedown",function(a){a.target.ancestor("#mim-contact-menu")||o._hideContactMenu()},a.UA.ie?document:window),b.hover&&(p._menuLeaveListener=e.on("mouseleave",a.bind(o._hideContactMenu,o))),p._menuEnterListener=e.on("mouseenter",a.bind(o._hoverContactMenuEnter,o)),g=a.one("body").hasClass("fullpage")?a.UA.ie?document:window:a.one("#shellnavigation"),p._showContactScrollHandler=a.once("scroll",function(){o._hideContactMenu()},g),e.delegate("click",o._contactMenuClicked,"li[data-action]",o),h.limitToViewport(e)},_contactMenuClicked:function(b){var c,e=this,f=e.host,m=b.currentTarget,n=m.getAttribute("data-action"),o=m.ancestor("#mim-contact-menu"),p=o.getAttribute("data-id"),q=a.Messenger.View.ConversationListView.convListView,r=f.collection.get(p),s=r.get("user"),t=r.get("network"),u=f.options.session.get("loggedInId"),v=0===l.str_session_display_name_order.indexOf("{{lastName}}");switch(n){case"im":j.stat("im",{type:"right_click"}),j.stat("frnd"),q.showConversation(s,t,u);break;case"sms":j.stat("sms",{type:"right_click"}),q.showConversation(s,t,u,"sms");break;case"email":j.stat("email",{type:"right_click"}),c={cbfn:function(b,c){var d=a.mail.Core.feature("composev3").isOn(),e=d?{}:b.get("header");return e.to=[{name:r.get("displayName"),email:r.get("email")}],e.subject=c.subject||"",d?b.setHeader(e):b.set("header",e),!0}},yui.fire("newMessage",c);break;case"edit":j.stat("right_click",{option:"edit"}),h.confirm({title:l.str_cont_edit_cont,message:k.addcontact({user:s,lastNameFirst:v,isIE:!!a.UA.ie,firstName:r.get("firstName"),lastName:r.get("lastName"),email:r.get("email"),mobileno:r.get("mobileno")}),callback:function(b){var c,d={};return d.id=r.get("addressbookId"),(c=h.validateContactForm(b))?c:(_.each(b,function(a,b){d[b.toLowerCase()]=a}),r.editContact({user:s,network:t,addressbook:d,success:function(){var c=a.Messenger.Neo.yui;c.fire(g.CONTACTS_UPDATED,[{addressbookId:d.id,addressbook:d}]),r.set(b),r.set("normalizedNumber",i.normalizeNumber(b.mobileno))}}))}});break;case"delete":j.stat("right_click",{option:"delete"}),h.confirm({message:d.substitute(l.str_del_contact_msg_messenger_desc,{contact_highlighted:r.get("displayName")}),title:l.str_del_contact_msg_header,callback:function(){f.collection.deleteContact(p)}});break;case"favorite":j.stat("right_click",{option:"favorite"});break;case"unfavorite":j.stat("right_click",{option:"unfavorite"});break;case"visibility":f.options.session.isInvisible()?r.get("isVisible")?(j.stat("right_click",{option:"remove_from_visible"}),r.removeFromVisibleList()):(j.stat("right_click",{option:"add_to_visible"}),r.addToVisibleList()):r.get("isInvisible")?(j.stat("right_click",{option:"remove_from_invisible"}),r.removeFromInvisibleList()):(j.stat("right_click",{option:"add_to_invisible"}),r.addToInvisibleList())}e._hideContactMenu()},_hideContactMenu:function(){var b=a.one("#mim-contact-menu"),c=this,d=c.host;b&&(b.remove(!0),this._contactMenuFocused=!1,d._menuHideListener&&(d._menuHideListener.detach(),delete d._menuHideListener),d._menuLeaveListener&&(d._menuLeaveListener.detach(),delete d._menuLeaveListener),d._menuEnterListener&&(d._menuEnterListener.detach(),delete d._menuEnterListener),d._showContactScrollHandler&&(d._showContactScrollHandler.detach(),delete d._showContactScrollHandler))},_hoverContactMenuEnter:function(){this._contactMenuFocused=!0}},a.Messenger.View.ContactPlugin=b,e.plugins=e.plugins||[],e.plugins.push(b)},"1.0.0",{requires:["messenger-newconversationview","messenger-contactlist-css","tictac-mim-rollups","tictac-base-view","messenger-constants","messenger-conversation","tictac-mim-strings","messenger-usersettings","messenger-viewutils","messenger-utils","messenger-stats","messenger-systemsettings","event-hover","messenger-base-css","escape","mail-core-feature"]});