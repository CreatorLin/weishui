YUI.add("mail-controller-messages-ops",function(E){var H,i,l=E.mail,G=l.model.DataStore,C=G.Messages,U=E.common.Utils,a=l.Controller,P=a.Folders,A=E.Lang,d={passthru:{move:"MoveMessages",flag:"FlagMessages",remove:"DeleteMessages",fullHeader:"GetMessageRawHeader",redirectMsg:"RedirectMessage",addFilter:"AddFilters"},isdup:{FlagMessages:function(o,n){var m=o.setFlags,Y=n.setFlags;if(o.mid&&n.mid&&o.mid.length===1&&n.mid.length===1&&o.mid[0]===n.mid[0]&&m.read===Y.read&&m.flagged===Y.flagged){return true;}}}},k,V,c="%40C%40Chats",f="Trash",b="%40B%40Bulk",D="Draft",Z={"replied":"isReplied","flagged":"isFlagged","read":"isRead","draft":"isDraft","forwarded":"isForwarded","ham":"isHam","spam":"isSpam","notmymail":"notmymail"},S=strings.str_cfg_tog_set_spam_read_flag,X={};d.batchable=d.passthru;k=a.extend("Messages",d);V=k.Error;i=d.order;E.mix(k,{fixFlagHook:W});function j(p,w,o){var n,q,v=w.parms,Y=w.reason,s=w.api,u=p.error,x,m,t;if(NeoConfig.scanMoveAction&&w.method==="MoveMessages"){for(q=0;q<v.mid.length;q++){x=false;if(v.mid[q]){t=typeof v.mid[q];if(t==="string"){x=B(v.mid[q]);}else{if(t==="object"&&v.mid[q].hashKey){x=v.mid[q].hashKey;}else{if(t==="object"&&v.mid[q].mid){x=B(v.mid[q].mid);}}}}if(x&&X[x]){delete X[x];}}}if(u){for(q=0;q<u.length;q++){if(u[q].code!=="WARN"){o("failure");return k._error(p,V.invalidmid);}}}if((w&&w.origParms&&((w.origParms.sourceFid&&w.origParms.sourceFid==="%40S%40Search")||w.origParms.fromSearch))||(p&&p.fromSearch)){m=m||{};m.fromSearch=true;}if(w&&w.origParms&&w.origParms.fromConv){m=m||{};m.fromConv=true;}if((Y==="remove"||Y==="move")&&v.mid&&v.mid.length>200){C.remove(v.sourceFid||v.fid,p.mid,!v.destinationFid,v.destinationFid,m);}if(s==="move"&&!(p.fromSearch)&&v.mid&&v.mid.length){C.move(v.sourceFid,v.destinationFid,v.mid,p.mid,Y,m);}n=p.sourceFolder;if(n&&w.custom.isSparse){G.Folders.set(n,"ds:msg:",1);}n=p.destinationFolder;if(n){G.Folders.set(n,"ds:msg:",1);}}function h(p,u){var r,q=p.destinationFid&&p.destinationFid===b,n,s=u.origParms,m=s.destinationFid,o=s.sourceFid,t=u.origParms.mid,Y;if(q){n={};if(m===b){n[Z.spam]=1;n[Z.ham]=0;}if(o===b&&m!==f){n[Z.ham]=1;n[Z.spam]=0;}C.update(p.sourceFid||p.fid,t,{flags:n},"flag");if(S){for(r=0;r<t.length;r++){t[r].flags.isRead=1;}}}if((u&&u.origParms&&((u.origParms.sourceFid&&u.origParms.sourceFid==="%40S%40Search")||u.origParms.fromSearch))||(p&&p.fromSearch)){Y=Y||{};Y.fromSearch=true;}if(u&&u.origParms&&u.origParms.fromConv){Y=Y||{};Y.fromConv=true;}if(t.length<=200){C.remove(p.sourceFid||p.fid,t,!p.destinationFid,p.destinationFid,Y);}}function e(o,q,p){var n=q.origParms,m,Y=o.returnCodes;if(Y&&Y.length){for(m=0;m<Y.length;m++){if(Y[m].code!=="WARN"){p("failure");return k._error(o,V.invalidmid);}}}else{if(!n.mid){P.refresh();}else{if(q.custom.isSparse&&O(n.setFlags,"read")){if(!q.noRefresh&&!NeoConfig.hasConvView){P.refresh();}}}}}function O(m,Y){return m&&(Y in m);}function L(p,m){var o,Y,n=p.setFlags;if(m.origParms.chain){return;}Y={};for(o in n){Y[Z[o]]=n[o];}if(Y[Z.spam]){Y[Z.ham]=0;}else{if(Y[Z.ham]){Y[Z.spam]=0;}}if(A.isUndefined(n.spam)&&m.reason!=="move"){C.update(p.fid,m.origParms.mid||[],{flags:Y},m.reason);}}function Q(u,w){var m,v={},q,p,Y=[],n={},s=w.parms,r=w.origParms.mid||[],o=(u&&u.data&&u.data.returnCodes)||[],t=s.setFlags;for(m in t){if(m==="read"){n[Z[m]]=t[m]?0:1;}}if(!A.isUndefined(t.read)){for(q=0;q<r.length;q++){v[r[q].mid]=r[q];}for(q=0;q<o.length;q++){p=v[o[q].mid];p&&Y.push(p);}C.update(s.fid,Y,{flags:n},w.reason);}}function K(n,Y){var q,m=0,p=Y.origParms.mid;while(p[m]){q=p[m++];if(!q.header){Y.custom.isSparse=1;}}}function F(Y,m){m("failure");return k._error({},V.invalidparams);}function J(m,o){var Y=0,n=m.mid;if(o){m.mid=A.isArray(n)?n[0].mid:n.mid;return 1;}if(!A.isArray(n)){n=(n?[n]:[]);}m.mid=[];for(;Y<n.length;Y++){m.mid[Y]=n[Y].mid||n[Y];}return Y||m.selection;}function I(o,t,AC){var AB=A.isArray(o.mid)?o.mid:new Array(o.mid),v,u,r,m={},w,s,q,x,p,z=[],y=10,AA=o.sourceFid,Y=AA||o.fid;if(Y==="%40S%40Search"){o.enableRetry=true;if(!AB[0]){return;}for(u=0,v=AB.length;u<v;u++){w=AB[u].fid||Y;if(Y==="%40S%40Search"||!(t.api==="move"&&(w==="Draft"||w==="Sent")&&o.destinationFid!==f)){if(!m[w]){m[w]=[];}m[w].push(AB[u]);}}if((q=U.size(m))===1&&w==="%40S%40Search"){return;}if(t.api==="remove"){if(Y==="%40S%40Search"){o.sourceFid=o.sourceFid||o.fid;delete o.fid;o.destinationFid=f;t.newApi("move","MoveMessages",o);AC("pre","move");AC(1,o);return;}}delete o.mids;for(u in m){p=E.clone(o);if(AA){p.sourceFid=u;}else{p.fid=u;}p.mid=m[u];if(o.sourceFid==="%40S%40Search"){p.fromSearch=true;}z[z.length]=p;}U.assert(q===z.length);if(q>1){var n=AC(function(){t.cbk.abort();});x=Math.ceil(q/y);for(r=0;r<x;r++){s=a.batch().Messages;for(u=r*y;(u<q&&u<r*y+y);u++){if(u===q-1){s[t.api](z[u],{success:function(AD){n(AD,"success",i.usercbk);},failure:function(AD){n(AD,"failure",i.usercbk);}});}else{s[t.api](z[u]);}}s.execute();}}else{return z[0];}}}function R(m,Y){var o=m.mid,n=m.fid;if(n==="%40S%40Search"){m.enableRetry=true;if(o.fid&&(o.fid!==n)){m.fid=o.fid;}J(m,Y.api==="fullHeader");}}function W(q,w,AE){var p,AG,Y,z,AB,m,o,y=0,AC,u,AD=q.mid,x=q.setFlags,s,t=q.mid=[],r,v,AF,AA,n;if(U.isEmpty(x)){return F(w,AE);}if(!A.isArray(AD)){AD=(AD)?[AD]:[];}if((x.spam&&(q.fid!==b))||(x.ham&&(q.fid===b))||(x.sendercompromised&&(q.fid!==b))||(x.phished&&(q.fid!==b))||(x.notmymail)){Y=1;}while(AD[y]){p=AD[y++];if(!U.isEmpty(p.flags)){p=C.get(q.fid,p.mid)||p;for(AG in x){if((p.flags[Z[AG]]!==x[AG])||Y){t.push(p);break;}else{if(AG==="read"){r=E.all('.thread-item[data-mid="'+C.getPermMidPart(p.mid)+'"]');v=r.size();for(AF=0;AF<v;AF++){n=!p.flags[Z.read]?1:0;AA=r.item(AF).hasClass("unread")?1:0;if(n!==AA){t.push(p);U.log({m:"DS does not reflect UI for msg",mid:p.mid},false,"InterruptBypassed");break;}}}}}}else{t.push(p);w.custom.isSparse=1;}}if(AD.length&&!t.length){AE("success");return;}if(!J(q)){return F(w,AE);}if(!q.spam&&((o=x.notmymail)||(z=x.spam)||(AB=x.sendercompromised)||(m=x.phished)||x.ham)){AC=w.getBatch();
s=(z||AB||m||o)?b:q.destinationFid||"Inbox";delete q.destinationFid;u={sourceFid:q.fid,destinationFid:s,mid:AD||w.origParms.mid,spam:1,enableRetry:q.enableRetry||false};if(q.fromConv){u.fromConv=q.fromConv;}w.noRefresh=1;if((AB||m)&&!o&&S){x.read=1;}AE(1,q);AC.Messages.move(u);AC.execute(w.cbk);}delete q.spam;}function T(r,t,m){var q,n,p=r.destinationFid,u=r.sourceFid,o,Y;r.mid=r.mid?r.mid:[];o={fid:u,mid:(A.isArray(r.mid))?r.mid:[r.mid],spam:1,enableRetry:r.enableRetry||false};Y=function(){var w,s=r.mid.length;if(s>100){return;}for(var v=0;v<s;v++){w=r.mid[v]&&r.mid[v].mid&&B(r.mid[v].mid);if(w&&X[w]){m("failure");}else{X[w]=true;}}};if(p===u){m("success");return;}if(!r.spam){if(p===b){n=o.setFlags={spam:1};if(S){n.read=1;}}if(u===b&&p!==f){n=o.setFlags={ham:1};}}!n&&NeoConfig.scanMoveAction&&Y();if(n){t.newApi("flag","FlagMessages",o);q=t.getBatch();t.noRefresh=1;m("pre","flag");m(1,o);r.spam=1;r.bidiDetection=NeoConfig.bidi;q.Messages.move(r);q.execute(t.cbk);}delete r.spam;if(!J(r)){return F(t,m);}}function B(Y){var m=Y.split("_");return m[m.length-1];}function g(m,Y,n){if((m.fid!==f)&&(m.fid!==D)&&(m.fid!==b)&&(m.fid!==c)&&!m.force){m.sourceFid=m.fid;delete m.fid;m.destinationFid=f;Y.api=Y.reason="move";Y.method=d.passthru.move;n("pre","move");return m;}delete m.force;if(!J(m)){return F(Y,n);}}function M(m,Y){if(NeoConfig.scanMoveAction&&Y.method==="MoveMessages"&&m.fault==="aborted"){X=[];}if(m&&(m.reason===V.invalidparams)){return;}if(Y.parms.sourceFid){C.flush(0,1);}E.later(500,P,P.refresh);}function N(n,Y){if(n&&(n.reason===V.invalidparams)){return;}var m=Y.parms;if("read" in m.setFlags){P.refresh();}else{C.flush(m.fid);}}H={success:j,failure:M};k.hook({move:H,remove:H,flag:{success:e,failure:N}});H={pre:h};k.hook({move:H,remove:H},0,i.optimistic);k.hook({move:{pre:I},remove:{pre:I},flag:{pre:I},fullHeader:{pre:R},redirectMsg:{pre:I}},0,i.fixParms);k.hook({move:{pre:T,aborted:M},remove:{pre:g,aborted:M},flag:{pre:W,aborted:N},redirectMsg:{pre:function(Y){J(Y);}}},0,i.fixParms);k.hook({move:{pre:K},flag:{pre:L,failure:Q}},0,i.optimistic);E.mix(V,{invalidmid:V._reservedIdx+1,invalidparams:V._reservedIdx+1,noitems:V._reservedIdx+2});},"3.0.0",{requires:["mail-controller-base","mail-model-datastore","json-stringify"]});