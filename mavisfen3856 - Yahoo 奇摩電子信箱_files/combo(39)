YUI.add("mail-controller-sendconfirm",function(e){function E(n,r,o,l){var m,g=n.get("origin"),y,w=n.get("cid"),E=v.get("userSendPref.autosaveOnSend")==="yes"?!0:!1,S=w&&NeoConfig.hasConvPerf&&E?!0:!1,k=[],L=n.get("disableaddcontact")||v.get("userSendPref.addUnknownContact")==="prompt"?!1:!0,A=n.get("api"),O=function(){},_={success:O,failure:O,suppressNotification:!0},D=t.model.ConvStore,P=D?D.Conversations.getPermCidPart:null,H=function(t){try{t&&e.mail.Controller.Messages.remove({fid:"Draft",mid:t,force:!0},_)}catch(n){typeof globals!="undefined"&&globals.report?globals.report("caughterror:..-build-mail-controller-sendconfirm:1",n,"TRY_CATCH",1,1,1):window.console&&console.log&&console.log("caughterror:..-build-mail-controller-sendconfirm:1")}};m={success:function(i,l){function x(e,t){e&&t&&e.widget&&e.widget.fid==="Sent"&&t.refresh()}var v=l.args.batchSend?i.send:i,m,b;N(),y=n.get("draftMID");var E=M(l.args.sdo);E.contactsAdded=0;if(!NeoConfig.isAMT&&L&&E.unknown.length>0){var S={guid:NeoConfig.neoguid,requestFn:e.common.net.SessionMgr.requestProxy,wspath:NeoConfig.socdirProxyPath,success:O,failure:O};a.setAttrs(S),E.contactsAdded=E.unknown.length,h({m:"Autosaving contact info..."}),e.Array.each(E.unknown,function(t){m=e.Lang.trim(t.name),b=t.email,e.Lang.isObject(m)&&(m=m.name),m!=""&&m!=undefined&&b?k.push({fields:[{type:"name",value:{givenName:m}},{type:"email",value:b}]}):b&&k.push({fields:[{type:"email",value:b}]})}),E.known=E.known.concat(E.unknown),E.unknown=[],f.saveContacts(k)}n.set("sendaction",{action:"success",args:{addy:E,mid:v.mid}}),e.use("common-ui-tabs-base","mail-controller-folders",function(e){x(e.mail.Tabs.getActiveTab(),e.mail.Controller.Folders)});try{if(g.fid&&g.oMsg&&g.action&&g.action!=="edit"){var T={fid:g.fid,mid:[g.oMsg],setFlags:g.action===d?{forwarded:1}:{replied:1}};s.flag(T,{suppressCodes:["*"]})}}catch(_){typeof globals!="undefined"&&globals.report?globals.report("caughterror:..-build-mail-controller-sendconfirm:2",_,"TRY_CATCH",1,1,1):window.console&&console.log&&console.log("caughterror:..-build-mail-controller-sendconfirm:2")}strings.str_cfg_tog_sendconfirm_keep_draft||H(y);try{if(w&&(!l.args.batchSend||l.args.batchSend&&i.map.midscids[0]&&P(i.map.midscids[0].cid)===P(w))){var D=n.get("cascade").message,B=i.get,j={sdo:n},F={mid:v.mid,cid:w,fid:"Sent",snippet:B?B.snippet:C(n),sourceFolderInfo:{fid:"Sent"},receivedDate:B?B.header.sentDate:Math.floor((new Date).getTime()/1e3),flags:B?B.flags:{isRead:1},from:D.from,toEmail:B?B.header.to:D.to,subject:B?B.header.subject:D.subject};h({m:"Add message to conversation"}),t.model.ConvStore.Conversations.msgAdd(w,null,F,j,!0)}else p.set("Sent",v.mid,"add")}catch(_){typeof globals!="undefined"&&globals.report?globals.report("caughterror:..-build-mail-controller-sendconfirm:3",_,"TRY_CATCH",1,1,1):window.console&&console.log&&console.log("caughterror:..-build-mail-controller-sendconfirm:3")}if(A===!0){if(!NeoConfig.tmpForceAdSendTest){var I=c.Folders.get(g.fid),q=t.ui.common.StringUtils.getSystemFolderInfoName(g.fid,I);e.use("mail-ui-messagepane-utils",function(e){e.fire("darlaEvent",{action:"sent_api",value:{siteAttr:t.ui.MessagePaneUtils.getAdSiteAttribsFromMesgObj(g.oMsg,g.fid),foldername:q}})})}}else e.fire("SentSuccess",g,v);r&&r.stop(),e.fire("stat:feature_latency",{message:"UI_SEND_COMPLETE",feature_group:"SEND",value:r.d}),e.fire("stat:feature_complete",{message:"UI_SEND_COMPLETE_SUCCESS",feature_group:"SEND"}),o==="autocompose"&&u.stat("autocompose_send_success")},failure:function(t,n){var r,s,o,a,f,c;if(n.args.batchSend&&t.sendResult){n.args.batchSend=!1,m.success(t.send,n),h({m:"Failure: send success but batch call failed"});return}r=n.args.batchSend?t.send.fault.detail&&t.send.fault.detail.length?t.send.fault.detail[0]:t.send.fault:t,s=n.args.sdo,o=r.code,a=r.fault?r.fault:r,f=a&&a.message,c=NeoConfig.mailEnv==="prod"?NeoConfig.hostName.split(".")[3]:"",n.args.batchSend&&(a.detail=r.detail),s.set("requestId",0),N();switch(o){case"Client.HumanVerificationRequired":case"Client.WrongInput":case"Client.InputTooEarly":case"Client.CannotSendThisMessage":case"Client.AccountVerificationRequired":s.set("sendaction",{action:"captcha",args:{fault:a}}),e.fire("stat:feature_complete",{message:"UI_SEND_CAPTCHA_RECIEVED",feature_group:"SEND"});break;case"Client.TimedOut":s.set("sendaction",{action:"captcha",args:{fault:a}});break;case"Client.UserAbuseDetected":s.set("sendaction",{action:"abuse",args:null}),y=s.get("draftMID"),H(y);break;case"Server.SendMessageFailed":l&&l.isSaveTimedOut&&u&&u.stat("ue_client_error_13","api=>SendMessage,code=>"+o+",tae_type=>SaveOver30SecondsAndSendFailed"),l&&l.isMailboxBusy&&u&&u.stat("ue_client_error_13","api=>SendMessage,code=>"+o+",tae_type=>MailboxBusy"),f&&e.use("common-utils-error",function(){i.error.report("Send Failure: "+f)}),s.set("sendaction",{action:"error",args:{fault:a}});break;default:s.set("sendaction",{action:"error",args:{fault:a}})}},args:{sdo:n,batchSend:S},timeout:b,suppressCodes:["Client.HumanVerificationRequired","Client.AccountVerificationRequired","Client.UserAbuseDetected"],suppressNotification:!0,urlParams:{debugmid:n.get("draftMID")||"",debugts:(new Date).getTime()}},r&&(r.bodySize=0,n.get("contenthtml")&&(r.bodySize+=n.get("contenthtml").length),n.get("contenttext")&&(r.bodySize+=n.get("contenttext").length),r.attachCount=n.get("attachments").length,r.start(1,"msgSend")),o==="autocompose"&&u.stat("autocompose_send_attempt"),parseInt(n.get("requestId"),10)===0&&n.set("requestId",Math.random());var B=n.get("cascade");h({m:"Make back end call for sending message to cascade..."}),x(S,B,m),T(n),e.fire("Y.mail.sendMessage",n),e.fire("stat:feature_invoke",{message:"UI_SEND_START_SUCCESS",feature_group:"SEND"})}function S(t,n){!e.Lang.isUndefined(t.sendResult)&&!e.Lang.isUndefined(t.mapResult)&&!e.Lang.isUndefined(t.getResult)&&(t.sendResult&&t.mapResult&&t.getResult?n.success(t,n):n.failure(t,n))}function x(t,r,i){var s=r&&r.messageReference?r.messageReference.mid
:"no-mid";if(t){var o=n.batch(),u,a,f={},l={suppressCodes:["Client.HumanVerificationRequired","Client.AccountVerificationRequired","Client.UserAbuseDetected"],suppressNotification:!0,urlParams:i.urlParams||""};s="[batch]"+s,r.chain={id:"sendmessage"},o.Messages.send(r,function(e,t,n){f.send=e,f.sendResult=n==="success",S(f,i)}),u={fid:"Sent",mids:["_chainedMid"],chain:{id:"getcids",parameter:[{source:"sendmessage.mid",destination:"getcids.mids[0]"}],dependency:["sendmessage"]}},o.Conversations.map(u,function(e,t,n){f.map=e,f.mapResult=n==="success",S(f,i)}),a={chain:{id:"getmessage"},fid:"Sent",ovparams:{},cachekey:"Prime"},a.chain.parameter=[{source:"sendmessage.mid",destination:"getmessage.message[0].mid"}],a.chain.dependency=["sendmessage"],o.Messages.get(a,function(e,t,n){f.get=e,f.getResult=n==="success",S(f,i)}),h("#SS: executeSend: "+s),o.execute(l)}else s="[single]"+s,h("#SS: executeSend: "+s),e.mail.Controller.Messages.send(r,i)}function T(t){m&&m.cancel(),m=e.later(w,this,function(e){e.set("sendaction",{action:"error",args:{fault:{code:strings.str_modal_generic_err}}})},[t],!1)}function N(){m&&(m.cancel(),m=null)}function C(t){var n=40,r=e.Lang.trim(t.get("contenttext"));return r=r.substring(0,n),r.replace(/\n/g," ")}function k(t,n){var r,i;if(t<1)r=1;else if(t<2)r=2;else if(t<3)r=3;else if(t<5)r=5;else if(t<8)r=8;else if(t<10)r=10;else if(t<15)r=15;else if(t<20)r=20;else{r="long";try{i=["*** SaveSuccessLongTime","Client Time: "+t+" seconds","User: "+NeoConfig.emailAddress,"Response: "+e.JSON.stringify(n)].join(" - "),g?g.log(i):e.use("comms-log4js",function(e){g=e.comms.log4js.getLogger("saveLogger",1,"ajax"),g.log(i)})}catch(s){typeof globals!="undefined"&&globals.report?globals.report("caughterror:..-build-mail-controller-sendconfirm:4",s,"TRY_CATCH",1,1,1):window.console&&console.log&&console.log("caughterror:..-build-mail-controller-sendconfirm:4")}}}function L(r,s){var o=r.auto,u=r.silent,a=(new Date).getTime(),f=r.folderName||"Draft",l={chain:{id:"savemessage"},destination:{fid:f},message:r.sdo.get("cascade").message},c={success:function(n){var o=l.message,u=((new Date).getTime()-a)/1e3,h=r.cid,d=r.sdo.get("origin"),v,m,g={sdo:r.sdo},y={mid:n.mid,flags:{},header:{from:o.from,to:o.to,cc:o.cc,bcc:o.bcc,subject:o.subject,replyto:o.replyto}};k(u,n);if(!n.mid){c.failure(n);return}try{h?(y.cid=h,y.fid="Draft",y.flags={isRead:1},y.snippet=C(r.sdo),y.sourceFolderInfo={fid:"Draft"},y.header.receivedDate=Math.floor((new Date).getTime()/1e3),d&&(m=d&&d.parentMsg,m?v=m.mimeMsgId:v=d&&d.oMsg&&d.oMsg.mimeMsgId,v&&(y.inReplyTo=v)),t.model.ConvStore.Conversations.msgAdd(h,null,y,g)):p.set(f,y,"add"),r.mid&&p.remove("Draft",r.mid,!0,null,{reason:"savedraft"})}catch(b){typeof globals!="undefined"&&globals.report?globals.report("caughterror:..-build-mail-controller-sendconfirm:5",b,"TRY_CATCH",1,1,1):window.console&&console.log&&console.log("caughterror:..-build-mail-controller-sendconfirm:5"),e.use("common-utils-error",function(){i.error.report("SaveSuccessException",b,1,1,1)})}if(s){var w=!1;s(n.mid,0,w)}},failure:function(t){var n=!0,r=!1,i=!1;NeoConfig.hasConvView&&t.fault&&t.fault.detail&&t.fault.detail.length>0&&(e.Array.each(t.fault.detail,function(t){e.Object.getValue(t,["fault","id"])==="savemessage"&&(r=!0),t.code==="Server.MailboxOpenFailed.Busy"&&(i=!0)}),r||(n=!1)),s&&s(t.mid,n?-1:-2,i),h("#SS: _SaveMessage:fail: "+t.mid)},args:{sdo:r.sdo,auto:o},timeout:!o&&y,suppressCodes:u?["*"]:["Client.MessageNotFound"],suppressLogs:u?["*"]:[]},d,v,m;r.mid&&(l.destination.mid=r.mid),r.appid&&(c.appid=r.appid),s&&s(null,1),d=n.batch(),d.Messages.save(l,c);switch(f){case"Spam":case"Sent":case"Trash":case"Draft":A(d.Messages);break;default:}v={urlParams:{action:r.action||"",actionCount:r.actionCount||"",debugmid:r.mid||"",debugts:(new Date).getTime()}},u?(v.suppressCodes=["*"],v.suppressLogs=r.isRetryable&&!r.retry?["*"]:[]):v.suppressCodes=["Client.MessageNotFound"],d.execute(v)}function A(e){if(NeoConfig.hasConvView){var t={chain:{id:"flagmessages",parameter:[{source:"savemessage.mid",destination:"flagmessages.mid[0]"}],dependency:["savemessage"]},mid:"_chainedmid",fid:"Draft",setFlags:{read:1}};e.flag(t,function(e,t,n){n==="failure"})}}function O(){return function(t){var n=[],r=[],i,s,o=[],u=t.get("recipients"),a=[u.to,u.cc,u.bcc],f,c,h,p=function(e){o.push(e)};for(i=0,s=a.length;i<s;++i)f=e.Array.each(a[i],p);for(i=0,s=o.length;i<s;++i)c=(l.getContactsByEmail(o[i].email)||[])[0],c&&c.id>=0?(o[i].name||(h=l.getFirstFieldValue(c,"name")||{},o[i].givenName=h.givenName,o[i].familyName=h.familyName),o[i].cid=c.id,n.push(o[i])):v.isUsersEmailAddress(o[i].email)?n.push(o[i]):r.push(o[i]);return{known:n,unknown:r}}}var t=e.mail,n=t.Controller,r=n.extend("SendConfirm"),i=e.common.Utils,s=n.Messages,o=e.contacts,u=i.ymmastats,a=o.config,f=o.api,l=o.utils,c=t.model.DataStore,h=i.log,p=c.Messages,d="forward",v=e.common.persist.UserData,m=null,g,y=45e3,b=9e4,w=b+15e3,M=O();e.mix(r,{sendMessage:E,saveMessage:L},!0)},"3.0.0",{requires:["mail-controller-base","mail-model-send","mail-model-datastore","contacts-api-utils","contacts-api","mail-controller-messages-ops","common-utils-stats"]});
YUI.add("_shared_module_send_confirm_captcha_blocked",function(A){A.namespace("ui.Templates");A.ui.Templates._shared_module_send_confirm_captcha_blocked={base:"{{message_blocked}}{{account_blocked}}",message_blocked:'<div class="error"> <span class="error-logo"></span> <strong>{{str_comp_captcha_msg}}</strong> <p>{{str_comp_captcha_msg_suspicious_activity}}</p> <p>{{str_comp_captcha_apology}}</p></div>',account_blocked:'<div class="error"> <span class="error-logo"></span> <strong>{{str_comp_captcha_account}}</strong> <p>{{str_comp_captcha_account_suspicious_activity}}</p> <p>{{str_comp_captcha_apology}}</p></div>'};},"1.0.0");YUI.add("_shared_module_send_confirm_rollup",function(A){A.namespace("ui.Templates");A.ui.Templates._shared_module_send_confirm_rollup={base:'<div class="content send-confirm"> <div class="col-a" aria-live="polite" role="document"> <div class="box box-iso"> <h3 class="loading">{{str_comp_sending}}</h3></div> <div class="box box-iso hidden"> {{sending_error_else}} </div> <div class="box box-iso hidden"> {{sending_error}} </div> </div> <div class="col-b"> {{is_mon}} {{is_lrec}} </div> </div>',msg_replied_to:'<h3 class="from">{{from}}</h3> <p class="subj">{{subject}}</p> <p class="snippet">{{snippet}}</p> ',is_reply:'<div class="items replied-to"> <h2 class="legend"><span class="label"><b>{{str_comp_original_msg}}</b></span></h2> {{msg_replied_to}} <div> <span class="btn left right small menu" data-action="menu"> <a title="{{str_move}}" href="#">{{str_move}}<b></b></a> </span> <span class="btn left right small"> <a title="{{str_delete}}" href="#">{{str_delete}}<b></b></a> </span> </div></div> ',message_sent_success:'<h3 class="success"><i></i><span class="msg">{{str_comp_email_sent}}</span></h3><div class="offset"> <span class="btn default left right"><a href="{{url_minty_inbox}}" data-action="navigate" role="button">{{str_comp_done}}</a></span></div>',new_recipients:"underline",contacts_not_in_ab:'<li> <span class="btn lozenge btn-contact small left" data-name="{{name}}" data-address="{{email_id}}" data-action="contact-menu"> <a role = "button" title="{{str_btn_recipient_lozenge_attr}}" href="#">{{msg_display_name}}</a> </span><span class="btn lozenge lozengeadd right small btn-kiosk-addcontact" data-name="{{name}}" data-address="{{email_id}}" data-action="modal"> <a role = "button" title="{{str_btn_add_recipient_attr}}" href="#">&nbsp;</a> </span> </li> ',contacts_in_ab:'<li> <span class="btn lozenge btn-contact left small right" data-name="{{name}}" data-address="{{email_id}}" data-action="contact-menu"> <a role = "button" title="{{str_btn_recipient_lozenge_attr}}" href="#">{{msg_display_name}}</a> </span> </li> ',global_auto_add_contacts:'checked=""',new_recipients1:'<div class="field"> <div class="checkbox"> <label><input type="checkbox" {{global_auto_add_contacts}} class="checkbox"> {{str_comp_auto_add_to_contacts}} </label> </div> </div>',sending_error_else:'{{message_sent_success}} <div class="items {{new_recipients}}"> <h2 class="legend"><span class="label"><b>{{str_comp_recipients}}</b></span></h2> <ul class="inline-items"> <span class = "lozengeContainer"> {{contacts_not_in_ab}} {{contacts_in_ab}} </span> </ul></div>{{new_recipients1}} {{is_reply}} ',sending_error:'<h3 class="error"> <span class = "error-logo"></span> {{sending_error_msg}}</h3><div>{{sending_error_detail}}</div> ',is_mon:'<div id="slot_MON_sent" class="ch_mod gxBoom boom"><div id="tgtMON_sent" ></div></div> ',is_lrec:'<div id="slot_LREC_sent"><div id="tgtLREC_sent" class="darla" tabindex="-1" hidefocus="true"></div></div> '};},"1.0.0");YUI.add("comms-lozenge",function(C){var B=C.comms.Utils.escapeHtml;function A(){A.superclass.constructor.apply(this,arguments);}A.NAME="lozenge";A.ATTRS={data:{value:{value:""},setter:"_setData"},segmentCount:{value:1},segmentTypes:{value:[]},segmentHovers:{value:[]},labelSegment:{value:0},label:{valueFn:"_defEscapeDataValueFn"},validate:{value:false},error:{value:false},selectable:{value:true},selected:{value:false}};A.LOZENGE_TEMPLATE='<span class="lozengeSegment {segclass}"><a tabindex="0" role="button">{label}</a></span>';C.extend(A,C.Widget,{initializer:function(E){var D=E.data||{};if(this.get("validate")){this.set("error",this._isError(D));}},destructor:function(){this._lozengeNode=null;},renderUI:function(){var H,D,I,F,G,K,L,E=[],J;D=this.get("segmentCount");I=this.get("segmentTypes");K=this.get("labelSegment");J=this.get("contentBox");L=this.get("label");for(H=0;H<D;H++){F=C.substitute(A.LOZENGE_TEMPLATE,{label:(K===H)?L:"",segclass:I[H]});G=C.Node.create(F);E.push(G);if(H===K){this._lozengeNode=G;}J.appendChild(G);}E[0].addClass("left");E[D-1].addClass("right");},bindUI:function(){this.after("dataChange",this._afterDataChange);this.before("selectedChange",this._beforeSelectedChange);this.after("selectedChange",this._afterSelectedChange);this.after("errorChange",this._afterErrorChange);this.get("contentBox").delegate("click",this._onClick,".lozengeSegment",this);},syncUI:function(){this._updateUI();var D=this.get("boundingBox");D.lozengeObj=this;},removeSegment:function(E){var J,D,H,I,G,F;J=this.get("segmentCount");if(E<0||E>(J-1)){return;}D=this.get("segmentTypes");H=this.get("labelSegment");I=this.get("contentBox");G=I.all(".lozengeSegment");F=G.item(E);J--;if(J){if(E===0){G.item(1).addClass("left");}else{if(E===J){G.item(J-1).addClass("right");}}}F.remove(true);D.splice(E,1);this.set("segmentCount",J);if(E==H){H=null;}},_defDataValueFn:function(){var D=this;return function(){return D.get("data").value||"";};},_defEscapeDataValueFn:function(){var D=this;return B(D.get("data").value||"");},_isError:function(D){D=D||this.get("data");return !!(D.value);},_setData:function(D){D=D||"";if(typeof(D)!=="object"){return{value:D.toString()};}return D;},_afterDataChange:function(E){var D=B((E.newVal.value)?E.newVal.value:E.newVal);this.set("label",D);this.get("segmentHovers")[this.get("labelSegment")]=D;this._updateUI();},_afterSelectedChange:function(E){var D=this.get("boundingBox");if(E.newVal){D.addClass("lozengeSelected");}else{D.removeClass("lozengeSelected");}},_beforeSelectedChange:function(D){if(!this.get("selectable")){D.preventDefault();}},_afterErrorChange:function(E){var D=this.get("boundingBox");if(E.newVal){D.addClass("lozengeError");}else{D.removeClass("lozengeError");}},_onClick:function(F){var D=this.get("contentBox");var H=this.get("segmentTypes");var G=D.all(".lozengeSegment");var E=G.indexOf(F.currentTarget);this.fire(this.name+":segmentClick",E,H[E]);},_updateUI:function(){var E,H,J,G=this.get("boundingBox"),I=this.get("contentBox").all(".lozengeSegment"),K=this.get("segmentCount"),D=this.get("segmentHovers"),F=this.get("labelSegment");for(E=0;E<K;E++){H=I.item(E);J=H.one("a");H.setAttribute("title",D[E]);if(E==F){J.setContent(this.get("label"));}else{J.setContent("&nbsp;<b></b>");}}if(this.get("error")){G.addClass("lozengeError");}else{G.removeClass("lozengeError");}if(this.get("selected")){G.addClass("lozengeSelected");}else{G.removeClass("lozengeSelected");}}});A.prototype.BOUNDING_TEMPLATE="<li></li>";A.prototype.CONTENT_TEMPLATE="<span></span>";C.namespace("comms");C.comms.Lozenge=A;C.comms.LozengeUtils={updateABSegments:function(S,D){var J,I,N,G=[],K=[],M=[],R,L,F,O,Q,P,H,E=[];for(N in D){Q="";L=D[N].fields;for(J=0,I=L.length;J<I;J++){R=L[J];if(R.type==="email"){O=R.value;}else{if(R.type==="name"){F=R.value;Q=C.common.Utils.substitute(strings.str_name_format,{given_name:F.givenName,family_name:F.familyName});}}}G.concat(D[N].id||null);K=K.concat(O);M=M.concat(Q||O);}H=S.all(".plus");H.each(function(X){var U=X.ancestor(".yui3-lozenge"),W=U.lozengeObj,T=W.get("data.email"),V="";for(P=0;P<K.length;P++){V=K[P];if(V===T){E.push(U);W.removeSegment(1);W.set("data",{name:M[P]||V,email:V,cid:G[P]});}}});return E;}};},"0.0.1",{requires:["node","widget","substitute","comms-utils"]});YUI.add("comms-lozenge-address",function(D){var C=D.Lang;var A=D.comms.Utils.escapeHtml;function B(){}B.ATTRS={data:{value:{name:"",email:"",isNN:""},setter:"_setData"},segmentCount:{value:2},segmentTypes:{value:["name","plus"]},labelSegment:{value:0},label:{valueFn:function(){var E=this.get("data");return A(E.name||E.email||"");}},segmentHovers:{valueFn:function(){var E=this.get("data");if(E.name==E.email){return["",""];}else{return[E.email,""];}}},validate:{value:true}};B.prototype={_isError:function(E){var F=(E&&E.data&&E.data.email)||this.get("data.email");if(F){return !(this._isValidEmail(F));}return false;},_setData:function(F,G){var E,H;if(typeof(F)!=="object"){E=F.toString();F={name:"",email:E};}else{if(!F.email){return D.Attribute.INVALID_VALUE;}}return F;},_isValidEmail:function(F){var K=this,J,I,E,G,H=/^([^@ ;:()\[\],<>\\]+@[^@ ;:()\[\],<>\\]+\.[^@ ;:()\[\],<>\\]+)/;F=F||K.get("data").email;if(!H.test(F)){return false;}G=F.split("@");J=G[0];I=G[1];if(!I||!J){return false;}G=I.split(".");E=G[1];if(!E){return false;}return F;},_afterDataChange:function(I){var H,G,J,F=I.newVal.name,E=I.newVal.email;if(!F||(F===E)){F=A(E);G="";}else{F=A(F);G=E;}this.set("label",F);J=this.get("labelSegment");this.set("segmentHovers."+J,G);if(this.get("validate")){H=this._isValidEmail(E);this.set("error",!H);}this._updateUI();}};D.namespace("comms");D.comms.LozengeAddressMod=B;D.comms.AddressLozenge=D.Base.create("addressLozenge",D.comms.Lozenge,[D.comms.LozengeAddressMod]);},"0.0.1",{requires:["base-build","comms-lozenge"]});YUI.add("minty_module_toolbar_inbox_sent_msg_rollup",function(A){A.namespace("ui.Templates");A.ui.Templates.minty_module_toolbar_inbox_sent_msg_rollup={base:'<div id="pagetoolbar" class="{{msgliststate}}"> {{is_reply}} {{sending_error}}</div>',is_reply:'<span class="btn left right hidden"><a href="#" data-action="back-to-message" title="{{str_toolbar_back_to_message}}">{{str_toolbar_back_to_message}}</a></span> <span class="btn left hidden"><a class="icon prev" href="#" data-action="prev" title="{{str_next_attr}}"><i>{{str_next}}</i></a></span><span class="btn right hidden"><a class="icon next" href="#" data-action="next" title="{{str_previous_attr}}"><i>{{str_previous}}</i></a></span> ',backtomsg:'<span class="btn left right btn-back"><a href="#" data-action="backtomsg" title="{{str_comp_back_to_msg_attr}}">{{str_comp_back_to_msg}}</a></span>',tryagain:'<span class="btn left right btn-retry"><a href="#" data-action="retry" title="{{str_comp_try_again_attr}}">{{str_comp_try_again}}</a></span>',abuse:'<span class="btn left right"><a href="#" data-action="navigate">{{str_comp_done}}</a></span>',sending_error:"{{backtomsg}}{{tryagain}}{{abuse}} "};},"1.0.0");YUI.add("mail-ui-sendconfirmview-base-conv",function(C){var F=C.mail.Controller.SendConfirm,X=C.mail.Controller.Compose,L=C.ui.Templates,D=C.common.Utils,S=D.substitute,O=L._shared_module_send_confirm_rollup,N=C.Node.create,U=C.mail.ui.SearchBar,T=D.ymmastats,Q;var Z=function(Y){var f=this,e,c,d,b=Y.sdo;f.parent=null;f.isAbuseDetected=false;f.container=Y.container;f.sendingError=false;f.sendingErrorElse=false;Z.superclass.constructor.call(f);f.neoEvent("sendConfirmEvent",{emitFacade:true,broadcast:1});f.bindSDO(b);};function R(Y){var b=this;b.sdo=Y;b.sdo.after("sendactionChange",function(c){var d=c.newVal.action;switch(d){case"success":Q=c.newVal.args.addy;b.showSuccess(c.newVal.args.mid);T.stat("send","result=>success,env=>"+NeoConfig.mailEnv);break;case"captcha":b.showCaptcha(c.newVal.args.fault);T.stat("send","result=>captcha,env=>"+NeoConfig.mailEnv);break;case"error":b.showError(null,null,c.newVal.args.fault);T.stat("send","result=>error,env=>"+NeoConfig.mailEnv);break;case"abuse":b.showAbuse(null,null,null);T.stat("send","result=>abuse,env=>"+NeoConfig.mailEnv);break;default:break;}});}function V(){var Y=this;Y.container.showComposeShim(false);if(Y.sendingError){Y.sendingError=false;}Y.set("forceClose",1);Y.neoFire("sendConfirmEvent",{action:"removeChild",subview:Y});Y.container.showCompose(true);}function W(){}function a(c){var d=this,b,Y;if(c){d.parent=c;d.bindUI();}}function B(Y){var b=this;}function E(c,g,h){var e=this,i,d,j,Y,k,b={sending_error_detail:""},f=["str_cascd_ExceededMaxTo","str_cascd_ExceededMaxCc","str_cascd_ExceededMaxBcc","str_cascd_ExceededMaxRecipients","str_cascd_ExceededMaxHourlyMessages","str_cascd_ExceededMaxDailyMessages","str_cascd_InvalidRecipientAddress","str_cascd_MessageContentReject"];e.sendingError=true;e.container.composeView.lastSendState="sndError";if(!c){Y=h.code.replace(/[^\.]*\./,"");b.sending_error_detail=strings["str"+"_cascd_"+Y]||"["+Y+"]";k=C.mail.Errormap.getErrorInfo({code:h.code})||"";b.sending_error_detail=k.message+" "+b.sending_error_detail;b.sending_error_msg=strings.str_comp_not_sent;c=S(O.sending_error,b,null,null,strings,L);}e.backToMessage();e.container.notifyError({title:strings.str_error_SendMessageFailed,body:c});}function P(b,Y,c){var d=this;d.isAbuseDetected=true;d.sendingError=true;d.container.composeView.lastSendState="sndError";d.container.notifyAbuse();d.neoFire("sendConfirmEvent",{action:"closeAction"});}function K(Y){var b=this;if(/AccountVerificationRequired/.test(Y.code)){b.doBlocked({type:"account"},Y);return;}else{if(/CannotSendThisMessage/.test(Y.code)){b.doBlocked({type:"message"},Y);return;}}C.use("mail-ui-captcha-controller",function(e){var c,d={data:Y.detail,contCbk:e.bind(function(f){b.retrySendMessageWithCaptcha(f);},b),cancelCbk:e.bind(function(){b.backToMessage();},b)};if(/Client.WrongInput/.test(Y.code)){d.data.inputError=true;}else{d.data.inputError=false;}c=new e.mail.ui.CaptchaController(d);if(!b.container.composeView.get("active")){b.neoFire("sendConfirmEvent",{action:"showCaptcha",fault:Y});}else{c.show();}});}function G(f,e){var g=this,b,Y,c,d=L._shared_module_send_confirm_captcha_blocked;Y={tryagain:false,backtomsg:true,abuse:false};c=f.type==="message"?d.message_blocked:d.account_blocked;b=S(c,{locale:NeoConfig.lang},null,null,strings,L);g.showError(b,Y,e);}function A(b){var c=this,Y;if(b.value){c.sendingError=false;if(b.captchaView==="audio"){c.sdo.set("captcha",{"X-HumanVerification-AudioUrl":b.url,"X-HumanVerification-Answer":b.value});}else{c.sdo.set("captcha",{"X-HumanVerification-ImageUrl":b.url,"X-HumanVerification-Answer":b.value});}Y=new D.Stopwatch("SendConfirm","start");Y.action="captcha";F.sendMessage(c.sdo,Y);}}function J(){var b=this,Y;Y=new D.Stopwatch("SendConfirm","start");Y.action="retry";F.sendMessage(b.sdo,Y);}function I(Y){var b=this;b.responseMid=Y;b.neoFire("sendConfirmEvent",{action:"closeAction"});if(C.mail.Core.feature("composev3").isOff()&&b.container.composeView.flavor==="autocompose"){b._showDialog();}else{D.log({"m":"show message sent success notification","mid":Y});b._showNotification();}}function M(){var Y=this;C.use("common-ui-dialog-helper","_shared_module_offscreen_bin_modal_autocompose",function(e){var d=L._shared_module_offscreen_bin_modal_autocompose,c,b,f;e.common.ui.DialogHelper.createCommon({template:D.ezSub(d.base),centered:true,clearMask:true,noScroll:true},{ok:{handler:function(){e.fire("newMessage",{flavor:"autocompose"});T.stat("autocompose","launch=>another");}}},function(g){c=g.get("contentBox");f=e.later(50,{},function(){b=e.one("body").on("click",function(){g.destroy();});});g.on("destroy",function(){if(f){f.cancel();}if(b){b.detach();}});});});}function H(){var g=this,b={msg:{mid:g.responseMid},fid:"Sent"},e=C.common.Utils.features,c=e.enabled("NotificationsV2");if(c){var Y=function(i,h){if(h==="view"){C.fire("openMessage",b);}};C.use("common-ui-notification-v2",function(h){h.common.ui.NotificationV2.notify(strings.str_comp_msg_sent,{type:"info",cbk:Y,duration:4000,speed:"fast"});});}else{var f=new C.common.ui.Notification({type:"fade",className:"top",parent:"shellcontent",parentType:"id"}),d=C.ui.Templates._shared_module_offscreen_bin_notification_notifications.send_success;f.on("clickEvent",function(h){switch(h.action){case"closeNotification":f.destroy();break;case"view":C.fire("openMessage",b);break;}});f.notify(S(d,null,null,null,strings),4000);}}C.extend(Z,C.mail.ui.BaseWidget,{NAME:"SendConfirmView",render:a,postrender:B,bindUI:W,showAbuse:P,showError:E,showCaptcha:K,showSuccess:I,retrySendMessageWithCaptcha:A,backToMessage:V,retrySendMessage:J,doBlocked:G,bindSDO:R,_showDialog:M,_showNotification:H});C.namespace("mail");C.mail.SendConfirmView=Z;},"1.0.0",{requires:["_shared_module_offscreen_bin_notification_notifications","_shared_module_send_confirm_captcha_blocked","_shared_module_send_confirm_rollup","common-ui-notification","common-utils","comms-lozenge-address","comms-ui-lozenge","mail-controller-sendconfirm","mail-platform","mail-ui-searchbar","minty_module_toolbar_inbox_sent_msg_rollup","mail-common-utils-features"]});
