YUI.add("mail-compose-syncer",function(e){function i(e,t){n(e.folder.id.length>0,"Syncer requires draft.folder.id"),this.draft=e,this.service=t,this.dirty=!1,e.setState("saved")}var t=e.common.Utils,n=t.verify,r=t.getVal;i.prototype={save:function(r){var i=this,s=i.draft,o=(new Date).getTime(),u,a;if(s.state!=="unsaved")return;e.fire("stat:feature_invoke",{feature_group:"SAVE",message:"UI_SAVE_V3_START_SUCCESS"}),t.features.enabled("compose_save_adr")&&e.fire("darlaEvent",{action:"compose_save"}),this.dirty=!1,s.setState("saving"),a=this.service.save(s,!1,r),a.then(function(r){n(!s.hasCsid()||s.csid===r.result.messageV2.csid,"csid invariant violated on svr response."),e.fire("stat:feature_complete",{feature_group:"SAVE",message:"UI_SAVE_V3_COMPLETE_SUCCESS"}),e.fire("stat:feature_latency",{feature_group:"SAVE",message:"UI_SAVE_V3_COMPLETE",value:(new Date).getTime()-o}),u=s.state,r.result.messageV2&&(s.lastSavedRawBody=r.result.messageV2.part[0]);if(!i.dirty){s.setState("saved");return}s.setState("saved"),s.setState(u),n(s.state==="unsaved","state inconsistent w/dirty flag")},function(n){if(s.state==="sending"){e.fire("stat:feature_complete",{feature_group:"SAVE",message:"UI_SAVE_V3_CANCELED_SUCCESS"});return}e.fire("stat:feature_fail",{feature_group:"SAVE",message:"UI_SAVE_V3_COMPLETE_FAILURE",visible:!0,api:"messageSave"}),s.setState("unsaved",n.errDetail)})},_getErrorDetail:function(t){var n={message:"SavingAndSending: transport failed",code:"unknown"},i,s;try{i=r(t,"res.response");if(i)return n.message=e.JSON.parse(t.res.response).error.message,n.code=e.JSON.parse(t.res.response).error.code,n;i=r(t,"sendResponse.res");if(i)return s=e.JSON.parse(i.responseText),s=e.JSON.parse(s.error.message),n=s.error,n;i=r(t,"saveResponse.res");if(i)return s=e.JSON.parse(i.responseText),s=e.JSON.parse(s.error.message),n=s.error,n}catch(o){return n.message="SavingAndSending: unknown error",n}return n},send:function(t){function u(){r.setState("final"),e.fire("stat:feature_complete",{feature_group:"SEND",message:"UI_SEND_V3_COMPLETE_SUCCESS"}),e.fire("stat:feature_latency",{feature_group:"SEND",message:"UI_SEND_V3_COMPLETE",value:(new Date).getTime()-i}),e.fire("SentSuccess",null,null,s)}function a(t){var i=n._getErrorDetail(t);if(r.state==="savingAndSending"&&r.isRejectedOnCaptcha()){r.setState("captchaing");return}r.state==="sending"&&i.code==="EC-4011"&&(n.draft.captcha=null,n.draft.captchaAnswer=null),e.fire("stat:feature_fail",{feature_group:"SEND",message:"UI_SEND_V3_COMPLETE_FAILURE",visible:!0,api:"messageSend"}),r.setState("unsaved",i)}function f(t){var i=t.errDetail;if(t.failure==="save"&&r.isRejectedOnCaptcha()){r.setState("captchaing");return}t.failure==="send"&&i.code==="EC-4011"&&(n.draft.captcha=null,n.draft.captchaAnswer=null);if(t.failure==="getCids"||t.failure==="sendGDM"){u(t);return}e.fire("stat:feature_fail",{feature_group:"SEND",message:"UI_SEND_V3_COMPLETE_FAILURE",visible:!0,api:"messageSend"}),r.setState("unsaved",i)}var n=this,r=n.draft,i=(new Date).getTime(),s,o;if(r.state==="saving"||r.state==="sending"||r.state==="savingAndSending"||r.state==="sent"||r.state==="final")return;e.fire("stat:feature_invoke",{feature_group:"SEND",message:"UI_SEND_V3_START_SUCCESS"}),e.fire("SentStart"),this.dirty=!1,!r.hasAttachmentsToReconcile()&&(r.state==="captchaing"||r.state==="saved"&&r.hasCsid())?(r.setState("sending"),s="message_send",o=t?this.service.sendBatch(r,!1):this.service.send(r)):(r.setState("savingAndSending"),s="message_sendSave",o=t?this.service.sendBatch(r,!0):this.service.saveAndSend(r)),o.then(u,t?f:a)},edited:function(){this.draft.state!=="sent"&&this.draft.state!=="final"&&(this.dirty=!0,this.draft.setState("unsaved"))},unedited:function(){this.dirty=!1,this.draft.setState("saved")},isSaving:function(){return this.draft.state==="saving"},isEdited:function(){return this.draft.state==="unsaved"}},e.namespace("mail.Compose").Syncer=i},"1.0.0",{requires:["common-utils","mail-common-utils-features"]});
YUI.add("mail-model-spellcorrections",function(B){function A(){this.corrections=null;this.correctionsHash=null;this.publish("correctionsChanged");}B.mix(A.prototype,{setCorrections:function(C){this.corrections=C;this.fire("correctionsChanged");},setCorrectionsHash:function(C){this.correctionsHash=C;}});B.augment(A,B.EventTarget,true,null,{prefix:"spell"});B.namespace("mail.Model").SpellCorrections=A;},"1.0.0",{requires:["event-custom","oop"]});YUI.add("mail-controller-spell-processor",function(F){var C=F.common.Utils;var A={PREFIX:"spell",MIDPREFIX:"misspell-",MAX_SUGG:5,ERROR_404:"<html><head><title>Yahoo! - 404 Not Found</title><style>",MARK:"mark",MISPELLREG:null,MAX_SPELL_TEXT:51200};var B={},E={"str_rte_check_spelling":"NO_OP","str_rte_spell_lang_auto_select":"asl","str_rte_spell_lang_english_us":"en_US","str_rte_spell_lang_english_uk":"en_GB","str_rte_spell_lang_english_ca":"en_CA","str_rte_spell_lang_arabic":"ar","str_rte_spell_lang_bengali":"bn","str_rte_spell_lang_bulgarian":"bg","str_rte_spell_lang_croatian":"hr","str_rte_spell_lang_czech":"cs","str_rte_spell_lang_danish":"da","str_rte_spell_lang_dutch":"nl","str_rte_spell_lang_estonian":"et","str_rte_spell_lang_filipino":"tl","str_rte_spell_lang_finnish":"fi","str_rte_spell_lang_french_canada":"fr_CA","str_rte_spell_lang_french_france":"fr_FR","str_rte_spell_lang_french_switzerland":"fr_CH","str_rte_spell_lang_german_austria":"de_AT","str_rte_spell_lang_german_switzerland":"de_CH","str_rte_spell_lang_german_germany":"de_DE","str_rte_spell_lang_greek":"el","str_rte_spell_lang_gujarati":"gu","str_rte_spell_lang_hebrew":"he","str_rte_spell_lang_hindi":"hi","str_rte_spell_lang_hungarian":"hu","str_rte_spell_lang_indonesian":"id","str_rte_spell_lang_italian":"it","str_rte_spell_lang_kannada":"kn","str_rte_spell_lang_latvian":"lv","str_rte_spell_lang_lithuanian":"lt","str_rte_spell_lang_malay":"ms","str_rte_spell_lang_malayalam":"ml","str_rte_spell_lang_marathi":"mr","str_rte_spell_lang_norwegian_bokmal":"nb","str_rte_spell_lang_norwegian_nynorsk":"nn","str_rte_spell_lang_polish":"pl","str_rte_spell_lang_portuguese_brazil":"pt_BR","str_rte_spell_lang_portuguese_portugal":"pt_PT","str_rte_spell_lang_romanian":"ro","str_rte_spell_lang_russian":"ru","str_rte_spell_lang_serbian":"sr-cyrl","str_rte_spell_lang_slovak":"sk","str_rte_spell_lang_slovenian":"sl","str_rte_spell_lang_spanish":"es","str_rte_spell_lang_swedish":"sv","str_rte_spell_lang_tamil":"ta","str_rte_spell_lang_telugu":"te","str_rte_spell_lang_turkish":"tr","str_rte_spell_lang_ukrainian":"uk","str_rte_spell_lang_vietnamese":"vi"};var D={"en-US":"en_US","en-GB":"en_GB","en-CA":"en_CA","en-JO":"en_US","en-IN":"en_GB","ko-KR":"en_GB","en-SG":"en_GB","zh-Hant-TW":"en_GB","zh-Hant-HK":"en_GB","en-AU":"en_GB","en-NZ":"en_GB","en-MY":"en_GB","en-IE":"en_GB","en-PH":"en_GB","zh-CN":"en_GB","en-XC":"en_GB","en-035":"en_GB","th-TH":"en_GB","es-CL":"en_GB","es-US":"es","es-AR":"es","es-PE":"es","es-VE":"es","es-CO":"es","es-MX":"es","ar-JO":"ar","bn-BD":"bn","bg-BG":"bg","hr-HR":"hr","cs-CZ":"cs","da-DK":"da","nl-BE":"nl","nl-NL":"nl","et-EE":"et","tl-PH":"tl","fi-FI":"fi","fil-PH":"tl","fr-BE":"fr_FR","fr-CA":"fr_CA","fr-FR":"fr_FR","fr-CH":"fr_CH","de-AT":"de_AT","de-CH":"de_CH","de-DE":"de_DE","el-GR":"el","gu-IN":"gu","he-IL":"he","hi-IN":"hi","hu-HU":"hu","id-ID":"id","it-IT":"it","kn-IN":"kn","lv-LV":"lv","lt-LT":"lt","ms-MY":"ms","ml-IN":"ml","mr-IN":"mr","nb-NO":"nb","nn-NO":"nn","pl-PL":"pl","pt-BR":"pt_BR","pt-PT":"pt_PT","ro-RO":"ro","ru-RU":"ru","sr-Cyrl-RS":"sr-cyrl","sk-SK":"sk","sl-SI":"sl","es-ES":"es","sv-SE":"sv","ta-IN":"ta","te-IN":"te","tr-TR":"tr","uk-UA":"uk","vi-VN":"vi"};function G(){this.spellHelper=A;}F.mix(G.prototype,{checkSpelling:function(N,K,M,H,I){var O=this,T=this.getLangSymbol(H);if(T==="NO_OP"){return;}if(T===""||T==="asl"){T=false;}if(T==="fr_CA"){T="fr_FR";}var L=function(W){var V=(W)?F.JSON.parse(W.responseText):null;O._saveMisspelledWords(N,V);};var S={success:function(W){var V=(W)?F.JSON.parse(W.responseText):null;O._saveMisspelledWords(N,V);},failure:function(){},responseType:"text",args:{}};S.success=(I)?I:L;var Q=K.replace(/%/g,"%25");if(Q&&Q.length>A.MAX_SPELL_TEXT){Q=Q.substring(0,A.MAX_SPELL_TEXT);}if(Q.match(/<var.*yui-ie-cursor.*var>/g)){Q=Q.replace(/<var.*yui-ie-cursor.*var>/g,"");}var J={};J.text=Q;J.iformat="html";J.oformat="js";J.intl=M;J.lang=T;var P=NeoConfig.launch_protocol+document.location.host;var R=P+"/ysp.php";var U=F.common.net.SessionMgr.request(R,F.common.net.SessionMgr.formatQueryParams(J),S,"POST");U.setHeader("Content-Type","application/x-www-form-urlencoded");U.setHeader("Connection","close");U.send();},markMisspelledWords:function(N,H,Q){var O="";if(H&&H.length){var K=H.length;var J=0;var R="";var I=null,P=null;var L=0;for(var M=0;M<K;++M){L=parseInt(H[M].offset,10);I=H[M].word;if(this._isWordIgnored(I,Q)){continue;}O+=N.substring(J,L);P=N.substring(L,L+I.length);if(I===P){O+=this._getMarkerHtml(A.MIDPREFIX+M,P);}else{O+=P;R+=I+"="+P+"|";}J=L+I.length;}if(R){}O+=N.substr(J,N.length);}return O;},_saveMisspelledWords:function(I,H){var K={};if(H&&H.length){var M=H.length;for(var J=0;J<M;++J){var L=H[J].word;K[L]=H[J];}}I.setCorrectionsHash(K);I.setCorrections(H);},removeAllMarkers:function(I,J){var H=(J&&J.toUpperCase)?J.toUpperCase():"";I.all("span[class='"+A.MARK+"']").each(function(L){if(L.get("id").indexOf(A.MIDPREFIX)!==-1){var K=L.get("text").toUpperCase();if(H!==""&&H!==K){return;}I.insert(L.get("innerHTML"),L);L.purge();L.remove();}});},removeMarker:function(I,H){var J=H.get("innerHTML");this.updateMarker(I,H,J);},updateMarker:function(K,H,J){if(J){var I=H.cloneNode(true);I.set("innerHTML",J);I.removeClass(A.MARK);H.purge();H.replace(I);}else{H.purge();H.remove();}},_getMarkerHtml:function(H,I){var J=[];J.push('<span id="');J.push(H);J.push('" class="');J.push(A.MARK);J.push('">');J.push(I);J.push("</span>");return J.join("");},getLangSymbol:function(K){var H="",J,I;if(C.isEmpty(B)){for(I in E){J=strings[I];if(J){B[J]=E[I];}}}if(K){H=B[K];}else{H=D[NeoConfig.lang];}return(H)?H:"";},_getHeaderIgnoredWord:function(K){var I="";if(K){var J=0,H=K.length,L;for(J=0;J<H;J++){L=K[J];I+=L.name+" "+L.email+" ";}}return I;},gatherIgnoreWords:function(O,N){var L="";O.all("img").each(function(P){if(P.hasAttribute("alt")){var Q=P.get("alt");L+=Q+" ";}});if(N.currentAddress){L+=N.currentAddress+" ";}L+=this._getHeaderIgnoredWord(N.from);L+=this._getHeaderIgnoredWord(N.to);
L+=this._getHeaderIgnoredWord(N.cc);L+=this._getHeaderIgnoredWord(N.bcc);var H=F.common.persist.UserData;var K=H.get("userSendPref.defaultFromAddress")||"",J=H.get("userSendPref.defaultFromName")||"",I=H.get("userSendPref.defaultID")||"",M=H.get("userSendPref.loggedInAlias")||"";L+=K+" "+J+" "+I+" "+M+" ";L=L.toUpperCase();L=L.replace(/[\x21-\x40\x5B-\x60\x7B-\x7E]/g," ");L=L.replace(/([^;])[-_\s]+/g,"$1|");return L?L.split("|"):[];},_isWordIgnored:function(J,I){if(I.length===0){return false;}J=J.toUpperCase();var H=F.Array.indexOf(I,J);return(H!==-1);}});F.namespace("mail.Controller").SpellProcessor=new G();},"1.0.0",{requires:["mail-model-spellcorrections","common-net-sessionmgr","common-persist-user-data","json-parse"]});YUI.add("mail-controller-composecontent-helper",function(e){function t(e){this.ctrl=e}e.mix(t.prototype,{attachFromBlob:function(t,n){var r=new e.mail.Models.Attachment(null,{file:t.blob,filename:t.name,size:n,disposition:"attachment"});this.ctrl.draft.addAttachment(r),this.ctrl.draft.setState("unsaved"),this.ctrl.save()},attachFromMessageData:function(t){var n=t.mid,r=t.partId*1,i=t.name,s=t.thumbnailurl||t.thumbnail,o;if(!(e.Lang.isNumber(r)&&e.Lang.isString(i)&&e.Lang.isString(n)&&e.Lang.isString(s)))return;o=new e.mail.Models.Attachment(n,{mid:n,partId:r,filename:i,thumbnailurl:s}),this.ctrl.draft.addAttachment(o),o.setState("uploaded"),this.ctrl.draft.setState("unsaved"),this.ctrl.save()},handleAttachment:function(e){var t=this;if(t.ctrl.willAttachmentOverflow(e.length))return;switch(e.type){case"attachment":t.attachFromMessageData(e.data);break;case"blob":t.attachFromBlob(e.data,e.length)}},handleInsertText:function(e){var t=e.data,n=this.ctrl.view.getRTE().rte;n.setCaret();switch(e.type){case"plain":n.insertText(t);break;case"html":n.isRich&&n.pushButton("insertHtml",t);break;default:throw"unknow dataTransfer content type "+e.type}},handleDataTransfer:function(e){var t=this,n=e.payload,r=e.payload&&e.payload.content;if(!(n&&n.action&&r&&r.type&&r.data&&r.length>=0))return;switch(n.action){case"attach":t.handleAttachment(n.content);break;case"insertText":t.handleInsertText(n.content);break;default:throw"unknow dataTransfer action"+n.action}t.ctrl.attachedUsingComposeAssist=e.payload.source==="compose_assist"}}),e.namespace("mail.Controller").ComposeContentHelper=t},"1.0.0",{requires:["mail-model-attachment"]});
YUI.add("mail-controller-inlineimage-processor",function(E){function B(){}function C(F){var G;if(!F.attachments){return 0;}G=F.attachments.reduce(function(H,I){return H+I.size();},0);return G;}function A(F){if(F&&F.attachments){F.attachments.filter(function(G){if((G.state()==="failed"||G.state()==="infected")&&G.isInline()){G.setState("deleted");}return true;});}}function D(H){var M=H.inlineImageNode,G=H.ctrl,F=H.lastExitCode,K=H.imageList,I=H.attachmentList,Q=M.getAttribute("data-id"),L=K.get(Q),O,P="",J,N;if(0!==F){return 1;}if(!L){return 1;}H.rteImagePlugin.setDraftModel(G.draft);O=L.get("attachment");if(O&&O.state()!=="pending"){O.setState("deleted");O=null;}if(!O){N=L.processedFile.size;if(G.isOverMaxFileSize(H.existingAttachmentSize+N)){G.view.showAttachmentSizeDialog("25");G.draft.fire("attachmentSizeOverflow");H.node.all(".rte-inline-unsaved-image").remove();return 1;}else{H.existingAttachmentSize=H.existingAttachmentSize+N;}O=new E.mail.Models.Attachment(null,{file:L.processedFile,filename:L.file.name,size:N,"disposition":"inline"});I.push(O);G.draft.addAttachment(O);L.set("attachment",O);}J=O.contentId().match(/\<(.+)\>/);if(J){P=J[1];}M.setAttribute("src","cid://"+P);M.addClass("rte-inline-saved-image");M.addClass(Q);return 0;}E.mix(B.prototype,{process:function(J,H){var K=J.getRteImagePlugin(),I=E.Node.create("<div>"+H+"</div>"),G,F;if(!K){return H;}F={ctrl:J,lastExitCode:0,existingAttachmentSize:C(J.draft),attachmentList:[],imageList:K.imageList,node:I,rteImagePlugin:K};I.all(".rte-inline-unsaved-image").each(function(L){F.inlineImageNode=L;F.lastExitCode=D(F);});I.all(".rte-inline-unsaved-image").removeClass("rte-inline-unsaved-image");if(1===F.lastExitCode){for(G=0;G<F.attachmentList.length;G++){F.attachmentList[G].setState("deleted");}}A(J.draft);H=I.get("innerHTML");return H;}});E.namespace("mail.Controller").InlineImageProcessor=new B();},"1.0.0",{requires:[]});YUI.add("mail-controller-compose-v3",function(e){function b(){var t=m.getVal(this,"view.editor.rte.element");if(!t)return;e.one(t).all("img").each(function(t){var n=t.getAttribute("data-id");n||t.setAttribute("data-id",e.common.Utils.guid())})}function w(e){var t=this;this.injectDataIdFromImages(),this.setDraftHeader(),this.setDraftBody(),t.syncer.save({suppressNotification:!!e,suppressStat:!!e})}function E(){var t=this;this.setDraftHeader(),this.setDraftBody({isSend:!0}),t._validateSend().then(function(){t.attachOnSend&&(t.draft.setState("unsaved"),t.attachOnSend=!1),t.syncer.send(!0),p.enabled("richcompose")&&!t.view.get("isQuickReply")&&t.draft.attachments&&t.draft.attachments.length&&e.fire("util:ymstats",{name:t.attachedUsingComposeAssist?"compose_assist_send_used":"compose_assist_send_notused"})})}function S(){var t=this,n=this.view.sendValidationHandlers,r=e.mail.Models.Validators.send,i=[],s,o;return o=r.validateNotUploadingAttachments(t.draft),o.valid?(o=r.validateCleanAttachments(t.draft),o.valid?(o=r.validateAddress(t.draft),o.valid?(o=r.validatePresenceOfRecipients(t.draft),o.valid?(o=r.validateNumberOfRecipients(t.draft),o.valid?(o=r.validateSpame(t.draft),o.valid?(o=r.validatePresenceOfContent(t.draft),o.valid||i.push(new Promise(function(e,t){n.handleEmptyMessage(e,t)})),o=r.validateCaptcha(t.draft),o.valid||i.push(new Promise(function(e,r){n.handleCaptcha(e,r,t.draft)})),p.enabled("attachInReply")&&t.attachInReply&&(o=r.checkForAttachment(t.draft),o.valid||i.push(new Promise(function(e,r){n.handleNewRecipients(e,r,t)}))),"saving"===t.draft.state&&(s=function(e,n){t.view.showComposeShim(!0),t.draft.once("stateChanged",function(r){"saving"===r.prev&&"saved"===r.next?e():(t.view.showComposeShim(!1),n())})},i.push(new Promise(s))),Promise.all(i)):(n.handleSpame(),Promise.reject())):(n.handleTooManyRecipients(),Promise.reject())):(n.handleNoRecipients(),Promise.reject())):(n.handleAddressInvalid(o.invalidAddress),Promise.reject())):(n.handleBadAttachments(o.cntInfected),t.view.tray.showError(),Promise.reject())):(n.handleUploadInProgress(),Promise.reject())}function x(){this.syncer.edited()}function T(){this.syncer.unedited()}function N(){return this.syncer.isSaving()}function C(){return this.syncer.isEdited()}function k(){return this.prePopulated}function L(e){var t=this.view.getFontInfo(),n=this.view.getRTEDocNode(),r=m.getVal(this.draft.origin,"yqtdPrefix"),i,s="",o="",l=!!e&&e.isSend;this.view._isSpellCheckActive()&&h.removeAllMarkers(n,null),this.view._isRTEActive()?(i=this.view.getContent(),s=a.process(i,r),l||(s=f.process(this,s)),s=a.wrap(s,t)):o=u.process(n),this.view.updateUploadForm&&(window.FormData===undefined||window.FileReader===undefined)&&this.view.updateUploadForm(),this.draft.setBody(o,s),this.view.dirty&&this.draft.setSpame("U")}function A(){var t=this.view.getHeader(),n=e.mail.Controller.mailComposeFromListHelper.getReplyTo;t.replyto={email:n(t.from.email),name:t.from.name},this.draft.setHeader(t)}function O(){this.edited(),this.save()}function M(){this.view.on("FullCompose:composeEvent",this.handleEvent,this)}function _(){var t,n,r=e.mail.ui&&e.mail.ui.MailView&&e.mail.ui.MailView.prototype,i=e.one("#shellcontent");this.parent&&(t=this.parent.all(".compose-loading-wrapper"),t&&t.remove(),this.view.render(this.parent),this.composeViewTainer=this.view.baseNode),this.view.on("attachmentUpload",this.handleFileUpload,this),this.view.on("dataTransfer",this.composeContentHelper.handleDataTransfer,this.composeContentHelper),this.view.on("attachmentUploadForm",this.handleFileUploadForm,this),this.draft.on("stateChanged",this.handleStateChange,this),this.view.neoFire("composeEvent",{action:"bindComplete",ccv:this}),n=this.getRteImagePlugin(),n&&(n.setDraftModel(this.draft),n.on("inline-image-updated",this.handleInlineImageAdded,this)),r&&!r.isToolBarFit()?i&&i.addClass("narrow-rightPV"):i&&i.removeClass("narrow-rightPV")}function D(e){var t,n,r=p.enabled("ccOnSend"),i=d.get("ccOnSend"),s;if(r){s=l.getDefaultFromAddress();if(i==="bcc"||i==="both"){e.bcc||(e.bcc=[]),n=!1;for(t=0;!n&&t<e.bcc.length;t++)e.bcc[t].email===s.email&&(n=!0);n||e.bcc.push(s)}if(i==="cc"||i==="both"){e.cc||(e.cc=[]),n=!1;for(t=0;!n&&t<e.cc.length;t++)e.cc[t].email===s.email&&(n=!0);n||e.cc.push(s)}}}function P(t,n){var r=this,i=new e.Mail.Models.Draft;return r.setDraftOrigin(i,t),n||r.setMessageFromAddress(i),t&&t.cbfn&&(this.prePopulated=t.cbfn(i,t)),n||c.insertSignature(i,v.get("userUIPref.useRichText")),i.folder.id=g(),n||r._setAutoCC(i),i}function H(e){var t=this,n=e.action;t.eventHandlers&&t.eventHandlers[n]&&t.eventHandlers[n](e)}function B(e){var t=new FileReader;return new Promise(function(n){t.onload=function(t){e.realSize=t.total,n()},t.onerror=function(){e.realSize=0,n()},t.readAsArrayBuffer(e)})}function j(t,n,r){var i=this,s=n.reduce(function(e,t){return e+t.size()},0),o=[],u=0;e.Array.each(t,function(e){o.push(i._findRealFileSize(e))}),Promise.all(o).then(function(){u=t.reduce(function(e,t){return e+t.realSize},0),typeof r=="function"&&r(s,u)})}function F(r){var i=this,o=this.draft.attachments,u=Promise.resolve();return i._determineSize(r.files,o,function(a,f){var l=s.get("largeFileUploaders"),c=r.files.filter(function(e){return e.realSize===0});if(c.length>0){i.view.showAttachmentEmptyDialog(c);return}i.isOverMaxFileSize(a+f)?l.length>0?u=l[0].upload(r.files).then(function(e){i.view.addCards(e)}):i.view.showAttachmentSizeDialog(t):o.length+r.files.length>n?i.view.showAttachmentCountDialog(n):(e.Array.each(r.files,function(t){i.draft.addAttachment(new e.mail.Models.Attachment(null,{file:t,filename:t.name,size:t.realSize}))}),i.edited(),i.save())}),u}function I(t){var r=this,i=t.inputEl,s=i.value||"",o=s.substr(s.lastIndexOf("\\")+1);r.draft.attachments.length+1>n?r.view.showAttachmentCountDialog(n):(r.draft.addAttachment(new e.mail.Models.Attachment(null,{inputEl:i,filename:o,size:1})),r.edited(),r.save())}function q(e){var r=this,i=r.draft.attachments,s=i.reduce(function(e,t){return e+
t.size()},0);return r.isOverMaxFileSize(s+e)?(r.view.showAttachmentSizeDialog(t),!0):i.length+1>n?(r.view.showAttachmentCountDialog(n),!0):!1}function R(e){var t=this,n;if(e.next==="sent"){var i;t.view.dirty=!1,n="closeAction",i=t.eventHandlers[n],i(e)}else e.next==="final"?t.autoAddContacts(t.draft):e.next==="captchaing"&&(t.captchaRetryCount>=r?(t.captchaRetryCount=0,t.draft.setState("unsaved",{code:"EP-4010"})):(t.captchaRetryCount++,t._validateSend().then(function(){t.syncer.send(!0)})["catch"](function(){t.draft.setState("saved")})))}function U(){var t=this;!NeoConfig.isAMT&&v.get("userSendPref.addUnknownContact")!=="prompt"&&e.use("mail-controller-contact-processor",function(e){e.mail.Controller.ContactProcessor.addContacts(t.draft)})}function z(e){var t=e.header||{};t.from=l.getDefaultFromAddress(),e.setHeader(t)}function W(e,t){t&&t.action&&t.fid&&t.oMsg&&e.setOrigin({action:t.action,fid:t.fid,oMsg:t.oMsg,parentMsg:t.parentMsg,forwardAsAttachment:t.forwardAsAttachment,ctxReq:null})}function X(e){this.parent=e}function V(e){var t=this;t.view.isSending=!1,t.view.resetSaveTimer(),e&&(t.view.dirty=!0,t.view.allowSend=!0),t.composeActive=!0}function $(){var e=m.getVal(this,"view.editor.rte.plugins"),t=0;if(!e)return null;for(t=0;t<e.length;t++)if(e[t].name==="inline-image-plugin")return e[t];return null}function J(e){return e>t}var t=26214400,n=50,r=2,i=e.common,s=e.Mail.Services.Plugins,o=e.mail.model.DataStore.Folders,u=e.mail.Controller.TextProcessor,a=e.mail.Controller.HtmlProcessor,f=e.mail.Controller.InlineImageProcessor,l=e.mail.Controller.ReplyProcessor,c=e.mail.Controller.SignatureProcessor,h=e.mail.Controller.SpellProcessor,p=e.common.Utils.features,d=e.mail.persist.MetaData,v=i.persist.UserData,m=i.Utils,g=function(){var e=""+o.getByName("Draft").folderInfo.index;return g=function(){return e},g()},y=function(t,n,r,i,s){this.parent=t,this.draft=this.initDraftModel(r,s),this.draft.folder.id=g(),this.eventHandlers=n||{},this.view=new e.mail.Views.Compose(this.draft,this,s,r,i),this.service=new e.Mail.Services.Compose(NeoConfig.V3MailboxId),this.syncer=new e.mail.Compose.Syncer(this.draft,this.service),this.composeContentHelper=new e.mail.Controller.ComposeContentHelper(this),this.captchaRetryCount=0,this.attachInReply=!0,n&&this.bindComposeEvent()};y.prototype={save:w,send:E,edited:x,unedited:T,isSaving:N,isEdited:C,isPopulated:k,setDraftHeader:A,setDraftBody:L,initDraftModel:P,setMessageFromAddress:z,setDraftOrigin:W,bindComposeView:_,bindComposeEvent:M,setParent:X,handleEvent:H,handleFileUpload:F,handleFileUploadForm:I,willAttachmentOverflow:q,handleStateChange:R,autoAddContacts:U,showCompose:V,_validateSend:S,isOverMaxFileSize:J,_findRealFileSize:B,_determineSize:j,_setAutoCC:D,getRteImagePlugin:$,handleInlineImageAdded:O,injectDataIdFromImages:b},e.namespace("mail.Controller").ComposeController=y},"1.0.0",{requires:["mail-ui-fullcompose-v3","mail-models-validators-send","mail-model-datastore","mail-models-draft","mail-model-attachment","mail-services-compose","mail-services-plugins","mail-compose-syncer","mail-controller-reply-processor","mail-controller-html-processor","mail-controller-text-processor","mail-controller-signature-processor","mail-controller-spell-processor","mail-ui-mailcompose-header-form-list-helper","mail-controller-composecontent-helper","mail-controller-inlineimage-processor","mail-common-utils-features","rte-file-utils","mail-ui-mailview-base"]});
YUI.add("mail-ui-rte-linkeditor-v3",function(G){var A=G.common.Utils.substitute;function D(){var I;if(window.getSelection){I=window.getSelection();if(I.getRangeAt&&I.rangeCount){return I.getRangeAt(0);}}else{if(document.selection&&document.selection.createRange){return document.selection.createRange();}else{if(document.body.createTextRange){return document.body.createTextRange();}}}return null;}function F(I){var J;if(I){if(window.getSelection){J=window.getSelection();J.removeAllRanges();J.addRange(I);}else{if(document.selection&&I.select){I.select();}}}}function C(J){var I=D();if(!I){return;}if(I.setStartAfter){I.setStartAfter(G.Node.getDOMNode(J));}else{I.moveToElementText(J);}I.collapse(true);window.getSelection().removeAllRanges();window.getSelection().addRange(I);}function H(I){var J;I=G.Lang.trim(I);if(!I||I===""){return"";}if(0===I.indexOf("//")){I="http:"+I;}else{if(-1===I.indexOf(":")){I="http://"+I;}}I=I.replace(/"/g,"%22").replace(/'/g,"%27");J=I.toLowerCase();if(J.substr(0,7)==="http://"||J.substr(0,8)==="https://"||J.substr(0,7)==="mailto:"||J.substr(0,6)==="ftp://"){return I;}return"";}function E(I){I.replace(G.Escape.html(I.get("text")));}var B=function(){B.superclass.constructor.apply(this,arguments);};G.extend(B,G.Plugin.Base,{initializer:function(){var K=this,J=this.get("host"),I;function M(O){var N=function(P){return P===I;};if(!O.target.ancestor("[contenteditable=false]",true,N)){O.preventDefault();K.editExistingLink(this);}}function L(){I=K._editor.frame.get("container");I.delegate("click",M,"a");var N=J.rte;N.addPlugin({pushButton:function(O,P){if(O.toLowerCase()==="createlink"&&!P){J.focus();K.createOrEditLinkInSelection();return true;}}});}this._editor=J;this.listeners=[];if(J.get("isReady")){L();return;}K.listeners.push(J.after("ready",L));},destructor:function(){G.each(this.listeners,function(I){I.detach();});this.listeners=[];}},{NAME:"linkEditor",NS:"linkEditor",ATTRS:{host:{value:false}}});G.mix(B.prototype,{_getSelection:function(){var I=window.getSelection();I.getSelected=function(){return G.all(I.anchorNode);};I.text=(function(){var L="",K,J;if(!I.isCollapsed&&I.rangeCount){J=I.rangeCount;for(K=0;K<J;++K){L=L+(I.getRangeAt(K).toString());}return G.Escape.html(L);}else{return"";}}());return I;},_execCommand:function(K,I,J){J=J||{};if(J.bypassOverrides){return this._editor.frame._execCommand(K,I);}else{return this._editor.frame.execCommand(K,I);}},_selectLink:function(){var M=this._getSelection(),J,L,K,I;if(!M.isCollapsed){J=M.getSelected();if(!J.size()){return null;}L=J.item(0);K=L.get("tagName");if(K==="A"){return L;}else{if(K==="FONT"&&L.get("parentNode").get("tagName")==="A"){return L.get("parentNode");}}return J.item(0).one("a");}if(M.getSelected().get("tagName")==="A"){L=M.anchorNode;I=document.createRange();M.selectNode(L.item(0).getDOMNode());}return L;},_showEditDialog:function(N,R,K){var P,S,L,O,J,Q;function M(Y){var X=G.one("input#newURL"),U=G.one("input#newDescription"),T=G.one("a#followLink"),W;Y.get("contentBox").addClass("link-editor-dialog");function V(Z){if(Z.keyCode===G.Node.DOM_EVENTS.key.eventDef.KEY_MAP.enter){Z.preventDefault();Y.fire("dialog:action",{dataAction:"ok"});}if(Z.keyCode===G.Node.DOM_EVENTS.key.eventDef.KEY_MAP.esc){Y.fire("dialog:action",{dataAction:"cancel"});}}L=X.on("keydown",V);T.on("click",function(a){var Z=X.get("value");Z=H(Z);a.preventDefault();if(!G.Lang.isString(Z)||Z.length===0){return;}window.open(Z);});if(NeoConfig.bidi){W=G.Intl.bidiDirection(U.get("value"));U.set("dir",W);U.plug(G.Plugin.BidiTextEntry);}P=Y;X.focus();X.select();}function I(){if(P){P.destroy();P=null;}F(Q);if(J){J.remove(true);G.all("span.yui-non").remove(true);}if(L){L.detach();}}S=this._getSelection();O=S.getSelected();Q=D();N=H(N);G.common.ui.DialogHelper.confirm({hd:strings.str_comp_createlink_link_options,bd:A(G.ui.Templates._shared_module_compose_link_editor.base,{defaultHREF:N,defaultDescription:R},null,null,strings),focusedNode:"input#newURL"},{ok:{handler:function(){var W=G.one("input#newURL"),V=W.get("value"),T=G.one("input#newDescription"),U=T.get("value")||V;if(!G.Lang.isString(V)){return;}I();K(H(V),G.Escape.html(U));},stopDestroy:true},cancel:{handler:function(){I();}}},M);},_fireLinkEvent:function(I){this.get("host").fire("link",{node:I,linkSource:"link-editor"});},_findAnchor:function(J){var L=J.one("a"),I=J.ancestor(),K=function(M){return M.get("tagName").toUpperCase()==="A"?true:false;};J=K(J)?J:null;I=K(I)?I:null;return J||L||I;},_createLink:function(K,N,M){var L,O,I,J;this._execCommand("createlink",K,{bypassOverrides:true});L=this._getSelection();O=L.getSelected();if(L.isCollapsed||!L.anchorNode){this._execCommand("insertandfocus",'<a id="link-editor-new-anchor" href="'+K+'">'+G.Escape.html(N)+"</a>");I=G.one("#link-editor-new-anchor");I.removeAttribute("id");if(I&&K.indexOf("http")===0){this._fireLinkEvent(I);}return;}J=this._findAnchor(O.item(0));if(J&&M&&K.indexOf("http")===0){J.set("text",N);this._fireLinkEvent(J);}I=O.item(0).one("a");if(I){O.item(0).replace(I);J=I;}C(J);},editExistingLink:function(I){var J=(I.one("img")!==null);function K(L,M){if(!L){E(I);return;}I.set("href",L);if(!J){I.setContent(M);}}if(!J){this._showEditDialog(I.get("href"),G.Escape.html(I.get("text")),K);}},createOrEditLinkInSelection:function(){var L=this,K="",M,I=L._selectLink();if(I&&I.get("href")){K=I.get("href");M=I.get("text");}else{M=L._getSelection().text;}function J(P,O){var N;if(!I&&!P){return;}if(!P){E(I);return;}if(I&&G.UA.gecko){N=L._getSelection();E(I);L._execCommand("inserthtml",'<a href="'+P+'">'+G.Escape.html(N.text.trim())+"</a>");return;}L.get("host").rte.createLink(P,O);}L._showEditDialog(K,M,J);}});G.namespace("mail.rte").LinkEditor=B;},"1.0.0",{requires:["plugin","common-ui-dialog-helper","_shared_module_compose_link_editor","escape"]});YUI.add("rte-inline-image",function(C){var B=function(F,E,D){this.canvas=document.createElement("canvas");this.canvasContext=this.canvas.getContext("2d");this.file=F;this.isGIF=(F.type==="image/gif");this.genType=(F.type==="image/png")?("image/png"):("image/jpeg");this.src=URL.createObjectURL(this.file);this.processedFile=this.file;this.onready=(typeof(E)==="function")?E:(function(){});this.onerror=(typeof(D)==="function")?D:(function(){});this._loadImage();this.scaledSize=0;};B.prototype={set:function(D,E){if(D!=="file"){this[D]=E;}},get:function(D){return this[D];},jpegMarkers:{"mark":255,"startOfImage":216,"endOfImage":217,"app0":224,"app1":225,"app2":227,"app3":227,"sos":218,"dri":221},html:function(D){var E='<p><img style="display:block;margin:5px;"  src="{src}" alt="inline-image"/></p>';return E.replace("{src}",this.processImage([{type:"scale",maxSide:D}]));},_loadImage:function(){var E=this;var D=new Image();D.onload=function(){E.originalImage=D;E.width=E.originalImage.width;E.height=E.originalImage.height;E.scaledSize=Math.max(E.width,E.height);if(/image\/jpeg/.test(E.file.type)){E._buildExifString(function(G,F){E.exifbase64String=F;E.onready();});}else{E.onready();}};D.onerror=function(){E.originalImage=null;E.onerror();};D.src=this.src;},_scaleWithPresevedRatio:function(M,F,D){var J,E,I,H,L=M/D,K=F/D,G=Math.max(L,K);if(G>1){J=M/G;E=F/G;}else{J=M;E=F;if(K<L){D=M;}else{D=F;}}I=(D-J)/2;H=(D-E)/2;return{side:D,w:Math.floor(J),h:Math.floor(E),x:0,y:0};},_buildExifString:function(F){var D=new FileReader();var E=this;if(typeof(F)!=="function"){F=(function(){});}D.onloadend=function(){var I=new DataView(D.result),K=2,J=0,M=I.byteLength,H,N,G,L=[];if(I.getUint16(0)!==65496){return F("invalid marker","");}while(K<M){if(I.getUint8(K)!==E.jpegMarkers.mark){return F("fatal:invalid marker found","");}H=I.getUint8(K+1);if(H===E.jpegMarkers.app1||H===E.jpegMarkers.app2){N=K;G=N+(I.getUint16(K+2)+2);for(J=N;J<G;J++){L.push(String.fromCharCode(I.getUint8(J)));}K=G;}else{if(H===E.jpegMarkers.sos){break;}else{K+=2+I.getUint16(K+2);}}}return F(null,window.btoa(L.join("")));};D.readAsArrayBuffer(E.file);},processImage:function(D){var E=0,F;for(E=0;E<D.length;E++){switch(D[E].type){case"scale":this._scaleImage(D[E].maxSide);break;}}if(this.isGIF){return;}F=this.canvas.toDataURL(this.genType,1);this.processedFile=this.dataURItoBlob(F,this.exifbase64String);this.processedFile.name=this.file.name;if(/^blob:.+/.test(this.src)){URL.revokeObjectURL(this.src);}this.set("isEdited",true);this.src=URL.createObjectURL(this.processedFile);return this.src;},willSignificantlyScale:function(H){if(!this.originalImage){return false;}var D=this.originalImage,G=this._scaleWithPresevedRatio(D.width,D.height,H),E=this._scaleWithPresevedRatio(D.width,D.height,this.scaledSize),F=Math.abs(G.w-E.w)+Math.abs(G.h-E.h);if(F>20){return true;}return false;},_scaleImage:function(H){var F,G=this,D=G.originalImage,E="transparent";if(!D){return"";}F=G._scaleWithPresevedRatio(D.width,D.height,H);G.canvas.width=F.w;G.canvas.height=F.h;G.canvasContext.fillStyle=E;G.canvasContext.fillRect(0,0,F.w,F.h);G.canvasContext.drawImage(D,F.x,F.y,F.w,F.h);G.width=F.w;G.height=F.h;G.scaledSize=H;},dataURItoBlob:function(J,N){var G=J.match(/^data:(.+)?;(.+?),/),I,D,L,E,M,K,H,O=null,F=0;if(!G){return"";}L=J.split(",")[1];if(G[2]==="base64"){I=atob(L);}else{I=window.unescape(L);}K=I.length;D=G[1];if(N&&D==="image/jpeg"){H=atob(N);K=K+H.length+2;}E=new Uint8Array(K);for(M=0,F=0;M<K;M++){if(M>=3&&I.charCodeAt(M)===255&&H&&O===null){O=0;}if(O===null){E[M]=I.charCodeAt(F);++F;}else{if(O<H.length){E[M]=H.charCodeAt(O);++O;}else{E[M]=I.charCodeAt(F);++F;}}}if(N&&D==="image/jpeg"){E[M]=255;E[M+1]=217;}return new Blob([E],{type:D});},destroy:function(){var D=this.src&&this.src.match(/url\((.+)\)|^(blob:.+)/);if(D){URL.revokeObjectURL(D[1]||D[2]);}}};C.augment(B,C.EventTarget);var A=function(){};A.prototype={list:{},get:function(D){return this.list[D];},_add:function(E){var D="inline-image-guid-"+C.common.Utils.guid(),G=this,F=new Promise(function(H){var I=function(){G.list[D].set("key",D);H(G.list[D]);};G.list[D]=new B(E,I,I);});return F;},add:function(F){var E=0,G=this,D=[];if(C.Lang.isArray(F)||(F instanceof window.FileList)){for(E=0;E<F.length;E++){D.push(G._add(F[E]));}}else{D.push(G._add(F));}return Promise.all(D);},remove:function(D){this.list[D].destroy();delete this.list[D];},hasKey:function(D){return !!this.list[D];}};C.augment(A,C.EventTarget);C.namespace("mail.rte").inlineImage={List:A,ImageInline:B};},"0.0.1",{requires:["common-utils","escape","event-custom"]});YUI.add("_shared_module_rte_well_content_inline_image_ctrl_overlay",function(A){A.namespace("ui.Templates");A.ui.Templates._shared_module_rte_well_content_inline_image_ctrl_overlay={base:'<div class="inline-image-select-wrap" tab-index="-1" style="display:none;"> <div class="image-tools"> <button class="icon icon-shrink" data-action="inline-image-toggle-size" title="{{str_comp_inline_image_attach_btn_title_resize}}"></button> <button class="icon icon-close" data-action="remove-inline-image" title="{{str_comp_inline_image_attach_btn_title_remove}}"></button> </div></div>'};},"1.0.0");YUI.add("_shared_module_rte_well_content_inline_image_markup",function(A){A.namespace("ui.Templates");A.ui.Templates._shared_module_rte_well_content_inline_image_markup={base:'<img class="ymail-preserve-class rte-inline-unsaved-image {{key}}" src="{{src}}" data-id="{{key}}" alt="{{str_comp_inline_image_attach_image_alt}}" style="width:100%;max-width:{{width}}px;max-height:{{height}}px;"/><br/>'};},"1.0.0");YUI.add("_shared_module_rte_well_content_inline_image_saved",function(A){A.namespace("ui.Templates");A.ui.Templates._shared_module_rte_well_content_inline_image_saved={base:'<img class="rte-inline-saved-image {{dataID}}" data-id="{{dataID}}" src="{{sourceUrl}}">'};},"1.0.0");YUI.add("mail-rte-inline-image-plugin",function(e){var t=e.mail.rte.fileUtil,n=e.common.Utils.settings,r=e.common.Utils.substitute,i=!1,s=function(){function u(t){this.editor=t,this.editorNode=e.one(t.element),this.imageList=new e.mail.rte.inlineImage.List,this.currentNode=null,this.selectOverlayNode=null,this.init(),this._state="saved",this.ONCE={}}var s=e.Array.hash(["saved","uploading"]),o={large:800,small:400};return u.prototype={___setSizes:function(e){o=e},setState:function(e){var t=!!s[e];t&&(this._state=e,this._state==="uploading"&&this.fire("inline-image-updated"))},getState:function(){return this._state},isImageWithDataUri:function(e){var t=(e&&e.get("tagName")||"").toLowerCase()==="img",n;return t?(n=(e&&e.get("src")||"").toLowerCase().replace(/^\s*/,""),n.indexOf("data:")===0||n.indexOf("webkit-fake-url:")===0):!1},disableImageResizing:function(){document.execCommand("enableObjectResizing",!1,!1)},getHtmlFromImageInline:function(e){var t,n=[],r=[],i=this;for(t=0;t<e.length;t++){if(!e[t].originalImage){r.push(e[t].file);continue}e[t].processImage([{type:"scale",maxSide:o.large}]),n.push(i._getImageHtml(e[t]))}return i.editor.passNonImagesToTray(r),n.join("")},getPromiseToHandleDataUriPaste:function(n){var r=n.getAttribute("src"),i,s=this,o;return i=t.getFileFromDataURI(r),i?(o=new Promise(function(t){var r=s.imageList.add(i);r.then(function(r){s._logCounters("images-pasted");var i=e.Node.create(s.getHtmlFromImageInline(r));n.replace(i),t()})}),o):(n.remove(),Promise.resolve())},_insertImage:function(e){var t=this.imageList.add(e),n=this,r;n.editor.saveUndo(),t.then(function(e){r=n.getHtmlFromImageInline(e),n.editor.pushButton("insertHtml",r),n.disableImageResizing(),n.setState("uploading")})},_getImageHtml:function(t){return r(e.ui.Templates._shared_module_rte_well_content_inline_image_markup.base,t,null,null,strings)},_isAttachmentInProgress:function(e){var t,n=this;return n.imageList.get(e)?(t=n.imageList.get(e).attachment,t?t.state()==="uploading"||t.state()==="pending"?!0:!1:!0):!1},_updateSavedInlineImage:function(e){var t=e.nodeToRead,n=e.nodeToWrite,r=e.isLiveDom,i,s,o=this;t.all(".rte-inline-saved-image").each(function(e){i=e.getAttribute("class").match(/inline-image-guid-[a-f0-9-]+/);if(i){s=i[0],e.setAttribute("data-id",s);if(o._isAttachmentInProgress(s))return;n.all("."+s).each(function(t){t.set("src",e.get("src")),t.hasClass("rte-inline-unsaved-image")&&r&&o._logCounters("image-saved"),t.removeClass("rte-inline-unsaved-image"),t.addClass("rte-inline-saved-image")})}else s=e.getAttribute("data-id"),s&&n.all("[data-id="+s+"]").each(function(t){t.set("src",e.get("src"))})})},_processSavedImage:function(t){var n=e.one(this.editor.element),r=this,i=e.Node.create("<div>"+t+"</div>"),s=function(t,n){if(n){if(n.hasCleanImgSrc)return!1;n.hasCleanImgSrc=!0}var s=e.Node.create("<div>"+t+"</div>");return r._updateSavedInlineImage({nodeToRead:i,nodeToWrite:s,isLiveDom:!1}),s.get("innerHTML")};i.all(".rte-inline-saved-image")._nodes.length>0&&(this._updateSavedInlineImage({nodeToRead:i,nodeToWrite:n,isLiveDom:!0}),e.fire("processedEditorHtml",{processHtml:s,rteNode:r.editor.element})),this.setState("saved")},expandSimpleTemplate:function(e,t){return e.replace(/\{(.+?)\}/g,function(e,n){return t[n]})},getHtmlUsingInlineAttachment:function(){var t=this.draft.attachments.filter(function(e){return e.disposition()==="inline"&&(e.state()==="saved"||e.state()==="uploaded")}),n,i,s,o,u=[],a,f,l;for(n=0;n<t.length;n++){s=t[n].getSavedInfo();if(!s||s.disposition!=="inline"||s.type!=="image")continue;l=s.hasOwnProperty("dataIds")&&(s.hasOwnProperty("tempDownloadUrl")||s.hasOwnProperty("downloadUrl"));if(!l)return!1;for(i=0;i<s.dataIds.length;i++)o=s.dataIds[i],f={dataID:o,sourceUrl:s.downloadUrl||s.tempDownloadUrl},a=r(e.ui.Templates._shared_module_rte_well_content_inline_image_saved.base,f,null,null,strings),u.push(a)}return u.join("")},_logCounters:function(t){e.fire("util:ymstats",{name:"inlineimage-operation-"+t})},getSizeBucket:function(e){var t=Math.floor(e/1024),n=Math.floor(t/100),r=Math.ceil(t/100);return n<1?"<=100KB":n>=20?">2MB":(r=r===n?r+1:r,"["+n+"00-"+r+"00)KB")},_getImageStats:function(){if(this.ONCE._getImageStats)return this.ONCE._getImageStats;var t=this.draft.attachments.filter(function(e){return e.disposition()==="inline"&&(e.state()==="saved"||e.state()==="uploaded")}),n,r,i,s,u,a,f=0,l=0,c=0,h=this;for(n=0;n<t.length;n++){i=t[n].getSavedInfo();if(!i||i.disposition!=="inline"||i.type!=="image")continue;e.fire("util:ymstats",{name:"inlineimage-sent-size",tags:{size_bucket:h.getSizeBucket(t[n].size())}}),u=i.hasOwnProperty("dataIds")&&(i.hasOwnProperty("tempDownloadUrl")||i.hasOwnProperty("downloadUrl"));if(!u)continue;for(r=0;r<i.dataIds.length;r++)s=i.dataIds[r],a=this.imageList.get(s),a&&(a.scaledSize===o.small?(++c,e.fire("util:ymstats",{name:"inlineimage-sent-small"})):(++l,e.fire("util:ymstats",{name:"inlineimage-sent-large"})),++f)}return this.ONCE._getImageStats={total:f,countLarge:l,countSmall:c},this.ONCE._getImageStats},_logSentStats:function(){var t=this._getImageStats();t.total>0&&e.fire("util:ymstats",{name:"inlineimage-sent",tags:t})},_handleDraftStateChange:function(e){var t;e.next==="saved"?(t=this.getHtmlUsingInlineAttachment(),t!==!1&&this._processSavedImage(t)):e.prev!=="sent"&&e.prev!=="final"&&(e.next==="sent"||e.next==="final")&&this._logSentStats()},clipDimension:function(e,t){e.left=Math.max(e.left,t.left),e.top=Math.max(e.top,t.top),e.right=Math.min(e.right,t.right),e.bottom=Math.min(e.bottom,t.bottom)},isSameDim:function(e,t){return e.left===t.left&&e.right===t.right&&e.top===t.top&&e.bottom===t.bottom},isTooSmall:function(e){return e.right-e.left<=10||e.bottom-e.top<=10},positionOverlay:function(){var t=this,n,r,i,s,o,u,a;if(!t.selectOverlayNode.getDOMNode())return;if(!t.currentNode){t.selectOverlayNode.hide();return}t.positionalNodes||(a=t.editorNode.ancestor(".threadpane"),t.positionalNodes={composeMessage:t.editorNode.ancestor(".compose-message"
),composeHeader:a&&a.one(".compose-header"),bottomToolbar:a&&a.one(".bottomToolbar")}),n=t.currentNode.get("region"),r=t.positionalNodes.composeMessage.get("region"),u=n,t.clipDimension(u,r),t.positionalNodes.composeHeader&&t.positionalNodes.bottomToolbar&&(s=t.positionalNodes.composeHeader.get("region"),i=t.positionalNodes.bottomToolbar.get("region"),o={top:s.bottom,left:s.left,bottom:i.top,right:i.right},t.clipDimension(u,o)),this.lastPosition=u,this.setExpandState(),this.isTooSmall(u)?t.selectOverlayNode.hide():(t.selectOverlayNode.setXY([Math.floor(u.left),Math.floor(u.top)]),t.selectOverlayNode.setStyles({width:Math.floor(u.right-u.left)+"px",height:Math.floor(u.bottom-u.top)+"px"}),t.showOverlay()),setTimeout(e.bind(t.positionOverlay,t),100)},_setCurrentImageUnsaved:function(){this.currentNode.removeClass("rte-inline-saved-image"),this.currentNode.addClass("rte-inline-unsaved-image")},_handleResizeClick:function(){var e=this,t,n,r;t=e.currentImageInline,n=t.scaledSize===o.small?o.large:o.small,t.processImage([{type:"scale",maxSide:n}]),r=n===o.large?"100%":"50%",e.currentNode.setStyles({maxWidth:t.width+"px",maxHeight:t.height+"px",width:r}),e.setExpandState(),e.setSelectedImageToOverlay(e.currentNode),i&&(e.currentNode.set("src",t.src),e._setCurrentImageUnsaved(),e.setState("uploading")),e._logCounters("image-resize")},_handleRemoveClick:function(){var e=this;e.collapseSelection(),e.editor.saveUndo(),e.currentNode.remove(),e.unsetImageToOverlay(),e._logCounters("remove"),e.setState("uploading"),e.setState("saved")},_handleSizeOverflow:function(){var t=e.one(this.editor.element);t.all(".rte-inline-unsaved-image").remove(),this._logCounters("size-overflow"),this.setState("saved")},bindDraftModel:function(){if(!this.draft)return;this.draft.on("stateChanged",this._handleDraftStateChange,this),this.draft.on("attachmentSizeOverflow",this._handleSizeOverflow,this)},setDraftModel:function(e){this.draft||(this.draft=e,this.bindDraftModel())},selectNode:function(e){var t=window.getSelection(),n=document.createRange();t.removeAllRanges(),n.selectNode(e),t.addRange(n)},collapseSelection:function(){window.getSelection()&&window.getSelection().collapseToStart()},_isInlineImageNode:function(e){return!e||!e.classList?!1:e.tagName==="IMG"&&e.classList.toString().indexOf("yahoo-ignore-inline-image")<0},_isInlineCardNode:function(t){var n=this,r=null,i=e.one(t);return!t||!t.classList?!1:(r=i.ancestor(function(e){return e._node.tagName==="DIV"&&e._node.classList.toString().indexOf("yahoo-compose-assist-card")>=0},!0,function(e){return e===n.editor.element}),r&&(r._node.contentEditable=!1),r)},bind:function(){var t=this,n='button[data-action="remove-inline-image"]',r='button[data-action="inline-image-toggle-size"]';this.selectOverlayNode.on("click",function(e){e.stopPropagation()}),this.selectOverlayNode.one(n).on("click",e.bind(t._handleRemoveClick,t)),this.expandNode=this.selectOverlayNode.one(r),this.expandNode.on("click",e.bind(t._handleResizeClick,t)),this.editorNode.on("scroll",e.bind(t.positionOverlay,t)),this.editor.element.addEventListener("click",function(e){var n=e.target,r=t._isInlineCardNode(n);t._isInlineImageNode(n)?(t.setSelectedImageToOverlay(e.target),e.stopPropagation()):r?(t.setSelectedImageToOverlay(r,!0),e.stopPropagation()):t.unsetImageToOverlay()}),this.editor.element.addEventListener("mousedown",function(e){t._isInlineImageNode(e.target)&&(t.selectNode(e.target),e.stopPropagation())}),this.editor.element.addEventListener("dragstart",function(e){t._isInlineImageNode(e.target)&&e.dataTransfer&&(e.dataTransfer.effectAllowed="none")})},setExpandState:function(){var e=this,t;if(!e.currentImageInline){e.expandNode.hide();return}t=e.currentImageInline.scaledSize===o.small?o.large:o.small,e.currentImageInline.willSignificantlyScale(t)?e.expandNode.show():e.expandNode.hide(),t===o.large?(e.expandNode.addClass("icon-expand"),e.expandNode.removeClass("icon-shrink")):(e.expandNode.removeClass("icon-expand"),e.expandNode.addClass("icon-shrink"))},showOverlay:function(){var e=this;setTimeout(function(){if(!e.selectOverlayNode.getDOMNode())return;e.selectOverlayNode.show()},100)},setSelectedImageToOverlay:function(t,n){var r=this,i=e.one(t),s=i.getAttribute("data-id");r.currentNode&&r.currentNode.removeClass("img-overlay-selected"),r.currentImageInline=r.imageList.get(s),r.currentNode=e.one(t),r.currentNode.addClass("img-overlay-selected"),n||r.selectNode(r.currentNode._node),r.selectOverlayNode.hide(),r.positionOverlay()},handlePastedImageDataUri:function(){var e=this,t=[];e.editorNode.all("img").each(function(n){e.isImageWithDataUri(n)&&t.push(e.getPromiseToHandleDataUriPaste(n))}),t.length>0&&Promise.all(t).then(function(){e.setState("uploading"),e.disableImageResizing()})},unsetImageToOverlay:function(){var e=this;e.currentNode&&e.currentNode.removeClass("img-overlay-selected"),e.currentNode=null,e.selectOverlayNode.hide()},init:function(){var t=this,i=r(e.ui.Templates._shared_module_rte_well_content_inline_image_ctrl_overlay.base,{},null,null,strings);t.selectOverlayNode=e.Node.create(i),t.editorNode.ancestor(".compose-message").appendChild(t.selectOverlayNode),t.bind(),n.value("inlineImageSizeMap")&&(o=n.value("inlineImageSizeMap"))},render:function(){},name:"inline-image-plugin",contentChanged:function(){this.handlePastedImageDataUri()},pushButton:function(e,t){var n=0,r=t&&t.length||0;if(e.toLowerCase()==="insert-inline-image"){for(n=0;n<r;n++)this._logCounters("image-dragdrop");this._insertImage(t)}}},u}();e.augment(s,e.EventTarget),e.namespace("mail.rte.plugins").InlineImagePlugin=s},"1.0.0",{requires:["node","rte-file-utils","rte-inline-image","event-custom","comms-utils","mail-common-utils-features","mail-common-utils-settings","_shared_module_rte_well_content_inline_image_ctrl_overlay","_shared_module_rte_well_content_inline_image_markup","_shared_module_rte_well_content_inline_image_saved"]});
YUI.add("_shared_module_rte_well_content_inline_image_drop_zone",function(A){A.namespace("ui.Templates");A.ui.Templates._shared_module_rte_well_content_inline_image_drop_zone={base:'<div class="rte-inline-image-dropzone"> <div class="dropzone-text"> <div class="icon icon-stationary"></div> <div>{{str_comp_inline_image_dropzone_text}}</div> </div></div>'};},"1.0.0");YUI.add("mail-ui-ym-rte",function(e){var t=e.mail.rte.fileUtil,n=e.common.Utils.substitute,r=function(){function r(e){for(var t in e)e.hasOwnProperty(t)&&(this[t]=e[t]);this.element||this.id&&(this.element=document.getElementById(this.id)),this.source||(this.sourceId?this.source=document.getElementById(this.sourceId):this.showSource=!1),this.undoStack=[],this.redoStack=[],this.plugins=[],this.selections=[],this.init()}var i={P:!0,DIV:!0,UL:!0,OL:!0};r.helpers={},r.plugins=[],r.prototype={showSource:!0,undo:!0,isRich:!0,processInlineImage:e.mail.Core.feature("inlineimage").isOn(),shouldTabIndent:!1,autoTabIndent:!0,showDropZone:function(t){var r,i=this,s=e.one(i.element).ancestor(".compose-message");if(!i.dropZoneNode||!i.dropZoneNode.getDOMNode())r=n(e.ui.Templates._shared_module_rte_well_content_inline_image_drop_zone.base,{},null,null,strings),i.dropZoneNode=e.Node.create(r),s.appendChild(i.dropZoneNode),i.dropZoneNode._node.addEventListener("drop",e.bind(t,i),!1);i.dragTimer&&(clearTimeout(i.dragTimer),i.dragTimer=null);if(s){var o={position:"relative"};i.composeView.get("isQuickReply")&&(o.maxHeight="600px",s.one(".inner").setStyles({maxHeight:"600px",minHeight:"100px"})),s.setStyles(o)}return i.isRich?i.dropZoneNode.removeClass("disable-drop"):i.dropZoneNode.addClass("disable-drop"),i.dropZoneNode.show(),i.dropZoneNode},hideDropZone:function(){var t=this;t.dragTimer=setTimeout(function(){var n=e.one(t.element).ancestor(".compose-message");t.dropZoneNode&&t.dropZoneNode.getDOMNode()&&(t.dropZoneNode.hide(),n&&(n.setStyles({position:null,maxHeight:null,minHeight:null,overflow:null}),n.one(".inner").setStyles({maxHeight:null,minHeight:null})),t.composeView&&t.composeView.doResizeRTE&&t.composeView.doResizeRTE())},100)},setCaret:function(){var e=this,t,n=window.getSelection();e.element.focus(),n.anchorNode||(t=document.createRange(),t.selectNodeContents(e.element),t.collapse(!1),n.removeAllRanges(),n.addRange(t))},passNonImagesToTray:function(e){var t=this.composeView;e&&e.length&&t&&t.fire("attachmentUpload",{files:e})},init:function(){function i(e){n.contentChanged.call(n,e)}function s(e){var r,s,o,u,a,f,l;n.undo&&n.saveUndo();if(!n.isRich){a=e.clipboardData;if(a){r=a.getData("text");if(!r||!r.length)r=a.getData("text/plain");if(!r){s=a.getData("html");if(!s||!s.length)s=a.getData("text/html");s&&n.convertToPlain&&(o=document.createElement("div"),o.innerHTML=s,r=n.convertToPlain(o,!1))}r&&n.pushButton("insertHTML","<p>"+n.formatPlaintextForDisplay(r)+"</p>")}else n.convertToPlain&&setTimeout(function(){var t,r;n.setHTML(n.convertToPlain(n.element,!0)),n.element.childNodes.length&&(t=n.element.childNodes[n.element.childNodes.length-1],r=document.createRange(),r.setStartBefore(t),r.setEndAfter(t),window.getSelection().removeAllRanges(),window.getSelection().addRange(r),window.getSelection().collapseToEnd()),i(e)},0);e.stopPropagation(),e.preventDefault();return}u=n.element.getElementsByTagName("*");for(f=0;f<u.length;f++)u[f].wasntPasted=!0;n.processInlineImage&&t.canProcessImage(e)?(n.pushButton("insert-inline-image",t.getFilteredFile(e,"image")),e.stopPropagation(),e.preventDefault()):n.processInlineImage&&t.doesClipboardContainFiles(e)&&(l=t.getImageFilesfrmClipBoard(e),l.length>0&&(n.pushButton("insert-inline-image",l),e.preventDefault())),setTimeout(function(){i(e)},0)}this.element.contentEditable=!0;var n=this;n.element.addEventListener("dragover",function(e){if(!t.dragObjContainsFiles(e)){e.stopPropagation();return}}),n.processOnDrop=function(r){n.hideDropZone(),e.fire("dropHandled",r);if(r.dataTransfer.getData("notNativeFile"))return;n.processInlineImage&&r.stopPropagation(),t.dragObjContainsFiles(r)&&r.preventDefault(),t.dragObjContainsOnlyImages(r)||n.passNonImagesToTray(t.getFilteredFile(r,"nonimage")),n.setCaret(),s(r)},n.processInlineImage&&(this.eventListeners.push(e.one("body").on("dragover",function(e){if(!t.dragShouldShowDropzone(e._event))return;n.showDropZone(n.processOnDrop)})),this.eventListeners.push(e.one("body").on("dragleave",function(){n.hideDropZone()})),this.eventListeners.push(e.on("dropHandled",function(){n.hideDropZone()}))),n.element.addEventListener("drop",n.processOnDrop,!1),n.element.addEventListener("paste",s,!1),n.element.addEventListener("keydown",i,!1),n.element.addEventListener("keyup",i,!1),n.element.addEventListener("keypress",i,!1),n.element.addEventListener("mouseup",i,!1),n.element.addEventListener("cut",function(e){setTimeout(function(){i(e)},0)},!1);for(var o=0;o<r.plugins.length;o++)n.addPlugin(new r.plugins[o](this));this.eventListeners.push(e.on("processedEditorHtml",e.bind(this.processUndoHistoryHtml,this)))},contentChanged:function(e){var t,n=this,r;e&&e.type==="mouseup"&&n.autoTabIndent&&(n.shouldTabIndent=!0);if(e&&(e.type==="paste"||e.type==="drop")){var i=n.element.getElementsByTagName("*"),s=[],o,a;for(t=0;t<i.length;t++)o=i[t],o.wasntPasted||(s.push(o),o.tagName==="TABLE"&&(a=o.parentElement?o.parentElement:o.parentNode,a&&(a.wasntPasted||a===this.element)&&parseInt(o.getAttribute("border"),10)===0&&o.setAttribute("border",1)));e.newElements=s}if(e&&e.type==="keydown"){e.keyIdentifier!=="Shift"&&e.keyIdentifier!=="Control"&&e.keyIdentifier!=="Alt"&&e.keyIdentifier!=="Meta"&&(e.keyCode!==32?n.deferredSaveUndo():n.saveUndo()),n.undo&&(e.keyCode===90&&!e.altKey&&(e.ctrlKey||e.metaKey)&&(e.shiftKey?(this.doRedo(),e.preventDefault()):(this.doUndo(),e.preventDefault())),e.keyCode===89&&(e.metaKey||e.ctrlKey)&&!e.shiftKey&&!e.altKey&&(this.doRedo(),e.preventDefault())),e.keyCode===13&&!e.shiftKey&&(u()?setTimeout(function(){document.execCommand("undo"),document.execCommand("redo")},0):document.queryCommandValue("formatBlock")===""&&document.execCommand("formatBlock",!1,"p"),n.undo&&n.saveUndo()),e.keyCode===9&&n.shouldTabIndent&&(n.undo&&n.saveUndo(),e.shiftKey?u()&&(e.preventDefault(),document.execCommand("outdent")):(e.preventDefault(),u()?document.execCommand("indent"):n.insertText("\u00a0\u00a0\u00a0\u00a0")),n.undo&&n.saveUndo()),(e
.ctrlKey||e.metaKey)&&e.shiftKey&&!e.altKey&&n.isRich&&e.keyCode!==37&&e.keyCode!==39&&e.keyCode!==86&&e.preventDefault();if((e.ctrlKey||e.metaKey)&&!e.altKey&&!e.shiftKey){switch(e.keyCode){case 66:r="bold";break;case 73:r="italic";break;case 85:r="underline"}r&&(e.stopPropagation(),e.preventDefault(),n.pushButton(r))}}n.fixLists();for(t=0;t<n.plugins.length;t++)n.plugins[t].contentChanged&&n.plugins[t].contentChanged(e);n.showSource&&n.source&&(n.source.value=n.niceifyHTML(n.element.innerHTML))},fixLists:function(){var e=this.element.getElementsByTagName("p"),t,n,r,i;for(var s=0;s<e.length;s++){t=e[s],n=t.children[0];if(t.children.length===1)if(n.tagName==="UL"||n.tagName==="OL"){r=f()===t,i=t.parentElement?t.parentElement:t.parentNode,n.dir=t.dir,n.setAttribute("data-setdir",t.getAttribute("data-setdir")),i.replaceChild(n,t);if(r){window.getSelection().removeAllRanges();var o=document.createRange();o.setStart(n,0),o.setEnd(n,1),window.getSelection().addRange(o),window.getSelection().collapseToEnd()}}}},pushButton:function(e,t){var n,i,s=!0,u=r.helpers.getSelectedNode(),a,f;if(u&&u.isContentEditable===!1)return;for(n=0;n<this.plugins.length;n++)if(this.plugins[n].pushButton&&this.plugins[n].pushButton(e,t))return;switch(e.toLowerCase()){case"ltr":this.setDir("ltr");break;case"rtl":this.setDir("rtl");break;case"bidi":this.setDir(t);break;case"swap":case"swapdir":this.setDir("swap");break;case"createlink":a=o(),h(a)?document.execCommand("createLink",null,a):document.execCommand("createLink",null,window.prompt("Link for '"+a+"'","http://www.yahoo.com")),f=this.currentNode(),f.tagName!=="A"&&(f=f.parentElement?f.parentElement:f.parentNode),f.tagName==="A"&&(i={type:"link",node:f});break;case"insertandfocus":case"inserthtml":this.focus(),c(t),s=!1;break;case"smiley":document.execCommand("insertImage",null,"https://s.yimg.com/ok/u/assets/img/emoticons/emo1.gif"),window.getSelection().collapseToEnd();break;case"insertImage":this.focus(),document.execCommand("insertImage",null,t),window.getSelection().collapseToEnd();break;case"undo":this.undo&&(this.doUndo(),s=!1);break;case"redo":this.undo?(this.doRedo(),s=!1):document.execCommand("redo",null,t);break;default:this.undo&&this.saveUndo(),document.execCommand(e,null,t)}this.contentChanged(i),s&&this.undo&&this.saveUndo()},createLink:function(e,t){e=e.replace(/"/g,"%22").replace(/'/g,"%27"),c('<a id="ymeditor-temporary-id" href="'+e+'">'+t+"</a>");var n=document.getElementById("ymeditor-temporary-id");return n.removeAttribute("id"),this.contentChanged({type:"link",node:n}),n},focus:function(){var t=e.one(this.element),n=t.one('[contenteditable="true"]');n||(n=t),n.focus()},autoBlock:function(){if(!u()){var e=document.queryCommandValue("formatBlock");if(e===""||e==="Normal")document.execCommand("formatBlock",!1,"p")||document.execCommand("formatBlock",!1,"<p>")}},setDir:function(e,t){this.autoBlock();var n=a(),r;n&&n.isContentEditable!==!1&&(e.toLowerCase()==="swap"&&(r=getComputedStyle(n).direction,r==="ltr"?e="rtl":e="ltr"),n.dir=e,n.setAttribute("data-setdir",!t))},niceifyHTML:function(e){return e=e.replace(/<div>/gi,"\n<div>"),e=e.replace(/<p>/gi,"\n<p>"),e=e.replace(/<br>/gi,"\n<br>\n"),e},addPlugin:function(e){this.plugins.push(e)},currentNode:function(){return window.getSelection().anchorNode},findBlock:function(e){return r.helpers.findBlock(e)},insertText:function(e){this.insertNode(document.createTextNode(e))},insertNode:function(e){var t=window.getSelection(),n=t.getRangeAt(0);n.deleteContents(),n.insertNode(e),n.selectNode(e),n.collapse(!1),t.removeAllRanges(),t.addRange(n),t.anchorNode.parentElement.normalize()},saveSelection:function(){var e=window.getSelection(),t=[],n;for(n=0;n<e.rangeCount;n++)t.push(e.getRangeAt(n));this.selections.push(t)},loadSelection:function(){var e=this.selections.pop(),t;if(e){t=window.getSelection(),t.removeAllRanges();for(var n=0;n<e.length;n++)t.addRange(e[n])}},getHTML:function(){var e=this.element.cloneNode(!0),t;for(t=0;t<this.plugins.length;t++)this.plugins[t].getHTML&&this.plugins[t].getHTML(e);for(t in i)if(i.hasOwnProperty(t)){var n=e.getElementsByTagName(t);for(var r=0;r<n.length;r++)n[r].removeAttribute("data-setdir")}return e.innerHTML},getContent:function(){return this.getHTML()},setHTML:function(e){this.element.innerHTML=e,this.contentChanged("sethtml")},getRawHTML:function(){return this.element.innerHTML},removeWrapperNode:function(e){var t=e.childNodes,n=window.getSelection().focusNode,r=window.getSelection().focusOffset,i=!1,s,o=e.parentElement?e.parentElement:e.parentNode,u=t.length;if(u){for(s=0;s<t.length;s++)t[s]===n&&(i=!0);var a=t[u-1];o.replaceChild(a,e);for(s=u-2;s>=0;s--){var f=t[s];o.insertBefore(f,a),a=f}}else o.removeChild(e);if(i){var l=document.createRange();l.setStart(n,r),l.setEnd(n,r),window.getSelection().removeAllRanges(),window.getSelection().addRange(l)}},loadState:function(e){this.isRich=e.isRich,this.setHTML(e.html);var t=window.getSelection(),n=document.createRange(),r=this.nodeFromTrace(e.trace);t.removeAllRanges(),r?(n.setStart(r,e.offset),n.setEnd(r,e.offset),n.collapse(!1),t.addRange(n)):this.focus();for(var i=0;i<this.plugins.length;i++)this.plugins[i].loadState&&this.plugins[i].loadState()},nodeFromTrace:function(e){var t=this.element;for(var n=0;n<e.length;n++){if(!t||!t.childNodes)return!1;t=t.childNodes[e[n]];if(!t)return!1}return t},saveState:function(){return{html:this.getRawHTML(),trace:this.getTrace(),offset:window.getSelection().anchorOffset,isRich:this.isRich}},doUndo:function(){if(!this.undo)return;var e=this.getRawHTML(),t;this.saveRedo();while(this.undoStack.length>1&&this.undoStack[this.undoStack.length-1].html===e)this.undoStack.pop();this.undoStack.length&&(t=this.undoStack[this.undoStack.length-1],this.loadState(t))},doRedo:function(){if(!this.undo)return;var e=this.getRawHTML(),t;if(this.redoStack.length&&this.undoStack[this.undoStack.length-1].html===e)while(this.redoStack.length){t=this.redoStack.pop(),this.loadState(t),this.undoStack.push(t
);if(this.getRawHTML()!==e)break}else this.redoStack=[]},saveUndo:function(){if(!this.undo)return;var e=this.getRawHTML();if(!this.undoStack.length||this.undoStack[this.undoStack.length-1].html!==e)this.undoStack.push(this.saveState()),this.redoStack=[]},saveRedo:function(){if(!this.undo)return;var e=this.getRawHTML();(!this.redoStack.length||this.redoStack[this.redoStack.length-1].html!==e)&&this.redoStack.push(this.saveState())},getTrace:function(e){e||(e=s());var t=[],n;while(e&&e!==this.element){n=e.parentElement?e.parentElement:e.parentNode;if(n)for(var r=0;r<n.childNodes.length;r++)if(n.childNodes[r]===e){t.splice(0,0,r);break}e=n}return t},rewriteUndoHistory:function(e,t){var n;for(n=0;n<this.undoStack.length;n++)this.undoStack[n].html=this.undoStack[n].html.replace(e,t);for(n=0;n<this.redoStack.length;n++)this.redoStack[n].html=this.redoStack[n].html.replace(e,t)},processUndoHistoryHtml:function(e){var t,n,r,i=[],s=0;if(typeof e.processHtml!="function"&&this.element!==e.rteNode.getDOMNode())return;r=function(){if(s>=i.length)return;n=e.processHtml(i[s].html,i[s]),n!==!1&&(i[s].html=n),s+=1,setTimeout(r,1)};for(t=0;t<this.undoStack.length;t++)i.push(this.undoStack[t]);for(t=0;t<this.redoStack.length;t++)i.push(this.redoStack[t]);setTimeout(r,1)},swapImageSrc:function(e,t){var n=this.element.getElementsByTagName("img");for(var r=0;r<n.length;r++)n[r].src===e&&(n[r].src=t);this.rewriteUndoHistory(new RegExp(e,"g"),t)},undoSaveTimer:null,firstUndoSave:!0,eventListeners:[],deferredSaveUndo:function(){var e=this;if(e.firstUndoSave){e.firstUndoSave=!1,e.saveUndo();return}e.undoSaveTimer&&(clearTimeout(e.undoSaveTimer),e.undoSaveTimer=null),e.undoSaveTimer=setTimeout(function(){e.saveUndo()},200)},destroy:function(){var e=0;for(e=0;e<this.eventListeners.length;e++)this.eventListeners[e].detach()}};var s=r.helpers.getSelectedNode=function(){return window.getSelection().anchorNode},o=r.helpers.getSelectedText=function(){var t;return document.selection?t=document.selection.createRange().text:window.getSelection&&(t=window.getSelection().toString()),t},u=r.helpers.isInList=function(t){t||(t=s());while(t){if(t.tagName==="LI")return!0;t=t.parentElement}return!1},a=r.helpers.findBlock=function(t){t||(t=s());while(t){if(i[t.tagName])return t;t=t.parentElement?t.parentElement:t.parentNode}return!1},f=r.helpers.findParagraph=function(t){t||(t=s());while(t){if(t.tagName==="P")return t;t=t.parentElement?t.parentElement:t.parentNode}return!1},l=function(e){var t,n;document.selection?(t=document.selection.createRange(),t.pasteHTML(e)):document.getSelection&&(t=document.getSelection().getRangeAt(0),n=document.createElement("span"),t.surroundContents(n),n.innerHTML=e)},c=r.helpers.insertHTML=function(t){document.execCommand("insertImage",null," ");var n=a(),r,i=n.getElementsByTagName("img"),s,o,u,f,c,h;for(h=0;h<i.length;h++)if(i[h].getAttribute("src")===" "){r=i[h];break}s=document.createElement("div"),s.innerHTML=t,o=r;if(!r){l(t);return}u=r.parentElement?r.parentElement:r.parentNode;while(s.children.length)f=s.children[0],u.insertBefore(f,o.nextSibling),o=f;r.parentElement.removeChild(r),window.getSelection().removeAllRanges(),c=document.createRange(),c.setStartAfter(o),c.setEndAfter(o),window.getSelection().addRange(c),window.getSelection().collapseToEnd()},h=r.helpers.isURL=function(t){var n=/(http|ftp|https):\/\/[\w-]+(\.[\w-]+)+([\w.,@?^=%&amp;:\/~+#-]*[\w@?^=%&amp;\/~+#-])?/;return n.test(t)};return r}();r.plugins.push(function(){function t(e){this.editor=e,this.init()}function n(t,n,r,i){var s=document.createRange(),o=i,u,a;return s.setStart(t,n),s.setEnd(t,r),window.getSelection().removeAllRanges(),window.getSelection().addRange(s),i.indexOf("http")!==0&&(i="http://"+i),i=i.replace('"',"%22").replace("'","%27"),s.deleteContents(),u=document.createElement("a"),u.href=i,u.innerHTML=o,s.insertNode(u),e.UA.webkit>0&&(a=document.createRange(),a.setStart(u,0),a.setEnd(u,1),window.getSelection().removeAllRanges(),window.getSelection().addRange(a)),window.getSelection().collapseToEnd(),u}return t.prototype={init:function(){},name:"auto-link-plugin",contentChanged:function(e){if(!this.editor.isRich)return;var t=/([a-z0-9-]+\.)+([a-z]{2,4})(\/+[a-z0-9_.\:\;@-]*)*(\?[\&\%\|\+a-z0-9_=,\.\:\;-]*)?([\&\%\|\+&a-z0-9_=,\:\;\.-]*)([\!\#\/\&\%\|\+a-z0-9_=,\:\;\.-]*){*/,r=/^(https?\:\/\/)[^\s]+/,i,s,o,u,a,f,l,c,h=this;if(e&&(e.type==="paste"||e.type==="keydown"&&(e.keyCode===13||e.keyCode===32))){i=h.editor.currentNode();if(!i)return;if(i.parentElement&&i.parentElement.tagName==="A")return;s=i.textContent,o=window.getSelection().anchorOffset,u=s.lastIndexOf(" ",o-1)+1,a=s.lastIndexOf("\u00a0",o-1)+1,a>u&&(u=a),u===-1&&(u=0),f=s.substring(u,o),l,r.test(f)?l=r.source:l="^www\\."+t.source,(new RegExp(l,"i")).test(f)&&(h.editor.undo&&h.editor.saveUndo(),c=n(i,u,o,f),h.editor.contentChanged({type:"link",node:c}),h.editor.undo&&h.editor.saveUndo())}}},t}()),r.plugins.push(function(){function e(e){this.editor=e,this.init()}function t(e){var t="[\ud83a\ud83b][\udc00-\udfff]|[\u0590\u05be\u05c0\u05c3\u05c6\u05c8-\u05ff\u0604\u0605\u0608\u060b\u060d\u061b-\u064a\u065f\u066d-\u066f\u0671-\u06d5\u06e5\u06e6\u06ee\u06ef\u06fa-\u070e\u0710\u0712-\u072f\u074b-\u07a5\u07b1-\u07ea\u07f4\u07f5\u07fa-\u0815\u081a\u0824\u0828\u082e-\u08ff\u200f\ufb1d\ufb1f-\ufb28\ufb2a-\ufd3d\ufd40-\ufdcf\ufdf0-\ufdfc\ufdfe\ufdff\ufe70-\ufefe]|\ud803[\udc00-\ude5f\ude7f-\udfff]|\ud802[\udc00-\udd1e\udd20-\ude00\ude04\ude07-\ude0b\ude10-\ude37\ude3b-\ude3e\ude40-\udf38\udf40-\udfff]",n=new RegExp(t);return n.test(e)}function n(e){var t="[\udb40-\udb43][\udc00-\udfff]|\ud802[\udd1f\ude01-\ude03\ude05\ude06\ude0c-\ude0f\ude38-\ude3a\ude3f\udf39-\udf3f]|\ud804[\udc80\udc81\udcb3-\udcb6\udcb9\udcba]|\ud803[\ude60-\ude7e]|\ud800[\udd01\udd40-\udd8a\udd90-\udd9b\uddfd]|[\ud83f\ud87f\ud8bf\ud8ff\ud93f\ud97f\ud9bf\ud9ff\uda3f\uda7f\udabf\udaff\udb3f\udb7f\udbbf\udbff][\udffe\udfff]|\ud83c[\udc00-\udc2b\udc30-\udc93\udd00-\udd0a]|[\0-@[-`{-\u00a9\u00ab-\u00b4\u00b6-\u00b9\u00bb-\u00bf\u00d7\u00f7\u02b9\u02ba\u02c2-\u02cf\u02d2-\u02df\u02e5-\u02ed\u02ef-\u036f\u0374\u0375\u037e\u0384\u0385\u0387\u03f6\u0483-\u0489\u058a\u0591-\u05bd\u05bf\u05c1\u05c2\u05c4\u05c5\u05c7\u0600-\u0603\u0606\u0607\u0609\u060a\u060c\u060e-\u061a\u064b-\u065e\u0660-\u066c\u0670\u06d6-\u06e4\u06e7-\u06ed\u06f0-\u06f9\u070f\u0711\u0730-\u074a\u07a6-\u07b0\u07eb-\u07f3\u07f6-\u07f9\u0816-\u0819\u081b-\u0823\u0825-\u0827\u0829-\u082d\u0900-\u0902\u093c\u0941-\u0948\u094d\u0951-\u0955\u0962\u0963\u0981\u09bc\u09c1-\u09c4\u09cd\u09e2\u09e3\u09f2\u09f3\u09fb\u0a01\u0a02\u0a3c\u0a41\u0a42\u0a47\u0a48\u0a4b-\u0a4d\u0a51\u0a70\u0a71\u0a75\u0a81\u0a82\u0abc\u0ac1-\u0ac5\u0ac7\u0ac8\u0acd\u0ae2\u0ae3\u0af1\u0b01\u0b3c\u0b3f\u0b41-\u0b44\u0b4d\u0b56\u0b62\u0b63\u0b82\u0bc0\u0bcd\u0bf3-\u0bfa\u0c3e-\u0c40\u0c46-\u0c48\u0c4a-\u0c4d\u0c55\u0c56\u0c62\u0c63\u0c78-\u0c7e\u0cbc\u0ccc\u0ccd\u0ce2\u0ce3\u0cf1\u0cf2\u0d41-\u0d44\u0d4d\u0d62\u0d63\u0dca\u0dd2-\u0dd4\u0dd6\u0e31\u0e34-\u0e3a\u0e3f\u0e47-\u0e4e\u0eb1\u0eb4-\u0eb9\u0ebb\u0ebc\u0ec8-\u0ecd\u0f18\u0f19\u0f35\u0f37\u0f39-\u0f3d\u0f71-\u0f7e\u0f80-\u0f84\u0f86\u0f87\u0f90-\u0f97\u0f99-\u0fbc\u0fc6\u102d-\u1030\u1032-\u1037\u1039\u103a\u103d\u103e\u1058\u1059\u105e-\u1060\u1071-\u1074\u1082\u1085\u1086\u108d\u109d\u135f\u1390-\u1399\u1400\u1680\u169b\u169c\u1712-\u1714\u1732-\u1734\u1752\u1753\u1772\u1773\u17b7-\u17bd\u17c6\u17c9-\u17d3\u17db\u17dd\u17f0-\u17f9\u1800-\u180e\u18a9\u1920-\u1922\u1927\u1928\u1932\u1939-\u193b\u1940\u1944\u1945\u19de-\u19ff\u1a17\u1a18\u1a56\u1a58-\u1a5e\u1a60\u1a62\u1a65-\u1a6c\u1a73-\u1a7c\u1a7f\u1b00-\u1b03\u1b34\u1b36-\u1b3a\u1b3c\u1b42\u1b6b-\u1b73\u1b80\u1b81\u1ba2-\u1ba5\u1ba8\u1ba9\u1c2c-\u1c33\u1c36\u1c37\u1cd0-\u1cd2\u1cd4-\u1ce0\u1ce2-\u1ce8\u1ced\u1dc0-\u1de6\u1dfd-\u1dff\u1fbd\u1fbf-\u1fc1\u1fcd-\u1fcf\u1fdd-\u1fdf\u1fed-\u1fef\u1ffd\u1ffe\u2000-\u200d\u2010-\u2070\u2074-\u207e\u2080-\u208e\u20a0-\u20b8\u20d0-\u20f0\u2100\u2101\u2103-\u2106\u2108\u2109\u2114\u2116-\u2118\u211e-\u2123\u2125\u2127\u2129\u212e\u213a\u213b\u2140-\u2144\u214a-\u214d\u2150-\u215f\u2189\u2190-\u2335\u237b-\u2394\u2396-\u23e8\u2400-\u2426\u2440-\u244a\u2460-\u249b\u24ea-\u26ab\u26ad-\u26cd\u26cf-\u26e1\u26e3\u26e8-\u26ff\u2701-\u2704\u2706-\u2709\u270c-\u2727\u2729-\u274b\u274d\u274f-\u2752\u2756-\u275e\u2761-\u2794\u2798-\u27af\u27b1-\u27be\u27c0-\u27ca\u27cc\u27d0-\u27ff\u2900-\u2b4c\u2b50-\u2b59\u2ce5-\u2cea\u2cef-\u2cf1\u2cf9-\u2cff\u2de0-\u2e31\u2e80-\u2e99\u2e9b-\u2ef3\u2f00-\u2fd5\u2ff0-\u2ffb\u3000-\u3004\u3008-\u3020\u302a-\u3030\u3036\u3037\u303d-\u303f\u3099-\u309c\u30a0\u30fb\u31c0-\u31e3\u321d\u321e\u3250-\u325f\u327c-\u327e\u32b1-\u32bf\u32cc-\u32cf\u3377-\u337a\u33de\u33df\u33ff\u4dc0-\u4dff\ua490-\ua4c6\ua60d-\ua60f\ua66f-\ua673\ua67c-\ua67f\ua6f0\ua6f1\ua700-\ua721\ua788\ua802\ua806\ua80b\ua825\ua826\ua828-\ua82b\ua838\ua839\ua874-\ua877\ua8c4\ua8e0-\ua8f1\ua926-\ua92d\ua947-\ua951\ua980-\ua982\ua9b3\ua9b6-\ua9b9\ua9bc\uaa29-\uaa2e\uaa31\uaa32\uaa35\uaa36\uaa43\uaa4c\uaab0\uaab2-\uaab4\uaab7\uaab8\uaabe\uaabf\uaac1\uabe5\uabe8\uabed\ufb1e\ufb29\ufd3e\ufd3f\ufdd0-\ufdef\ufdfd\ufe00-\ufe19\ufe20-\ufe26\ufe30-\ufe52\ufe54-\ufe66\ufe68-\ufe6b\ufeff\uff01-\uff20\uff3b-\uff40\uff5b-\uff65\uffe0-\uffe6\uffe8-\uffee\ufff0-\uffff]|\ud835[\udedb\udf15\udf4f\udf89\udfc3\udfce-\udfff]|\ud834[\udd67-\udd69\udd73-\udd82\udd85-\udd8b\uddaa-\uddad\ude00-\ude45\udf00-\udf56]"
,n=new RegExp(t);return n.test(e)}return e.prototype={init:function(){},name:"auto-bidi-plugin",contentChanged:function(e){if(!this.editor.isRich)return;var r,i,s,o,u=this;if(e&&e.type==="keypress"){r=u.editor.findBlock();if(r&&r.getAttribute("data-setdir")==="true")return;i=String.fromCharCode(e.charCode);if(n(i))return;if(r){var a=0;s=r.textContent.charAt(a);while(s.length>0&&n(s))s=r.textContent.charAt(a),a++;if(s.length>0&&s!==i)return}o=t(i);while(o===0)o=t(i);t(i)?u.editor.setDir("rtl",!0):u.editor.setDir("ltr",!0)}}},e}()),r.plugins.push(function(){function e(e){this.editor=e,this.init()}function n(e,t){var n=e.cloneNode(!0),i=r(n);return t&&(i=l(i,!0)),i}function r(e){return a(e),s(e,!1,"").replace(/\n[\s\xA0]+$/,"")}function i(e,t){return(new RegExp("(\\s|^)"+t+"(\\s|$)")).test(e.className)}function s(e,t,n){var r,a,f,l,c,h,p,d,v,m;if(i(e,"compose-ignore"))return"";if(e.nodeType!==1&&e.nodeType!==11)return e.nodeType===3?(r=e.nodeValue,t||(a=e.previousSibling,m=a?u(a):null,r=o(a)?r:r.replace(/\n[ \t\r\n\v\f]+/g," "),a===null||o(a)?r=r.replace(/^[ \t\r\n\v\f]+/,""):m==="block"?r=r.replace(/^[ \t\r\n\v\f]+/,"\n"):m==="inline"&&(r=r.replace(/^[ \t\r\n\v\f]+/," ")),r=r.replace(/[ \t\r\n\v\f]+$/," ")),r):"";f=e.tagName;switch(f){case"SCRIPT":case"STYLE":case"LINK":case"OBJECT":case"EMBED":return"";case"HR":return a=e.previousSibling,(o(a)?"":"\n")+n+"________________________________\n"+n;case"BR":return"\n"+n;case"BLOCKQUOTE":n+=">";default:r=[],l=e.firstChild,c=0;if(f==="SPAN"&&i(e,"Apple-tab-span"))return e.textContent;while(l!==null){h=s(l,l.tagName==="PRE",n);if(l.nodeType===1){u(l)==="block"&&r.length>0&&l.tagName!=="TD"&&(p=h.match(/^[ \t\r\n\v\f]*$/),(!p||l.tagName==="LI")&&r.push("\n"+n));switch(l.tagName){case"LI":c++,d="",v=l.parentNode;while(v&&(v.tagName==="OL"||v.tagName==="UL"))v=v.parentNode,d+="	";r.push(d+(l.parentNode.tagName==="OL"?c+".":"*")+" ")}}h&&r.push(h);if(l.nodeType===1)switch(l.tagName){case"TD":r.push(" ")}l=l.nextSibling}return r.join("")}}function o(e){return e===null||e.nodeType!==1?!1:e.tagName==="BR"}function u(e){if(e===null||e.nodeType!==1)return null;if(e.style.display){if(e.style.display==="block")return"block";if(e.style.display==="inline")return"inline"}return t[e.tagName.toLowerCase()]?"block":"inline"}function a(e){var t,n,r,i,s;if(e.nodeType===1||e.nodeType===11){t=e.firstChild;while(t!==null)s=t.nextSibling,a(t),t=s}else e.nodeType===3&&(n=e.nodeValue,n.match(/^[ \t\r\n\v\f]*$/)&&(r=e.previousSibling,i=r?u(r):"inline",i==="inline"&&!o(r)?e.nodeValue=e.nodeValue.replace(/\n.*/," "):e.parentNode.removeChild(e)))}function f(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function l(e,t){return e=f(e),t&&(e=e.replace(/\t/g,"&nbsp;&nbsp;&nbsp;&nbsp;"),e=e.replace(/( ) {2}/g,"&nbsp;&nbsp;")),e=e.replace(/\n/ig,"<br />"),e}e.prototype={init:function(){this.editor.convertToPlain=n,this.editor.formatPlaintextForDisplay=l},name:"plaintext-plugin",pushButton:function(e){if(e.toLowerCase()==="plaintext"){var t=n(this.editor.element,!0);return this.editor.element.innerHTML=t,this.editor.contentChanged(),!0}return!1}};var t={address:1,blockquote:1,body:1,caption:1,center:1,col:1,colgroup:1,dd:1,dir:1,div:1,dl:1,dt:1,fieldset:1,form:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,li:1,menu:1,ol:1,p:1,pre:1,table:1,tbody:1,td:1,tfoot:1,th:1,thead:1,tr:1,ul:1};return e}()),r.plugins.push(e.mail.rte.plugins.InlineImagePlugin),e.mail||(e.mail={}),e.mail.YMEditor=r},"0.0.1",{requires:["mail-rte-inline-image-plugin","event-custom","mail-common-utils-features","mail-common-utils-settings","_shared_module_rte_well_content_inline_image_drop_zone","comms-utils"]});
YUI.add("mail-ui-rteview-v3",function(D){var a="hidden",R,B,J;function H(Y){var j=this;H.superclass.constructor.call(j,Y);R=Y.bidi;B=Y.isFullSSL;J=Y.isRTL;j.rte=null;j.contentInitialized=null;j.focusNode=false;j.baseNode=null;j.rteReady=false;j.rteArea=null;j.composeView=Y.composeView;j.frame={get:function(){return j.getContainer();},getInstance:function(){return D;}};j.evt=[];j.set("isRich",Y.isRich);j.getDefaultFontInfo=Y.getDefaultFontInfo;j.convertToPlain=U;j.richFontInfo=j.getDefaultFontInfo(!Y.isRich);j.smartscroll=Y.smartscroll;var i={isRich:{setter:function(k){j.isRich=k;if(j.rte){j.rte.isRich=k;j.rte.saveUndo();}j.switchEditMode();if(j.rte){j.rte.saveUndo();}}},content:{setter:function(k){j.content=k;j.rte.getInstance().Selection.cleanCursor();if(j.baseNode){j.baseNode.fire("switchToPlain");}},getter:function(){return j.content?j.content:"";}}};j.addAttrs(i,Y||{});}function d(){var Y=D.mail.ui.MailView&&D.mail.ui.MailView.prototype,i=D.one("#shellcontent");if(Y&&!Y.isToolBarFit()){i&&i.addClass("narrow-rightPV");}else{i&&i.removeClass("narrow-rightPV");}}function U(Y,i){if(Y.getDOMNode){Y=Y.getDOMNode();}return this.rte.convertToPlain(Y,i);}function h(i){var j=this,Y;j.baseNode=i;j.rteArea=i.one("div.cm-rtetext");Y=j.rteArea.getDOMNode();D.Frame.DEFAULT_CSS="";j.rte=new D.mail.YMEditor({element:Y,isRich:j.isRich,composeView:j.composeView});j.rte.getInstance=function(){return D;};D.Plugin.ExecCommand.COMMANDS.fontsize=null;j.plug(D.mail.rte.LinkEditor);if(R){}j.bindUI();j.renderUI();if(/^\s+$/.test(Y.innerHTML)){Y.innerHTML="<p><br/></p>";}}function c(){var k=this,Y=k.evt;k.rteReady=true;var i={};k.rte.addPlugin({contentChanged:function(o){var n;if(o&&(o.type==="paste"||o.type==="drop")){if(o.newElements){E(D.all(o.newElements));}k.rte.saveUndo();}k.fire("nodeChange",o);if(o&&o.type==="link"){k.fire("link",{node:D.one(o.node)});}var m="mark";var l=k.getRTE().getInstance().all("span[class='"+m+"']");for(n in i){i[n]=false;}if(!l.isEmpty()){if(o==="sethtml"){i={};l.each(function(p){i[p.getHTML()]=true;});}else{l.each(function(p){if(p.getHTML() in i){i[p.getHTML()]=true;}else{k.rte.removeWrapperNode(p.getDOMNode());}});}}for(n in i){if(!i[n]){delete i[n];}}},pushButton:function(l){if(l==="createlink"){k.focus();k.linkEditor.createOrEditLinkInSelection();return true;}},loadState:function(){if(k.rte.isRich!==k.isRich){k.isRich=k.rte.isRich;k.switchEditMode();k.fire("updateIsRichToolbar");}k.fire("loadstate");}});Y.push(k.getContainer().after("windowresize",d));Y.push(k.getContainer().on("focus",function(){k.fire("focus",{editor:k.rte});}));Y.push(k.getContainer().on("blur",function(){k.fire("blur",{editor:k.rte});}));Y.push(k.getContainer().on("keydown",function(l){l.frameEvent=l;k.fire("keyDown",l);l.stopPropagation();}));Y.push(k.getContainer().on("keypress",function(l){l.stopPropagation();}));if(k.smartscroll){Y.push(new D.mail.rte.smartScroll({"rte":k,"topOverlaySelector":".thread-item-list"}));}if(k.contentInitialized){k.setContent(k.contentInitialized,false);}k.set("ready",true);k.fire("ready");k.getContainer().addClass(B?"fullSSL":"nonSSL");k.getContainer().setStyles(k.getComposeStyle(k.isRich));if(k.isRich){k.getContainer().setStyles({"fontSize":k.richFontInfo.fontSize,"fontFamily":k.richFontInfo.fontFamily});}else{k.getContainer().addClass("plaintextMsg");}var j=k.getContainer();if(j&&R&&J){j.set("dir","rtl");}}function C(){var Y=this;Y.rteArea=Y.baseNode.one("div.cm-rtetext");}function M(){var Y=this;if(D.UA.ie){Y.rteArea.setStyle("display","block");}Y.rteArea.setStyle("visibility","");}function Z(){var Y=this;if(D.UA.ie){Y.rteArea.setStyle("display","none");}Y.rteArea.setStyle("visibility",a);}function N(Y,i){var j=this;if(j.rte){j.rte.pushButton(Y,i);}}function O(m,j){var n=this,Y="",l=D.Selection.CURSOR,i=(!D.Lang.isUndefined(j))?j:true;l=(D.UA.ie===9)?"&nbsp;":D.Selection.CURSOR;if(i){Y="<p>"+l+"</p>";}else{Y="";}Y+=m;if(n.rteReady){n.rte.setHTML(Y);if(D.UA.ie&&D.UA.ie>=10){var k=n.getDoc().one("p .yui-cursor");if(k){k.remove(true);}}}else{n.contentInitialized=Y;}}function g(){return this.rte.getHTML();}function S(){return this.rte.get("content");}function W(){return this;}function Q(){return this.getContainer();}function P(){return this.getContainer();}function A(Y){if(this.rte){this.rte.focus(Y);}}function f(){var Y=this;D.each(Y.evt,function(i){i.detach();});delete Y.evt;Y.rte.destroy();delete Y.rte;H.superclass.ondestroy.call(this,arguments);}function K(){var j=this,Y,i;if(j.rte){i=j.isRich;Y=j.getDefaultFontInfo(!i);j.getContainer().setStyles(j.getComposeStyle(i));if(j.isRich){j.getContainer().removeClass("plaintextMsg");j.getContainer().setStyles({"fontSize":Y.fontSize,"fontFamily":Y.fontFamily});}else{j.getContainer().addClass("plaintextMsg");}}}function e(){var j=this,Y=j.getContainer();if(Y){var i=j.convertToPlain(Y,false);if(i){if(D.UA.ie){i=i.replace(/\xA0/gi," ");}return D.Lang.trim(i)!=="";}else{return false;}}return true;}function L(){var Y=this,i=this.getContainer();if(!i){return"";}return Y.convertToPlain(i,true);}function V(Y){var j=this,i=j.getDefaultFontInfo(!Y);if(Y){j.richFontInfo.fontFamily=i.fontFamily;j.richFontInfo.fontSize=i.fontSize;j.richFontInfo.foreColor="#000";j.richFontInfo.backColor="#fff";}return{"color":this.richFontInfo.foreColor,"background-color":j.richFontInfo.backColor};}function X(){return D.one(this.rte.element);}function F(Y,i){var j=this;if(j.rte&&(Y==="insertandfocus"||Y==="inserthtml")){j.rte.focus();}j.execute(Y,i);}function b(){return D;}function T(){if(this.rte){this.rte.focus();}}function I(i){var l=this,Y,k;if(i){if((i.get&&i.get("className")==="yahoo_quoted")||i.className==="yahoo_quoted"){return;}if(i.set){i.set("className","");}if(i.className){i.className="";}if(i.getDOMNode&&i.getDOMNode().childNodes){k=i.getDOMNode().childNodes;}else{if(i.childNodes){k=i.childNodes;}}if(k){for(Y=0;Y<k.length;Y++){l.clearClassNames(k[Y]);}}}}function E(i){var Y;i.each(function(j){if(j.get("tagName")==="STYLE"){j.remove();return;}if(!(j.hasClass("link-enhancr-attachment")||j.hasClass("ymail-preserve-class"))){j.setAttribute("class","");
j.setAttribute("className","");}Y=(j.getAttribute("style")||"").replace(/position\s*?:\s*?(fixed|absolute)/ig,"");j.setAttribute("style",Y);});}function G(o){var n=this,l="",p=false,i,j,r,m,Y,k;try{if(o.clipboardData){l=(o.originalEvent||o).clipboardData.getData("text/plain");n.execute("insertText",l);p=true;}else{if(window.clipboardData){l=window.clipboardData.getData("Text");i=window.getSelection();if(i.getRangeAt&&i.rangeCount){m=i.getRangeAt(0);m.deleteContents();j=document.createElement("div");j.innerHTML=l;r=document.createDocumentFragment();while((k=j.firstChild)){Y=r.appendChild(k);}m.insertNode(r);if(Y){m=m.cloneRange();m.setStartAfter(Y);m.collapse(true);i.removeAllRanges();i.addRange(m);}}p=true;}else{n.fire("paste");setTimeout(function(){n.setContent(n.convertToPlain(n.rteArea,true));},1);}}}catch(q){n.fire("paste");setTimeout(function(){n.setContent(n.convertToPlain(n.rteArea,true));},1);}if(p){o.stopPropagation();o.preventDefault();if(window.event){window.event.returnValue=false;}}}D.namespace("mail");D.extend(H,D.mail.ui.BaseWidget);D.augment(H,D.Plugin.Host);D.mail.RTEView=H;D.mix(D.mail.RTEView.prototype,{NAME:"RTE",_sanitizeHtml:E,_sanitizeText:G,render:h,renderUI:C,bindUI:c,execute:N,execCommand:N,windowResized:d,getRTE:W,getDoc:Q,getDocRoot:P,getContent:g,getContentOnSave:S,getComposeStyle:V,getContentAsPlainText:L,getContainer:X,setFocus:A,setContent:O,clearClassNames:I,switchEditMode:K,hasContent:e,getInstance:b,focus:T,hideArea:Z,showArea:M,ondestroy:f,invokeCommand:F},true);},"1.0.0",{requires:["attribute-base","event-base","node-base","node-event-delegate","common-utils","mail-ui-basewidget","mail-ui-rte-linkeditor-v3","mail-ui-rte-smartscroll","mail-ui-mailview-base","mail-ui-ym-rte"]});YUI.add("mail-ui-format-popout",function(e){function u(t){var i=n.get(r)!=="false";return function(s){s.halt(),i=!i,a(t,i),n.set(r,i.toString()),n.save(),i&&t.one(".tool.format-tool").focus(),e.fire("mt:click",{action:"cmps_wl_fmt_tlbr",append:{open:i?1:0}})}}function a(e,t){var n=e.one(".format-popout-icon.tool-icon"),r=e.one(".tool.format-tool"),u,a;if(!r)return;t?(a=parseFloat(e.getComputedStyle(i),10),u=e.get("region")[s]+a-n.get("region")[s],r.one(".popout").setStyle(s,o*u),r.addClass("show-popout"),n.addClass("active")):(r.removeClass("show-popout"),n.removeClass("active"))}function f(e){var t;this.formater=e,this._handlers=[],this.baseNode=e.editor.composeView.baseNode,t=this.baseNode.one(".bottomToolbar"),t&&(t.addClass("popout-toolbar"),this._handlers.push(this.baseNode.one(".tool-icon").on("click",u(t))),a(t,n.get(r)!=="false"))}var t=!!NeoConfig.isRTL,n=e.mail.persist.MetaData,r="neo.pref.rteformat.popout",i=t?"padding-right":"padding-left",s=t?"right":"left",o=t?-1:1;e.mix(f.prototype,{destroy:function(){this._handlers.map(function(e){e.detach()})}}),e.namespace("mail.ui").FormatPopout=f},"1.0.0",{requires:["mail-persist-meta-data"]});
YUI.add("mail-ui-rte-formatter-v3",function(e){function p(n){var r=this;n=n||{},h=s.enabled("rtePopoutToolbar"),p.superclass.constructor.call(r,n),h?r.formatTmpl=n.formatTmpl||t._shared_module_rte_well_content_format_pop_out:r.formatTmpl=n.formatTmpl||t._shared_module_rte_well_content_format_fresh,r.baseNode=null,r.editor=n.editor,r.globalPathImage=n.globalPathImage||null,r.fontColorMenu=null,r.fontSizeMenu=null,r.fontNameMenu=null,r.selectedFCValue="#000000",r.selectedFC=null,r.selectedFBValue="transparent",r.selectedFB=null,r.selectedFSIndex=-1,r.selectedFS=null,r.selectedFNIndex=-1,r.selectedFN=null,r.formatButtons=null,r.fontFamilyOptions=null,r.emotionMenu=null,r.textIndentation=null,r.textAlignment=null,r.textLists=null,r.formatters=n.formatters||{spellCheckEnabled:function(){return a?o(r.formatTmpl.spellCheckEnabled,{},r.formatters,null,strings,t):""},is_rtl:function(){var e;return u?(e=strings.str_tog_loadRTLCss?r.formatTmpl.is_rtl:r.formatTmpl.is_rtl_else,o(e,{},r.formatters,null,strings,t)):""},bidi:function(){return u?o(r.formatTmpl.bidi,{},r.formatters,null,strings,t):""}},r.handles=[],u=n.isBidi,a=n.isSpellCheckEnabled,h&&(r.formatPopout=new e.mail.ui.FormatPopout(r))}function d(e,n,r){var i=this,s;i.baseNode=e;if(!e.one("div.format-pane")){var u=o(i.formatTmpl.base,null,i.formatters,null,strings,t);n?r.insert(u,n):i.baseNode.appendChild(u)}s=e.one("div.format-pane"),i.formatButtons=s.all('span[role="button"]'),i.fontFamilyOptions=s.all("span.showFontStyle select option")}function v(){var t=this,n,r=["bold","italic","underline"],i,s=t.handles,o=t.baseNode.one("div.attachments-well");o&&o.addClass(l),i=t.baseNode.one("div.format-pane"),n=i.all("select"),s.push(e.on("change",function(e){t._invokeAction(e.currentTarget.get("parentNode"),e.currentTarget.get("value"))},n));var u=i.all('span[role="button"]');s.push(e.on("mousedown",function(n){var r=n.currentTarget,i=r.getAttribute("data-action"),s="cmps_wl_";i==="menu"?s+=r.get("id"):s+=i,e.fire("mt:click",{action:s,append:{t1:"cmpsTb"}}),n.preventDefault(),t._invokeAction(n.currentTarget,"")},u)),u.each(function(e){var t,n=r.length,i=e.getAttribute("data-action");if(i)for(t=0;t<n;t++)r[t]===i&&e.addClass("btnpress")}),t.editor.on("nodeChange",function(e){t.updateRTToolbar(e)}),t.editor.on("updateIsRichToolbar",function(){t._switchEditMode(t.editor.isRich)})}function m(t,n,r){var i=this,s;e.use("editor-lists",function(){s=t.getAttribute("data-action");if(!s)return;s!=="color"&&s!=="hilitecolor"&&(s==="menu"?i._showMenus(t):(s&&s==="bidi"&&(r||(n=t.getAttribute("value"))),i._invokeDataAction(s,n)))})}function g(t,n){var r=this,i=c[t],s,o,u;i&&(t=i);if(t==="notyet")return;if(t==="forecolor")r.selectedFCValue=n;else if(t==="backcolor")r.selectedFBValue=n;else if(t==="fontname")r.selectedFNIndex=n;else if(t==="fontsize")r.selectedFSIndex=n;else{if(t==="emoticon"){e.later(10,r,function(){u=n.indexOf("*"),s=n.slice(0,u),s=s.replace(/emoticon_(\d+)/,r.globalPathImage+"/emoticons/emo$1.gif"),o=n.slice(u),o=o.replace(/"/,"&quot;").replace(/</,"&lt").replace(/>/,"&gt;").replace(/&/,"&amp;"),n='<img src="'+s+'" alt="'+o+'" title="'+o+'">',t="insertandfocus",r.editor.invokeCommand(t,n),r.fire("formatter:action",{act:t,val:n})},null,null);return}e.UA.gecko>0&&t==="createlink"&&(r.fontNameSizeMenu&&r.fontNameSizeMenu.hide(),r.fontColorMenu&&r.fontColorMenu.hide(),r.textIndentation&&r.textIndentation.hide(),r.textAlignment&&r.textAlignment.hide(),r.textLists&&r.textLists.hide(),r.emotionMenu&&r.emotionMenu.hide())}r.editor.invokeCommand(t,n),r.fire("formatter:action",{act:t,val:n})}function y(n){var r=this,i,s,u,a,f,l,c,h,p,d,v,m,g=!1,y=null;f=n.get("id");if(n.menu){f==="btn-fontnamesize"&&(r.selectFontNameInMenu(r.fontNameMenu,r.selectedFNIndex),r.selectFontSizeInMenu(r.fontSizeMenu,r.selectedFSIndex)),f==="btn-forecolor"&&r.selectFontColorInMenu(r.fontColorMenu,"both");return}switch(f){case"btn-text-align":y={x:-2,menuUpY:0,menuDownY:0},i=t._shared_module_offscreen_bin_compose_menu_text_align.base;break;case"btn-indent":y={x:-2,menuUpY:0,menuDownY:0},i=t._shared_module_offscreen_bin_compose_menu_indent.base;break;case"btn-fontnamesize":m=o(t._shared_module_rte_well_content_fontnamesize_fresh.base,null,{intl_fonts:function(){function n(e,n){var r=t._shared_module_rte_well_content_fontnamesize_fresh;return o(r.intl_fonts,{},{font_value:function(){return e},font_name:function(){return n}},null,strings,t)}var r="";if(strings.str_cfg_intl_fonts){var i=e.JSON.parse(strings.str_cfg_intl_fonts);e.Array.each(i,function(e){r+=n(e.value,e.name)})}return r}},null,strings);break;case"btn-insertunordered":y={x:-2,menuUpY:0,menuDownY:0},i=t._shared_module_offscreen_bin_compose_menu_list.base;break;case"emoticon":i=t._shared_module_rte_well_content_emoticons_fresh.base;break;case"btn-forecolor":case"btn-backcolor":c=[["000000","808080","ffffff"],["9d1811","cd232c","d36a53"],["a46016","dd902f","e4ac64"],["ac9e19","fdef2b","fdf869"],["5b8828","8fca40","add773"],["4c76a2","70aced","7dbef1"],["440062","652191","845aa7"],["9c005c","cb008e","d264aa"]],h=c[0].length,p=c.length,i=["<div id='menu-color-picker' class='optionMenu colorPickerMenu'>"],s=["<div class='groupie'><span class='swatchTitle'>{{groupie_title}}</span>"];for(d=0;d<p;d++){s.push("<ul data-action='{{swatchaction}}'>");for(v=0;v<h;v++)u=c[d][v],u==="ffffff"?a=";' class='white' ":u==="000000"?a=";' class='black' ":a=";' ",s.push("<li style='background-color:#",u,a,"data-value='#",u,"'><a href='#'></a></li>");s.push("</ul>")}s.push("</div>"),s=s.join(""),i.push(o(s,{swatchaction:"forecolor",groupie_title:strings.str_rte_forecolor_title},null,null,strings)),s=s.replace("<li style='background-color:#ffffff;' class='white' data-value='#ffffff'>","<li style='background-color:transparent;' title='{{str_rte_no_color}}' class='transparent' data-value='transparent'><a class='icon icon-none'></a>"),i.push(o(s,{swatchaction:"backcolor",groupie_title:strings.str_rte_backcolor_title},null,null,strings)),i.push("</div>"
),i=i.join("");break;default:}i&&(m=o(i,null,null,null,strings)),m&&(l=r._showRTEMenu(m,n,g,y,function(e){r.handles.push(e.on("menuSelected",function(e){r._invokeDataAction(e.dataAction,e.dataValue)}))}))}function b(t,r,i,s,o){var u=this,a=n(t),f=a.get("id"),l=["comms-ui-menu-base"];e.one("body").appendChild(a);switch(f){case"menu-color-picker":u.fontColorMenu=a;break;case"menu-fontnamesize":u.fontNameSizeMenu=a,u.fontSizeMenu=a.one("#menu-fontsize"),u.fontNameMenu=a.one("#menu-fontname");break;case"menu-emoticon":l.push("emoticon_css"),u.emotionMenu=a;break;case"menu-list":u.textLists=a;break;case"menu-indent":u.textIndentation=a;break;case"menu-text-align":u.textAlignment=a;break;default:}return e.use(l,function(e){function t(e){switch(e.keyCode){case 13:case 32:e.currentTarget.simulate("mousedown");break;default:}}r.plug(e.Plugin.Menu,{menu:a,overlap:i,offset:s||null,dontFocus:!0}),r.get("id")==="btn-forecolor"&&u.selectFontColorInMenu(u.fontColorMenu,null,null),f==="menu-fontnamesize"&&(u.selectFontSizeInMenu(u.fontSizeMenu,u.selectedFSIndex),u.selectFontNameInMenu(u.fontNameMenu,u.selectedFNIndex)),u.handles.push(a.on("menu:state",function(t){t.state==="show"?(e.fire("ToolTips:hideTooltips"),r.addClass("pressed")):t.state==="hide"&&r.removeClass("pressed")})),r.menu.show(),u.handles.push(a.delegate("keydown",t,"li")),u.handles.push(a.delegate("mousedown",function(e){e.halt();var t=e.target,n=e.currentTarget,i=t.ancestor(function(e){return e.getAttribute("data-action")},!0),s=i?i.getAttribute("data-action"):n.getAttribute("data-action")||0,o=t.ancestor(function(e){return e.getAttribute("data-value")},!0),u=o?o.getAttribute("data-value"):"";a.fire("menuSelected",{dataAction:s,dataValue:u,item:o}),r.menu&&r.menu.hide()},"li")),o(a)}),a}function w(e,t,n){var r=this,i,s,o,u;i=s=!1,t==="fore"?(i=!0,r.selectedFCValue=n):t==="back"?(s=!0,r.selectedFBValue=n==="#ffffff"?"transparent":n):(i=s=!0,r.selectedFCValue=r.selectedFCValue||"#000000",r.selectedFBValue=r.selectedFBValue||"transparent"),e&&(i&&r.selectedFC&&r.selectedFC.removeClass("icon").removeClass("icon-checkmark"),s&&r.selectedFB&&r.selectedFB.removeClass("icon").removeClass("icon-checkmark"),o=e.all("div.groupie"),i&&(u=o.item(0).all("li"),r.selectedFC=null,u.each(function(e){e.getAttribute("data-value").toLowerCase().indexOf(r.selectedFCValue.toLowerCase())===0&&(r.selectedFC=e.one("a"))}),r.selectedFC&&r.selectedFC.addClass("icon").addClass("icon-checkmark")),s&&(u=o.item(1).all("li"),r.selectedFB=null,u.each(function(e){e.getAttribute("data-value").toLowerCase().indexOf(r.selectedFBValue.toLowerCase())===0&&(r.selectedFB=e.one("a:not(.icon-none)"))}),r.selectedFB&&r.selectedFB.addClass("icon").addClass("icon-checkmark")))}function E(e,t){var n=this,r,i,s;e&&(n.selectedFN!==null&&(n.selectedFN.removeClass("checked"),n.selectedFN.one("i.icon").removeClass("icon-checkmark")),t||(s=n.editor.getDefaultFontInfo(!1),t=s.fontFamily||""),r=e.all("li[data-value]"),r.each(function(e){i=e.getAttribute("data-value"),i.toLowerCase().indexOf(t.toLowerCase())>=0&&(n.selectedFN=e)}),n.selectedFN&&(n.selectedFN.addClass("checked"),n.selectedFN.one("i.icon").addClass("icon-checkmark")))}function S(e,t){var n=this,r;t=t||"",e&&(n.selectedFS!==null&&(n.selectedFS.removeClass("checked"),n.selectedFS.one("i.icon").removeClass("icon-checkmark")),isNaN(t)&&(r=n.editor.getDefaultFontInfo(!1),t=r.fontSize||""),n.selectedFS=e.one('li[data-value="'+t+'"]'),n.selectedFS&&(n.selectedFS.addClass("checked"),n.selectedFS.one("i.icon").addClass("icon-checkmark")))}function x(e){var t=this;t.baseNode.one("div.format-pane").all('span[role="button"]').each(function(t){t.hasClass("last")?e?t.get("id")==="switchtext-plain"?t.addClass("hidden"):t.removeClass("hidden"):t.get("id")==="switchtext-plain"?t.removeClass("hidden"):t.addClass("hidden"):t.setStyle("display",e?"":"none")}),t.baseNode.one(".format-tool")&&t.baseNode.one(".format-tool").setStyle("display",e?"":"none")}function T(e){if(typeof e=="number"){e=e.toString(16);while(e.length<6)e="0"+e;e=e.substr(4,2)+e.substr(2,2)+e.substr(0,2),e="#"+e}if(e.indexOf("rgb")>-1){var t=e.split("(")[1].split(")")[0];t=t.split(",");var n=t.map(function(e){return e=parseInt(e,10).toString(16),e.length===1?"0"+e:e});e="#"+n.join("")}return e.length===4?e[0]+e[1]+e[1]+e[2]+e[2]+e[3]+e[3]:e}function N(t){if(!this.editor.get("isRich"))return;var n=this,r,i,s,o,u,a,f,l,c=e.one(".icon-bold"),h=e.one(".icon-italic"),p=e.one(".icon-underline");try{i=document.queryCommandState("bold"),s=document.queryCommandState("italic"),o=document.queryCommandState("underline"),u=document.queryCommandValue("fontName"),a=document.queryCommandValue("foreColor"),f=document.queryCommandValue("backColor"),l=""+document.queryCommandValue("fontSize")}catch(d){u=a=f=l=""}n.formatButtons.removeClass("pressed"),c&&i&&c.addClass("pressed"),h&&s&&h.addClass("pressed"),p&&o&&p.addClass("pressed");if(a||a===0)n.selectedFCValue=T(a),n.selectFontColorInMenu(n.fontColorMenu,"fore",n.selectedFCValue);n.selectedFBValue=f?T(f):"transparent",n.selectFontColorInMenu(n.fontColorMenu,"back",n.selectedFBValue),u&&(n.selectedFNIndex=u.replace(/'/g,""),n.selectFontNameInMenu(n.fontNameMenu,n.selectedFNIndex)),l.indexOf("pt")!==-1?(r=l.replace("pt",""),n.selectedFSIndex=n._fontSizeMatch(r),n.selectFontSizeInMenu(n.fontSizeMenu,n.selectedFSIndex)):(r=parseInt(l.replace("px",""),10),isNaN(r)?e.UA.webkit&&(r=n._fontSizeMatchWebkit(t.fontSize),isNaN(r)||(n.selectedFSIndex=r-1),n.selectFontSizeInMenu(n.fontSizeMenu,n.selectedFSIndex)):(n.selectedFSIndex=n._fontSizeMatch(r),n.selectFontSizeInMenu(n.fontSizeMenu,n.selectedFSIndex)))}function C(e){var t=1e4,n,r=e,i,s=f.length;if(r>7){for(i=0;i<s;i++)n=Math.abs(e-f[i]),n<t&&(t=n,r=i);r++}return r}function k(e){switch(e){case"-webkit-xxx-large":return 7;case"xx-large":return 6;case"x-large":return 5;case"large":return 4;case"medium":return 3;case"small":return 2;case"x-small":return 1}return e}function L(){e.each(this.handles,function(e
){e.detach()}),this.formatPopout&&this.formatPopout.destroy()}var t=e.ui.Templates,n=e.Node.create,r=e.common,i=r.Utils,s=i.features,o=i.substitute,u,a,f=[10,13,16,0,24,32,48],l="hidden",c={"align-l":"justifyleft","align-c":"justifycenter","align-r":"justifyright",inserthrule:"inserthorizontalrule",insertlink:"createlink",setfontstyle:"fontname",setfontsize:"fontsize",insertnumberedlist:"insertorderedlist",color:"notyet",hilitecolor:"notyet"},h;e.extend(p,e.mail.ui.BaseWidget),e.namespace("mail.ui").RTEFormatter=p,e.mix(e.mail.ui.RTEFormatter.prototype,{NAME:"RTEFormatter",renderUI:d,bindUI:v,_invokeAction:m,_invokeDataAction:g,_showMenus:y,_showRTEMenu:b,selectFontColorInMenu:w,selectFontSizeInMenu:S,selectFontNameInMenu:E,_switchEditMode:x,updateRTToolbar:N,_fontSizeMatch:C,_fontSizeMatchWebkit:k,destroy:L})},"1.0.0",{requires:["mail-ui-format-popout","_shared_module_rte_well_content_format_pop_out","mail-common-utils-features"]});
YUI.add("mail-ui-authorview-v3",function(e){function u(){var t=this;t.closeChgHandler=t.on("closeChange",t.handleCloseChange,t),t.activeChangeHandler=t.on("activeChange",t.handleActiveChange),NeoConfig.hasConvView?t.msgsRemoveHandler=e.on("ds:conv:remove",t.handleConvRemove,t):t.msgsRemoveHandler=e.on("ds:msg:remove",t.handleMsgRemove,t)}function a(e){var t=this;e.newVal?(t.view.set("active",!0),t.view.showComposeView(e)):(t.view.set("active",!1),t.view.hideComposeView(e))}function f(e){var t=this;e.newVal&&t.view.closeCompose()}function l(e,t,n,r,i){var s,o=t||[],u;if(i&&i.reason==="savedraft")return;if(e!=="Draft")return;for(s=0;s<o.length;s++)u=o[s],this.view.getDraftMID()===u.mid&&this.set("close",1)}function c(e,t){var n,r=t||[],i;if(e!=="Draft")return;for(n=0;n<r.length;n++)i=r[n],i.totalMsgs===1&&this.view.getDraftMID()===i.recentmid&&this.set("close",1)}function h(e){var t="str_comp_nosubject",n=e||strings[t];this.set("title",n)}function p(e){this.set("direction",e)}function d(e){var t=this,n=t.localCharCodes.length,r;for(r=0;r<n;r++)if(e===t.localCharCodes[r])return!0;return!1}function v(){var e=this;if(e.view)return[e.view]}function m(t){var n=this,r=t.keyCode;r=n.keyCodesL10N[r]||r;switch(r){case 220:if(!t.altKey&&(t.metaKey||t.ctrlKey))return n.set("close",1),!0;break;case 27:return n.controller&&(n.controller.closeSrc="escKey"),(!e.ACWidgetInst.handleEscape||!e.ACWidgetInst.handleEscape())&&n.set("close",1),!0}return e.UA.ie&&n.view.onLocalKeyDown&&!n.view.onLocalKeyDown(t)?!1:n.view&&n.view.onKeyDown?n.view.onKeyDown(t):null}function g(e){return this.view.onFocus(e)}function y(){return this.view.isDirty()}function b(){return!this.isDirty()&&!this.view.hasContent()}function w(e){var t=this;return t.view.matchOrigin?t.view.matchOrigin(e):!1}function E(t,n){var r=this;return r.view=r.createComposeController(t,n).view,r.view.handles.push(r.view.on("renderComplete",function(){r.set("rootNode",r.get("parentNode").one("div.compose")),t&&t.postRender&&t.postRender(r,t),s.enabled("richcompose")&&(!r.view.get("isQuickReply")||s.enabled("richcomposeInQuickReply"))&&e.use("mail-ui-richcompose-view",function(e){r.richcompose||(r.richcompose=new e.mail.Views.RichCompose(r,r.view))})})),t&&t.oMsg&&t.oMsg.header&&(t.oMsg.header.subject=e.mail.Controller.ReplyProcessor.seedSubject(t)),r.view}function S(t,n){var r=this,s=null,o;return i({m:"start creating ComposeController"}),o={keydownHandler:e.bind(r.onKeyDown,r)},s=new e.mail.Controller.ComposeController(r.get("parentNode"),r.getEventBindings(),t,o,n),s.handles=[],r.controller=s,s}function x(e){e.action=e.type,this.fire("darlaEvent",e)}function T(){var e=this;e.parent=e.get("parentNode"),e.controller.setParent(e.parent),e.controller.bindComposeView()}function N(t){var n=this,r=e.one(t);n.set("parentNode",r),n.set("rootNode",r.one("div.compose"));return}function C(){return}function k(e){var t=this;t.controller.composeViewTainer&&this.controller.composeViewTainer.one(".composeshim")[e?"removeClass":"addClass"]("hidden"),e?t.tab&&t.tab.elTab.addClass("sending"):t.tab&&t.tab.elTab.removeClass("sending")}function L(){var e=this,t=e.view.getSubjectInfo();t.subjectVal?(e.updateTabTitle(n(r(t.subjectVal))),t.subjectDir&&e.updateTabDirection(t.subjectDir)):(e.updateTabTitle(e.view.title),t.subjectDir&&e.updateTabDirection(""))}function A(){var e=this;e.msgsRemoveHandler&&e.msgsRemoveHandler.detach(),e.closeChgHandler&&e.closeChgHandler.detach(),e.toolBarHandler&&e.toolBarHandler.detach(),e.activeChangeHandler&&e.activeChangeHandler.detach(),o.superclass.ondestroy.call(e,arguments)}function O(t){var i=this;i.updateTabTitle(n(r(t.subject))),NeoConfig.bidi&&i.updateTabDirection(e.Intl.detectDirection(t.subject))}function M(e){return this.view.canClose(e)}function _(e){var t=this;this.view.fire("composeWillClose"),e.forceClose&&t.set("forceClose",1),t.set("close",1)}function D(e){this.set("focusNode",e.focusNode)}function P(){this.tab!==e.mail.Tabs.getActiveTab()&&e.mail.Tabs.switchToTab(this.tab)}function H(t){var n=this;n.tab!==e.mail.Tabs.getActiveTab()?e.mail.Tabs.switchToTab(n.tab,t.sdcbk()):t.sdcbk()}function B(e){var t=this;e.sending?t.tab&&t.tab.elTab.addClass("sending"):(t.tab&&t.tab.elTab.removeClass("sending"),e.title?t.updateTabTitle(e.title):t.setSubjectAsTitle())}function j(){var t=this,n={updateSubject:e.bind(t.setSubjectAsTitle,t),closeAction:e.bind(t.closeAction,t),qrCancel:e.bind(t.closeAction,t),replyheaderLoad:e.bind(t.replyheaderLoad,t),setFocusNode:e.bind(t.setFocusNode,t),showSaveDialog:e.bind(t.showSaveDialog,t),showCompose:e.bind(t.showCompose,t),addChild:e.bind(function(e){this.addChild(e.view)},t),removeChild:e.bind(function(e){this.removeChild(e.view)},t),updateTitle:e.bind(t.updateTitle,t),switchToTab:e.bind(t.switchToTab,t),darlaEvent:e.bind(t.fireDarlaEvent,t)};return n}var t=e.common.Utils,n=t.escapeHtml,r=t.unescapeHtml,i=t.log,s=t.features,o=function(t){var n=this,r;n.keyCodes=[],n.keyCodesL10N={},n.parent=null,n.view=null,n.controller=null,n.localCharCodes=[8,77,78,73,84],n.composeActive=!0,n.type="author",n.widgetType="compose",n.keyCodesL10N[strings.str_cfg_sc_keycode_save_as_draft]=83,n.keyCodesL10N[strings.str_cfg_sc_keycode_close_tab]=220;for(r in n.keyCodesL10N)n.keyCodes.push(r);o.superclass.constructor.call(n,t),n.bind(),n.set("charCodes","13,13+ctrl,13+meta,27,188+ctrl,190+ctrl,"+n.keyCodes.join("+ctrl,")+"+ctrl,"+n.keyCodes.join("+meta,")+"+meta"),e.UA.ie&&n.set("localCharCodes",n.localCharCodes.join()),n.updateTabTitle(n.get("title"))};e.extend(o,e.mail.ui.BaseWidget),e.mix(o.prototype,{NAME:"AuthorView",ondestroy:A,onKeyDown:m,onFocus:g,bind:u,bindUI:C,render:N,initCompose:E,createComposeController:S,bindComposeView:T,isLocalCharCode:d,isDirty:y,isClean:b,matchOrigin:w,updateTabTitle:h,updateTabDirection:p,handleCloseChange:f,showComposeShim:k,getComposeWidgets:v,setSubjectAsTitle:L,setFocusNode:D,showSaveDialog:H,_canClose:M,closeAction:_,handleActiveChange:a,replyheaderLoad:O,getEventBindings:j,updateTitle
:B,switchToTab:P,handleConvRemove:c,handleMsgRemove:l,fireDarlaEvent:x},!0),e.namespace("mail.ui"),e.mail.ui.AuthorViewConv=o},"1.0.0",{requires:["mail-controller-base","mail-controller-reply-processor","_shared_module_compose_title","mail-common-utils-features","mail-controller-compose-v3"]});
